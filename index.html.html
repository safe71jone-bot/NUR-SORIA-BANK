<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï">
    <meta name="theme-color" content="#0d2e1a">
    <title>‡¶®‡ßÇ‡¶∞ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</title>
    <style>
        /* Offline Icon System - Emoji Fallback */
        .fas, .far, .fab, .fal, .fad {
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif !important;
            font-style: normal;
            font-weight: normal;
            display: inline-block;
            line-height: 1;
        }
        .fa-mosque::before { content: "üïå"; }
        .fa-home::before { content: "üè†"; }
        .fa-tachometer-alt::before { content: "üìä"; }
        .fa-piggy-bank::before { content: "üí∞"; }
        .fa-handshake::before { content: "ü§ù"; }
        .fa-chart-line::before { content: "üìà"; }
        .fa-user::before { content: "üë§"; }
        .fa-users::before { content: "üë•"; }
        .fa-user-tie::before { content: "üëî"; }
        .fa-user-plus::before { content: "üë§+"; }
        .fa-user-tag::before { content: "üè∑"; }
        .fa-sign-out-alt::before { content: "üö™"; }
        .fa-sign-in-alt::before { content: "üîê"; }
        .fa-bell::before { content: "üîî"; }
        .fa-bell-slash::before { content: "üîï"; }
        .fa-cog::before { content: "‚öôÔ∏è"; }
        .fa-search::before { content: "üîç"; }
        .fa-plus::before { content: "+"; }
        .fa-plus-circle::before { content: "‚ûï"; }
        .fa-times::before { content: "‚úï"; }
        .fa-times-circle::before { content: "‚ùå"; }
        .fa-check::before { content: "‚úì"; }
        .fa-check-circle::before { content: "‚úÖ"; }
        .fa-edit::before { content: "‚úèÔ∏è"; }
        .fa-trash::before { content: "üóëÔ∏è"; }
        .fa-save::before { content: "üíæ"; }
        .fa-download::before { content: "‚¨áÔ∏è"; }
        .fa-upload::before { content: "‚¨ÜÔ∏è"; }
        .fa-cloud-upload-alt::before { content: "‚òÅÔ∏è‚¨ÜÔ∏è"; }
        .fa-bars::before { content: "‚ò∞"; }
        .fa-key::before { content: "üîë"; }
        .fa-lock::before { content: "üîí"; }
        .fa-eye::before { content: "üëÅÔ∏è"; }
        .fa-eye-slash::before { content: "üôà"; }
        .fa-envelope::before { content: "‚úâÔ∏è"; }
        .fa-phone::before { content: "üìû"; }
        .fa-map-marker-alt::before { content: "üìç"; }
        .fa-calendar::before { content: "üìÖ"; }
        .fa-clock::before { content: "üïê"; }
        .fa-history::before { content: "‚è±Ô∏è"; }
        .fa-money-bill-wave::before { content: "üí∏"; }
        .fa-wallet::before { content: "üëõ"; }
        .fa-hand-holding-usd::before { content: "üíµ"; }
        .fa-hand-holding-heart::before { content: "ü§≤"; }
        .fa-percentage::before { content: "%"; }
        .fa-calculator::before { content: "üßÆ"; }
        .fa-chart-bar::before { content: "üìä"; }
        .fa-chart-pie::before { content: "ü•ß"; }
        .fa-exchange-alt::before { content: "‚ÜîÔ∏è"; }
        .fa-arrow-up::before { content: "‚Üë"; }
        .fa-arrow-down::before { content: "‚Üì"; }
        .fa-bolt::before { content: "‚ö°"; }
        .fa-ban::before { content: "üö´"; }
        .fa-exclamation-circle::before { content: "‚ö†Ô∏è"; }
        .fa-exclamation-triangle::before { content: "‚ö†Ô∏è"; }
        .fa-info-circle::before { content: "‚ÑπÔ∏è"; }
        .fa-comment::before { content: "üí¨"; }
        .fa-comment-dots::before { content: "üí¨"; }
        .fa-comments::before { content: "üí¨üí¨"; }
        .fa-paper-plane::before { content: "‚úàÔ∏è"; }
        .fa-headset::before { content: "üéß"; }
        .fa-store::before { content: "üè™"; }
        .fa-building::before { content: "üè¢"; }
        .fa-industry::before { content: "üè≠"; }
        .fa-book-open::before { content: "üìñ"; }
        .fa-file-alt::before { content: "üìÑ"; }
        .fa-file-contract::before { content: "üìã"; }
        .fa-list-ol::before { content: "üìã"; }
        .fa-database::before { content: "üóÑÔ∏è"; }
        .fa-gavel::before { content: "‚öñÔ∏è"; }
        .fa-shield-alt::before { content: "üõ°Ô∏è"; }
        .fa-id-card::before { content: "ü™™"; }
        .fa-car::before { content: "üöó"; }
        .fa-hands-helping::before { content: "ü§ù"; }
        .fa-hand-holding::before { content: "ü§≤"; }
        .fa-cloud-upload-alt::before { content: "‚òÅÔ∏è‚¨ÜÔ∏è"; }
        .fa-cloud-download-alt::before { content: "‚òÅÔ∏è‚¨áÔ∏è"; }
        .fa-sync-alt::before { content: "üîÑ"; }
        .fa-filter::before { content: "üîç"; }
        .fa-sliders-h::before { content: "‚öôÔ∏è"; }
        .fa-print::before { content: "üñ®Ô∏è"; }
        .fa-share-alt::before { content: "üì§"; }
        .fa-credit-card::before { content: "üí≥"; }
        .fa-university::before { content: "üèõÔ∏è"; }
        .fa-landmark::before { content: "üèõÔ∏è"; }
        
        /* Regular CSS */
        :root {
            --primary: #1a472a;
            --primary-dark: #0d2e1a;
            --primary-light: #e8f5e9;
            --secondary: #d4af37;
            --secondary-dark: #b8941f;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray: #7f8c8d;
            --border: #bdc3c7;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-heavy: 0 10px 30px rgba(0,0,0,0.15);
            --radius: 10px;
            --radius-sm: 6px;
            --transition: all 0.3s ease;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI','SolaimanLipi',sans-serif; }
        body { background:linear-gradient(135deg,#f5f7fa 0%,#e4e8f0 100%); color:#2c3e50; min-height:100vh; line-height:1.6; }
        .hidden { display:none !important; }
        .flex { display:flex; } .flex-col { flex-direction:column; } .center { align-items:center; justify-content:center; }
        .between { justify-content:space-between; } .gap-10 { gap:10px; } .gap-15 { gap:15px; } .gap-20 { gap:20px; }
        .wrap { flex-wrap:wrap; } .text-center { text-align:center; } .w-100 { width:100%; }
        .mt-10 { margin-top:10px; } .mt-20 { margin-top:20px; } .mb-10 { margin-bottom:10px; } .mb-20 { margin-bottom:20px; }
        .p-20 { padding:20px; } .pointer { cursor:pointer; }
        .btn { padding:12px 24px; border:none; border-radius:var(--radius-sm); cursor:pointer; font-weight:600; transition:var(--transition); display:inline-flex; align-items:center; justify-content:center; gap:8px; font-size:0.95rem; }
        .btn-primary { background:var(--primary); color:var(--white); }
        .btn-primary:hover { background:var(--primary-dark); transform:translateY(-2px); box-shadow:0 5px 15px rgba(26,71,42,0.3); }
        .btn-secondary { background:var(--secondary); color:#333; }
        .btn-secondary:hover { background:var(--secondary-dark); transform:translateY(-2px); }
        .btn-outline { background:transparent; border:2px solid var(--primary); color:var(--primary); }
        .btn-outline:hover { background:var(--primary); color:var(--white); }
        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-info { background:var(--info); color:white; }
        .btn-sm { padding:8px 16px; font-size:0.85rem; }
        .btn-lg { padding:16px 32px; font-size:1.1rem; }
        .flex-1 { flex:1; }
        .card { background:var(--white); padding:24px; border-radius:var(--radius); box-shadow:var(--shadow); transition:var(--transition); }
        .card:hover { transform:translateY(-5px); box-shadow:var(--shadow-heavy); }

        /* AUTH */
        #auth-section { min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%); padding:20px; position:relative; overflow:hidden; }
        #auth-section::before { content:''; position:absolute; width:400px; height:400px; background:rgba(255,255,255,0.03); border-radius:50%; top:-100px; right:-100px; }
        #auth-section::after { content:''; position:absolute; width:300px; height:300px; background:rgba(255,255,255,0.03); border-radius:50%; bottom:-80px; left:-80px; }
        .auth-container { width:100%; max-width:480px; position:relative; z-index:1; }
        .auth-box { background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow-heavy); overflow:hidden; }
        .auth-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:var(--white); padding:30px; text-align:center; }
        .auth-logo { font-size:3rem; margin-bottom:10px; }
        .auth-body { padding:30px; }
        .form-group { margin-bottom:18px; }
        .form-group label { display:block; margin-bottom:7px; font-weight:600; color:var(--dark); font-size:0.93rem; }
        .form-control { width:100%; padding:12px 15px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.97rem; transition:var(--transition); }
        .form-control:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(26,71,42,0.1); }
        .form-row { display:flex; gap:15px; }
        .auth-footer { text-align:center; padding:18px; border-top:1px solid var(--border); background:var(--light); }
        .auth-link { color:var(--primary); cursor:pointer; font-weight:600; text-decoration:underline; }

        /* LOADING OVERLAY */
        #loading-overlay { position:fixed; inset:0; background:var(--primary-dark); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        #loading-overlay .logo { font-size:4rem; color:var(--secondary); margin-bottom:20px; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { transform:scale(1); opacity:1; } 50% { transform:scale(1.1); opacity:0.8; } }
        .loading-bar { width:200px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; overflow:hidden; margin-top:20px; }
        .loading-bar-fill { height:100%; background:var(--secondary); border-radius:2px; animation:loadBar 1.8s ease forwards; }
        @keyframes loadBar { 0% { width:0%; } 100% { width:100%; } }

        /* DASHBOARD */
        .app-container { display:flex; min-height:100vh; }
        .sidebar { width:280px; background:var(--white); border-right:1px solid var(--border); display:flex; flex-direction:column; transition:var(--transition); box-shadow:2px 0 10px rgba(0,0,0,0.05); z-index:1000; }
        .sidebar-header { padding:25px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:var(--white); text-align:center; }
        .sidebar-logo { font-size:2.2rem; margin-bottom:8px; }
        .sidebar-menu { flex:1; padding:15px 0; overflow-y:auto; }
        .menu-section { padding:5px 25px 3px; font-size:0.75rem; color:var(--gray); text-transform:uppercase; letter-spacing:1px; margin-top:10px; }
        .menu-item { padding:12px 25px; cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--dark); transition:var(--transition); border-left:4px solid transparent; margin:2px 0; position:relative; }
        .menu-item:hover, .menu-item.active { background:var(--primary-light); color:var(--primary); border-left:4px solid var(--primary); }
        .menu-item i { font-size:1rem; width:22px; text-align:center; }
        .badge { background:var(--danger); color:white; padding:2px 7px; border-radius:10px; font-size:0.72rem; margin-left:auto; min-width:18px; text-align:center; }
        .sidebar-footer { padding:18px; border-top:1px solid var(--border); background:var(--light); }
        .user-info { display:flex; align-items:center; gap:12px; }
        .user-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.1rem; flex-shrink:0; }
        .main-content { flex:1; overflow-y:auto; background:#f8f9fa; }
        .top-bar { background:var(--white); padding:16px 28px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:sticky; top:0; z-index:900; }
        .page-title { font-size:1.3rem; font-weight:700; color:var(--primary-dark); display:flex; align-items:center; gap:10px; }
        .top-actions { display:flex; align-items:center; gap:18px; position:relative; }
        .notification-btn { position:relative; cursor:pointer; font-size:1.3rem; color:var(--gray); padding:8px; border-radius:50%; transition:var(--transition); }
        .notification-btn:hover { background:var(--primary-light); color:var(--primary); }
        .notification-badge { position:absolute; top:0; right:0; background:var(--danger); color:white; font-size:0.68rem; padding:2px 5px; border-radius:50%; min-width:17px; text-align:center; }
        .sync-indicator { font-size:0.78rem; color:var(--success); display:flex; align-items:center; gap:5px; transition:var(--transition); }

        /* STATS */
        .dashboard-content { padding:25px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; margin-bottom:28px; }
        .stat-card { background:var(--white); padding:22px; border-radius:var(--radius); box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; border-left:5px solid var(--primary); transition:var(--transition); }
        .stat-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-heavy); }
        .stat-card.success { border-left-color:var(--success); }
        .stat-card.warning { border-left-color:var(--warning); }
        .stat-card.info { border-left-color:var(--info); }
        .stat-card.secondary { border-left-color:var(--secondary); }
        .stat-info h3 { font-size:1.8rem; color:var(--primary); margin-bottom:4px; }
        .stat-info p { color:var(--gray); font-size:0.88rem; }
        .stat-icon { font-size:2.3rem; color:var(--primary); opacity:0.6; }

        /* SERVICES */
        .services-container { padding:25px; }
        .services-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(290px,1fr)); gap:22px; margin-top:20px; }
        .service-card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transition:var(--transition); border-top:4px solid var(--secondary); display:flex; flex-direction:column; }
        .service-card:hover { transform:translateY(-7px); box-shadow:var(--shadow-heavy); }
        .service-icon { padding:22px; text-align:center; font-size:2.8rem; color:var(--secondary); background:linear-gradient(135deg,#fff9e6,#fff3cc); }
        .service-body { padding:22px; flex:1; display:flex; flex-direction:column; }
        .service-title { font-size:1.2rem; font-weight:700; color:var(--primary-dark); margin-bottom:8px; }
        .service-desc { color:var(--gray); margin-bottom:14px; flex:1; line-height:1.6; font-size:0.93rem; }
        .service-features { margin-bottom:18px; }
        .feature-item { display:flex; align-items:center; gap:7px; margin-bottom:7px; font-size:0.88rem; }
        .feature-item i { color:var(--success); font-size:0.8rem; }
        .service-meta { display:flex; justify-content:space-between; background:var(--primary-light); border-radius:var(--radius-sm); padding:10px 14px; margin-bottom:14px; font-size:0.85rem; }

        /* TABLE */
        .table-container { padding:25px; }
        .table-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; flex-wrap:wrap; gap:12px; }
        .table-responsive { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); margin-top:15px; overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:600px; }
        th,td { padding:14px 18px; text-align:left; border-bottom:1px solid var(--border); }
        th { background:var(--primary-light); color:var(--primary); font-weight:700; font-size:0.92rem; white-space:nowrap; }
        tr:hover { background:#f9f9f9; }
        .status-badge { padding:5px 11px; border-radius:20px; font-size:0.82rem; font-weight:600; display:inline-block; white-space:nowrap; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-approved { background:#d4edda; color:#155724; }
        .status-rejected { background:#f8d7da; color:#721c24; }
        .status-processing { background:#cce5ff; color:#004085; }
        .status-completed { background:#d1ecf1; color:#0c5460; }
        .action-buttons { display:flex; gap:7px; flex-wrap:wrap; }

        /* CHAT */
        .chat-container { display:flex; height:calc(100vh - 130px); padding:20px; gap:18px; }
        .chat-list { width:300px; background:var(--white); border-radius:var(--radius); overflow:hidden; display:flex; flex-direction:column; box-shadow:var(--shadow); }
        .chat-window { flex:1; background:var(--white); border-radius:var(--radius); display:flex; flex-direction:column; overflow:hidden; box-shadow:var(--shadow); }
        .chat-header { padding:18px 22px; border-bottom:1px solid var(--border); background:var(--primary-light); font-weight:700; color:var(--primary-dark); display:flex; align-items:center; gap:10px; }
        .chat-messages { flex:1; padding:22px; overflow-y:auto; background:#f8f9fa; display:flex; flex-direction:column; gap:14px; }
        .message { max-width:72%; padding:11px 16px; border-radius:18px; font-size:0.93rem; line-height:1.5; word-wrap:break-word; }
        .msg-sent { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:5px; }
        .msg-received { align-self:flex-start; background:var(--white); color:#333; border-bottom-left-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
        .message-time { font-size:0.73rem; opacity:0.7; margin-top:4px; text-align:right; }
        .chat-input-area { padding:18px; border-top:1px solid var(--border); background:var(--white); display:flex; gap:10px; }
        .chat-input { flex:1; padding:12px 18px; border:1px solid var(--border); border-radius:30px; outline:none; font-size:0.95rem; transition:var(--transition); }
        .chat-input:focus { border-color:var(--primary); }
        .chat-user-item { padding:14px 18px; cursor:pointer; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; transition:var(--transition); }
        .chat-user-item:hover, .chat-user-item.active { background:var(--primary-light); }

        /* MODAL */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px; }
        .modal { background:var(--white); border-radius:var(--radius); width:100%; max-width:700px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.3); animation:modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity:0; transform:translateY(-25px); } to { opacity:1; transform:translateY(0); } }
        .modal-header { padding:22px 28px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:white; z-index:1; }
        .modal-body { padding:28px; }

        /* NOTIFICATIONS */
        .notifications-panel { position:absolute; top:calc(100% + 10px); right:0; width:360px; background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow-heavy); border:1px solid var(--border); z-index:1000; display:none; }
        .notifications-panel.show { display:block; animation:fade        .notifications-list { max-height:380px; overflow-y:auto; }
        .notification-item { padding:15px 18px; border-bottom:1px solid var(--border); cursor:pointer; transition:var(--transition); display:flex; gap:12px; align-items:flex-start; }
        .notification-item:hover { background:#f9f9f9; }
        .notification-item.unread { background:#f0f7ff; }
        .notification-dot { width:8px; height:8px; border-radius:50%; background:var(--danger); margin-top:7px; flex-shrink:0; }
        .notification-content { flex:1; }
        .notification-title { font-weight:600; color:var(--dark); margin-bottom:3px; font-size:0.92rem; }
        .notification-message { font-size:0.87rem; color:var(--gray); margin-bottom:3px; }
        .notification-time { font-size:0.78rem; color:var(--gray); }

        /* SPECIAL */
        .sharia-badge { background:linear-gradient(135deg,var(--success),#27ae60); color:white; padding:4px 11px; border-radius:20px; font-size:0.78rem; font-weight:600; display:inline-flex; align-items:center; gap:5px; }
        .welcome-banner { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:28px; border-radius:var(--radius); margin-bottom:22px; display:flex; justify-content:space-between; align-items:center; position:relative; overflow:hidden; }
        .toast-container { position:fixed; bottom:20px; right:20px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .toast { background:var(--white); color:#333; padding:14px 20px; border-radius:var(--radius); box-shadow:var(--shadow-heavy); border-left:5px solid var(--primary); animation:slideInRight 0.3s ease; display:flex; align-items:center; gap:13px; max-width:340px; }
        .toast.success { border-left-color:var(--success); }
        .toast.error { border-left-color:var(--danger); }
        .toast.warning { border-left-color:var(--warning); }
        .toast.info { border-left-color:var(--info); }
        @keyframes slideInRight { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        .loading-spinner { display:inline-block; width:18px; height:18px; border:3px solid rgba(26,71,42,0.3); border-radius:50%; border-top-color:var(--primary); animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .mobile-menu-btn { display:none; font-size:1.5rem; cursor:pointer; color:var(--primary); padding:8px; border-radius:5px; }
        .mobile-menu-btn:hover { background:var(--primary-light); }

        /* PROFILE/ACCOUNT */
        .profile-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border-radius:var(--radius); padding:30px; color:white; display:flex; align-items:center; gap:25px; margin-bottom:25px; }
        .profile-avatar { width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.2); border:3px solid var(--secondary); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; }
        .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
        .info-item { background:#f8f9fa; border-radius:var(--radius-sm); padding:14px; }
        .info-label { font-size:0.82rem; color:var(--gray); margin-bottom:4px; }
        .info-value { font-weight:600; color:var(--dark); }

        /* CHARTS/REPORTS */
        .chart-bar { height:24px; border-radius:12px; background:linear-gradient(90deg,var(--primary),var(--secondary)); transition:width 1s ease; }
        .progress-bar { background:#eee; border-radius:12px; overflow:hidden; margin-bottom:8px; }

        /* FILTER BAR */
        .filter-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
        .filter-btn { padding:8px 16px; border:2px solid var(--border); background:white; border-radius:20px; cursor:pointer; font-size:0.88rem; transition:var(--transition); }
        .filter-btn:hover, .filter-btn.active { border-color:var(--primary); background:var(--primary); color:white; }

        /* TIMELINE */
        .timeline { position:relative; padding-left:25px; }
        .timeline::before { content:''; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--border); }
        .timeline-item { position:relative; margin-bottom:20px; }
        .timeline-dot { position:absolute; left:-21px; width:14px; height:14px; border-radius:50%; background:var(--primary); border:2px solid white; box-shadow:0 0 0 2px var(--primary); top:4px; }
        .timeline-dot.success { background:var(--success); box-shadow:0 0 0 2px var(--success); }
        .timeline-dot.warning { background:var(--warning); box-shadow:0 0 0 2px var(--warning); }
        .timeline-dot.danger { background:var(--danger); box-shadow:0 0 0 2px var(--danger); }
        .timeline-content { background:white; padding:14px 18px; border-radius:var(--radius-sm); box-shadow:var(--shadow); }

        /* CALCULATOR */
        .calc-result { background:linear-gradient(135deg,var(--primary-light),#e8f5e9); border-radius:var(--radius); padding:20px; margin-top:20px; }

        /* RESPONSIVE */
        @media (max-width:768px) {
            .sidebar { position:fixed; left:-280px; height:100%; box-shadow:2px 0 15px rgba(0,0,0,0.2); }
            .sidebar.open { left:0; }
            .mobile-menu-btn { display:block; }
            .chat-container { flex-direction:column; height:auto; }
            .chat-list { width:100%; height:250px; }
            .chat-window { height:450px; }
            .services-grid { grid-template-columns:1fr; }
            .stats-grid { grid-template-columns:1fr; }
            .form-row { flex-direction:column; gap:0; }
            .welcome-banner { flex-direction:column; text-align:center; gap:18px; }
            .info-grid { grid-template-columns:1fr; }
            .table-header { flex-direction:column; align-items:flex-start; }
        }
        
        /* JSONBin Status */
        .jsonbin-status { display:flex; align-items:center; gap:8px; font-size:0.8rem; padding:5px 12px; border-radius:20px; background:var(--primary-light); color:var(--primary); cursor:pointer; }
        .jsonbin-status.online { background:#d4edda; color:#155724; }
        .jsonbin-status.offline { background:#f8d7da; color:#721c24; }
        .jsonbin-status.syncing { background:#fff3cd; color:#856404; }
    </style>
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<!-- LOADING -->
<div id="loading-overlay">
    <div class="logo"><i class="fas fa-mosque"></i></div>
    <h2 style="color:white;margin-bottom:5px;">‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ‡¶π‡ßç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶É</h2>
    <p style="color:rgba(255,255,255,0.6);font-size:0.9rem;">‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶¶ ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
    <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- AUTH -->
<section id="auth-section" class="hidden">
    <div class="auth-container">
        <!-- LOGIN -->
        <div id="login-form" class="auth-box">
            <div class="auth-header">
                <div class="auth-logo"><i class="fas fa-mosque"></i></div>
                <h2>‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ‡¶π‡ßç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶É</h2>
                <p>‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶¶ ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
            </div>
            <div class="auth-body">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø / NID / ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                    <input type="text" id="login-userid" class="form-control" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                    <div style="position:relative;">
                        <input type="password" id="login-password" class="form-control" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" style="padding-right:45px;">
                        <i class="fas fa-eye" onclick="togglePasswordVisibility('login-password',this)" style="position:absolute;right:14px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--gray);"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-shield-alt"></i> ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶°</label>
                    <div class="form-row">
                        <input type="text" id="login-captcha" class="form-control" placeholder="‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                        <div id="captcha-code" onclick="generateCaptcha()" class="form-control" style="background:#f8f9fa;font-family:monospace;font-size:1.3rem;letter-spacing:4px;text-align:center;cursor:pointer;color:var(--primary-dark);font-weight:bold;">A3B7</div>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt"></i> ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <div style="text-align:center;margin-top:15px;">
                    <span class="auth-link" onclick="showForgotPassword()">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span>
                </div>
            </div>
            <div class="auth-footer">
                <p>‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <span class="auth-link" onclick="showRegisterForm()">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
            </div>
        </div>

        <!-- REGISTER -->
        <div id="register-form" class="auth-box hidden">
            <div class="auth-header">
                <div class="auth-logo"><i class="fas fa-user-plus"></i></div>
                <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</h2>
                <p>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
            <div class="auth-body">
                <div class="form-row">
                    <div class="form-group" style="flex:2;">
                        <label><i class="fas fa-user"></i> ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="reg-name" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label><i class="fas fa-user-tag"></i> ‡¶â‡¶™‡¶æ‡¶ß‡¶ø</label>
                        <select id="reg-title" class="form-control">
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                            <option value="‡¶ú‡¶®‡¶æ‡¶¨">‡¶ú‡¶®‡¶æ‡¶¨</option>
                            <option value="‡¶ú‡¶®‡¶æ‡¶¨‡¶æ">‡¶ú‡¶®‡¶æ‡¶¨‡¶æ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> ‡¶ú‡¶æ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º‡¶™‡¶§‡ßç‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (NID)</label>
                    <input type="text" id="reg-nid" class="form-control" placeholder="‡ßß‡ß¶ ‡¶¨‡¶æ ‡ßß‡ß≠ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                        <input type="email" id="reg-email" class="form-control" placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</label>
                        <input type="tel" id="reg-phone" class="form-control" placeholder="‡ß¶‡ßßXXXXXXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-tag"></i> ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                    <select id="reg-type" class="form-control">
                        <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        <option value="personal">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º</option>
                        <option value="business">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</option>
                        <option value="corporate">‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</option>
                        <option value="student">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                        <input type="password" id="reg-password" class="form-control" placeholder="‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" onkeyup="checkPasswordStrength(this.value)">
                        <div style="margin-top:5px;height:4px;background:#eee;border-radius:2px;overflow:hidden;">
                            <div id="password-strength-bar" style="height:100%;width:0%;background:#e74c3c;transition:width 0.3s;"></div>
                        </div>
                        <small style="color:var(--gray);font-size:0.78rem;">‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞, ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ì ‡¶¨‡¶°‡¶º ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞</small>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§</label>
                        <input type="password" id="reg-confirm-password" class="form-control" placeholder="‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reg-dob" class="form-control">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-industry"></i> ‡¶™‡ßá‡¶∂‡¶æ</label>
                        <select id="reg-occupation" class="form-control">
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                            <option value="‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø">‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø</option>
                            <option value="‡¶¨‡ßá‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø">‡¶¨‡ßá‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø</option>
                            <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ</option>
                            <option value="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</option>
                            <option value="‡¶ó‡ßÉ‡¶π‡¶ø‡¶£‡ßÄ">‡¶ó‡ßÉ‡¶π‡¶ø‡¶£‡ßÄ</option>
                            <option value="‡¶Ö‡¶¨‡¶∏‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§">‡¶Ö‡¶¨‡¶∏‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label>
                    <textarea id="reg-address" class="form-control" rows="2" placeholder="‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ"></textarea>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                    <input type="number" id="reg-income" class="form-control" placeholder="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º" min="0">
                </div>
                <div class="form-group">
                    <div style="display:flex;align-items:flex-start;gap:10px;">
                        <input type="checkbox" id="reg-terms" style="margin-top:3px;">
                        <label for="reg-terms" style="font-size:0.9rem;margin:0;">
                            ‡¶Ü‡¶Æ‡¶ø <span class="auth-link" onclick="showTermsModal()">‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</span> ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßá ‡¶ö‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§
                        </label>
                    </div>
                </div>
                <button class="btn btn-secondary w-100" onclick="handleRegister()">
                    <i class="fas fa-user-plus"></i> ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            <div class="auth-footer">
                <p>‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <span class="auth-link" onclick="showLoginForm()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
            </div>
        </div>

        <!-- FORGOT PASSWORD -->
        <div id="forgot-password-form" class="auth-box hidden">
            <div class="auth-header">
                <div class="auth-logo"><i class="fas fa-key"></i></div>
                <h2>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</h2>
                <p>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
            <div class="auth-body">
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                    <input type="text" id="reset-nid" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                    <input type="email" id="reset-email" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                    <input type="password" id="reset-new-password" class="form-control" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <input type="password" id="reset-confirm-password" class="form-control" placeholder="‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-shield-alt"></i> ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶°</label>
                    <div class="form-row">
                        <input type="text" id="reset-captcha" class="form-control" placeholder="‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                        <div id="reset-captcha-code" onclick="generateResetCaptcha()" class="form-control" style="background:#f8f9fa;font-family:monospace;font-size:1.3rem;letter-spacing:4px;text-align:center;cursor:pointer;color:var(--primary-dark);font-weight:bold;">X7K9</div>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="handleResetPassword()">
                    <i class="fas fa-sync-alt"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <div style="text-align:center;margin-top:15px;">
                    <span class="auth-link" onclick="showLoginForm()">‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- MAIN APP -->
<section id="app-section" class="app-container hidden">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><i class="fas fa-mosque"></i></div>
            <h3>‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</h3>
            <p style="font-size:0.82rem;opacity:0.8;">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç</p>
        </div>
        <div class="sidebar-menu" id="menu-container"></div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">‡¶Ü</div>
                <div style="flex:1;min-width:0;">
                    <div id="sidebar-username" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                    <div id="sidebar-usertype" style="font-size:0.82rem;color:var(--gray);">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</div>
                </div>
            </div>
            <button class="btn btn-outline w-100 mt-10" onclick="logout()" style="font-size:0.88rem;padding:9px;">
                <i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
            </button>
        </div>
    </nav>
    <main class="main-content">
        <div class="top-bar">
            <div class="flex center gap-15">
                <div class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
                <div class="page-title" id="page-title"><i class="fas fa-home"></i> <span>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</span></div>
            </div>
            <div class="top-actions">
                <div class="sync-indicator hidden" id="sync-indicator"><i class="fas fa-cloud-upload-alt"></i> <span>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</span></div>
                <div class="jsonbin-status" id="jsonbin-status" onclick="showJsonBinSettings()" title="JSONBin.io ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏">
                    <i class="fas fa-database"></i> <span id="jsonbin-status-text">‡¶≤‡ßã‡¶ï‡¶æ‡¶≤</span>
                </div>
                <div class="notification-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge hidden" id="notification-badge">0</span>
                </div>
                <div class="notifications-panel" id="notifications-panel">
                    <div class="notifications-header">
                        <h4><i class="fas fa-bell"></i> ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h4>
                        <span class="auth-link" onclick="markAllNotificationsRead()" style="font-size:0.85rem;">‡¶∏‡¶¨ ‡¶™‡¶°‡¶º‡¶æ</span>
                    </div>
                    <div class="notifications-list" id="notifications-list"></div>
                </div>
            </div>
        </div>
        <div id="content-area"></div>
    </main>
</section>

<!-- MODALS -->
<div id="service-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div id="sharia-advice-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:780px;">
        <div class="modal-header">
            <h3><i class="fas fa-hands-helping"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞</h3>
            <button onclick="closeShariaAdviceModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;height:480px;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);">
                <div class="chat-header"><i class="fas fa-user-tie"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶® <span style="margin-left:auto;font-size:0.78rem;font-weight:400;opacity:0.7;">AI ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂</span></div>
                <div class="chat-messages" id="sharia-chat-messages">
                    <div class="message msg-received">
                        <div>‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶∞‡¶æ‡¶π‡¶Æ‡¶æ‡¶§‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                        <div class="message-time">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="sharia-chat-input" class="chat-input" placeholder="‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter')sendShariaMessage()">
                    <button class="btn btn-primary" onclick="sendShariaMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="terms-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:780px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-contract"></i> ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</h3>
            <button onclick="closeTermsModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div style="max-height:420px;overflow-y:auto;padding-right:8px;">
                <div style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;margin-bottom:20px;">
                    <h4 style="color:var(--primary-dark);">üïå ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ</h4>
                </div>
                <p>‡ßß. ‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡ßá‡•§</p>
                <p>‡ß®. ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§‡•§</p>
                <p>‡ß©. ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá ‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ (‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨) ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£‡•§</p>
                <p>‡ß™. ‡¶ã‡¶£‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ (‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£) ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§</p>
                <h4 style="margin-top:20px;color:var(--primary-dark);">üîê ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</h4>
                <p>‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶®‡ßç‡¶°-‡¶ü‡ßÅ-‡¶è‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶°‡•§</p>
                <p>‡ß®. ‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶ï‡¶ñ‡¶®‡ßã ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
                <p>‡ß©. ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
                <p>‡ß™. ‡¶∏‡¶ï‡¶≤ ‡¶≤‡¶ó ‡¶§‡¶•‡ßç‡¶Ø ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞ ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
                <h4 style="margin-top:20px;color:var(--primary-dark);">üìã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨</h4>
                <p>‡ßß. ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ì ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
                <p>‡ß®. ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
                <p>‡ß©. ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§</p>
                <div class="text-center mt-20">
                    <button class="btn btn-primary" onclick="closeTermsModal()"><i class="fas fa-check"></i> ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø ‡¶ì ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="calc-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header">
            <h3><i class="fas fa-calculator"></i> ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h3>
            <button onclick="document.getElementById('calc-modal').classList.add('hidden')" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                <input type="number" id="calc-amount" class="form-control" placeholder="‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" oninput="calculateProfit()">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞ (%)</label>
                    <input type="number" id="calc-rate" class="form-control" value="8" step="0.5" oninput="calculateProfit()">
                </div>
                <div class="form-group">
                    <label>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ (‡¶¨‡¶õ‡¶∞)</label>
                    <input type="number" id="calc-years" class="form-control" value="3" min="1" max="30" oninput="calculateProfit()">
                </div>
            </div>
            <div class="form-group">
                <label>‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                <select id="calc-type" class="form-control" onchange="calculateProfit()">
                    <option value="simple">‡¶∏‡¶∞‡¶≤ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ (‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ)</option>
                    <option value="compound">‡¶ö‡¶ï‡ßç‡¶∞‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ (‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ)</option>
                </select>
            </div>
            <div class="calc-result" id="calc-result" style="display:none;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--primary);" id="calc-principal">‡ß≥‡ß¶</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--success);" id="calc-profit">‡ß≥‡ß¶</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--secondary);" id="calc-total">‡ß≥‡ß¶</div>
                    </div>
                </div>
                <div style="margin-top:15px;font-size:0.85rem;color:var(--gray);text-align:center;">
                    <i class="fas fa-info-circle"></i> ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡•§ ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶∂‡ßÄ‡¶≤‡•§
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JSONBin Settings Modal -->
<div id="jsonbin-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header">
            <h3><i class="fas fa-database"></i> JSONBin.io ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <button onclick="closeJsonBinModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:15px;color:var(--gray);">JSONBin.io ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <div class="form-group">
                <label><i class="fas fa-key"></i> API ‡¶ï‡ßÄ (Master Key)</label>
                <input type="password" id="jsonbin-api-key" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSONBin API ‡¶ï‡ßÄ">
                <small style="color:var(--gray);font-size:0.75rem;">$2a$10$... ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá</small>
            </div>
            <div class="form-group">
                <label><i class="fas fa-folder"></i> ‡¶¨‡¶ø‡¶® ID</label>
                <input type="text" id="jsonbin-bin-id" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSONBin ‡¶¨‡¶ø‡¶® ID">
                <small style="color:var(--gray);font-size:0.75rem;">‡ß¨‡ß™‡ß´... ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá</small>
            </div>
            <div class="form-row" style="gap:10px;">
                <button class="btn btn-success flex-1" onclick="testJsonBinConnection()"><i class="fas fa-plug"></i> ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
                <button class="btn btn-info flex-1" onclick="syncToJsonBin()"><i class="fas fa-cloud-upload-alt"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
            </div>
            <div class="form-row" style="gap:10px;margin-top:10px;">
                <button class="btn btn-primary flex-1" onclick="syncFromJsonBin()"><i class="fas fa-cloud-download-alt"></i> ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-warning flex-1" onclick="disableJsonBin()"><i class="fas fa-ban"></i> ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</button>
            </div>
            <div id="jsonbin-test-result" style="margin-top:15px;font-size:0.9rem;text-align:center;"></div>
        </div>
    </div>
</div>

<script>
// ========== JSONBin ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ==========
const JSONBIN_CONFIG = {
    apiKey: "$2a$10$nQcUsm.IExsgjr6WgFnRLO5zyNueZqIbQsX3DrYCuGCZ87JiXGzGa",
    binId: "69977655d0ea881f40c7d084",
    accountId: "699763851a35bc0895802c88",
    enabled: true
};

// ========== STATE ==========
let currentUser = null;
let activeChatWith = null;
let captchaValue = '';
let resetCaptchaValue = '';
let dbCache = null;
let jsonBinConfig = { apiKey: JSONBIN_CONFIG.apiKey, binId: JSONBIN_CONFIG.binId, enabled: JSONBIN_CONFIG.enabled };

// ========== PERSISTENT STORAGE ==========
const DB_KEY = 'nur_islamic_bank_v3';
const JSONBIN_CONFIG_KEY = 'nur_jsonbin_config';

// Storage functions
async function storageGet(key) {
    try {
        return localStorage.getItem(key);
    } catch(e) {
        console.warn('localStorage read failed', e);
        return null;
    }
}

async function storageSet(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch(e) {
        console.warn('localStorage write failed', e);
        return false;
    }
}

// JSONBin.io functions
async function loadJsonBinConfig() {
    try {
        const config = localStorage.getItem(JSONBIN_CONFIG_KEY);
        if (config) {
            jsonBinConfig = JSON.parse(config);
        } else {
            jsonBinConfig = {
                apiKey: JSONBIN_CONFIG.apiKey,
                binId: JSONBIN_CONFIG.binId,
                enabled: JSONBIN_CONFIG.enabled
            };
            localStorage.setItem(JSONBIN_CONFIG_KEY, JSON.stringify(jsonBinConfig));
        }
        updateJsonBinStatus();
    } catch(e) {
        console.warn('Failed to load JSONBin config', e);
    }
}

async function saveJsonBinConfig() {
    try {
        localStorage.setItem(JSONBIN_CONFIG_KEY, JSON.stringify(jsonBinConfig));
        updateJsonBinStatus();
    } catch(e) {
        console.warn('Failed to save JSONBin config', e);
    }
}

function updateJsonBinStatus() {
    const statusEl = document.getElementById('jsonbin-status');
    const statusText = document.getElementById('jsonbin-status-text');
    if (!statusEl || !statusText) return;
    
    if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
        statusEl.className = 'jsonbin-status online';
        statusText.textContent = 'JSONBin';
    } else {
        statusEl.className = 'jsonbin-status offline';
        statusText.textContent = '‡¶≤‡ßã‡¶ï‡¶æ‡¶≤';
    }
}

async function testJsonBinConnection() {
    const apiKey = document.getElementById('jsonbin-api-key').value.trim() || jsonBinConfig.apiKey;
    const binId = document.getElementById('jsonbin-bin-id').value.trim() || jsonBinConfig.binId;
    const resultEl = document.getElementById('jsonbin-test-result');
    
    if (!apiKey || !binId) {
        resultEl.innerHTML = '<span style="color:var(--danger);">API ‡¶ï‡ßÄ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶® ID ‡¶¶‡¶ø‡¶®</span>';
        return;
    }
    
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: 'GET',
            headers: {
                'X-Master-Key': apiKey
            }
        });
        
        if (response.ok) {
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶´‡¶≤!</span>';
            jsonBinConfig.apiKey = apiKey;
            jsonBinConfig.binId = binId;
            jsonBinConfig.enabled = true;
            saveJsonBinConfig();
            showToast('JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

async function syncToJsonBin() {
    if (!jsonBinConfig.enabled || !jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
        return;
    }
    
    const resultEl = document.getElementById('jsonbin-test-result');
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': jsonBinConfig.apiKey
            },
            body: JSON.stringify(dbCache || IslamicBankSystem.getDefaultData())
        });
        
        if (response.ok) {
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤!</span>';
            showToast('‡¶°‡ßá‡¶ü‡¶æ JSONBin-‡¶è ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

async function syncFromJsonBin() {
    if (!jsonBinConfig.enabled || !jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
        return;
    }
    
    const resultEl = document.getElementById('jsonbin-test-result');
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}/latest`, {
            method: 'GET',
            headers: {
                'X-Master-Key': jsonBinConfig.apiKey
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            dbCache = data.record || data;
            await IslamicBankSystem.save(dbCache);
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤!</span>';
            showToast('‡¶°‡ßá‡¶ü‡¶æ JSONBin ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            
            if (currentUser) {
                const currentTab = document.querySelector('.menu-item.active')?.id?.replace('menu-', '') || 'dashboard';
                switchTab(currentTab);
            }
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

function disableJsonBin() {
    jsonBinConfig.enabled = false;
    saveJsonBinConfig();
    document.getElementById('jsonbin-test-result').innerHTML = '<span style="color:var(--info);">JSONBin ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</span>';
    showToast('JSONBin ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'info');
}

function showJsonBinSettings() {
    document.getElementById('jsonbin-api-key').value = jsonBinConfig.apiKey || '';
    document.getElementById('jsonbin-bin-id').value = jsonBinConfig.binId || '';
    document.getElementById('jsonbin-test-result').innerHTML = '';
    document.getElementById('jsonbin-modal').classList.remove('hidden');
}

function closeJsonBinModal() {
    document.getElementById('jsonbin-modal').classList.add('hidden');
}

// ========== DATABASE ==========
const IslamicBankSystem = {
    getDefaultData() {
        return {
            version: 3,
            users: [
                { id:'admin', nid:'admin', password:'Admin@123', name:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', email:'admin@nurislamicbank.com', phone:'‡ß¶‡ßß‡ß¨‡ß®‡ß©‡ß≠', type:'admin', balance:0, joined:new Date().toLocaleDateString('bn-BD'), status:'active', address:'‡¶¨‡¶æ‡¶Ø‡¶º‡¶§‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶ï‡¶æ‡¶∞‡¶∞‡¶Æ, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', monthlyIncome:0, dob:'1990-01-01' },
                { id:'user_1001', nid:'1234567890123', password:'User@123', name:'‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Ü‡¶≤ ‡¶Æ‡¶æ‡¶Æ‡ßÅ‡¶®', email:'mamun@example.com', phone:'‡ß¶‡ßß‡ß≠‡ßß‡ßß‡ß®‡ß®‡ß©‡ß©‡ß™‡ß™', type:'personal', balance:50000, joined:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ßß-‡ßß‡ß´', status:'active', address:'‡¶Æ‡¶ø‡¶∞‡¶™‡ßÅ‡¶∞, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶∏‡¶´‡¶ü‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞', monthlyIncome:80000, dob:'1985-05-15' },
                { id:'user_1002', nid:'9876543210987', password:'User@456', name:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞', email:'fatema@example.com', phone:'‡ß¶‡ßß‡ßÆ‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ', type:'business', balance:150000, joined:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß©-‡ßß‡ß¶', status:'active', address:'‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ', monthlyIncome:200000, dob:'1988-11-20' }
            ],
            services: [
                { id:'mudarabah_savings', name:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', description:'‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ‡•§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ì ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡¶æ‡¶∞‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶≠‡¶æ‡¶ó‡¶æ‡¶≠‡¶æ‡¶ó‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá‡•§', type:'savings', category:'‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', minAmount:1000, maxAmount:10000000, profitRate:'‡ß≠-‡ßØ%', duration:'‡ßß-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≤‡¶æ‡¶≠','‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ','‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®','‡¶ï‡¶∞ ‡¶õ‡¶æ‡¶°‡¶º'], icon:'fas fa-piggy-bank' },
                { id:'musharakah_business', name:'‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', description:'‡¶Ø‡ßå‡¶• ‡¶Æ‡ßÇ‡¶≤‡¶ß‡¶®‡ßá ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡•§ ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:50000, maxAmount:50000000, profitRate:'‡ßß‡ß®-‡ßß‡ßÆ%', duration:'‡ß©-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶Ø‡ßå‡¶• ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶≠‡¶æ‡¶ó‡¶æ‡¶≠‡¶æ‡¶ó‡¶ø','‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü'], icon:'fas fa-handshake' },
                { id:'murabaha_home', name:'‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶π‡ßã‡¶Æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º-‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶π‡¶æ‡¶â‡¶ú‡¶ø‡¶Ç ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:500000, maxAmount:50000000, profitRate:'‡ßØ-‡ßß‡ß®%', duration:'‡ß´-‡ß®‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡¶ø‡¶Ç','‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡ßÄ ‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø','‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶¨‡ßÄ‡¶Æ‡¶æ','‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß'], icon:'fas fa-home' },
                { id:'ijarah_vehicle', name:'‡¶á‡¶ú‡¶æ‡¶∞‡¶æ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶≤‡¶ø‡¶ú‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:300000, maxAmount:5000000, profitRate:'‡ßß‡ß¶-‡ßß‡ß™%', duration:'‡ß©-‡ß≠ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≤‡¶ø‡¶ú‡¶ø‡¶Ç','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶Æ‡¶°‡ßá‡¶≤','‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ','‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ'], icon:'fas fa-car' },
                { id:'qard_hasan', name:'‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ (‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£)', description:'‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶ã‡¶£ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'loan', category:'‡¶ã‡¶£', minAmount:10000, maxAmount:500000, profitRate:'‡ß¶%', duration:'‡ß¨-‡ß®‡ß™ ‡¶Æ‡¶æ‡¶∏', features:['‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£','‡¶∏‡¶π‡¶ú ‡¶∂‡¶∞‡ßç‡¶§','‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£','‡¶®‡¶Æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶'], icon:'fas fa-hand-holding-heart' },
                { id:'wakala_investment', name:'‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡¶æ‡¶≤‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', description:'‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:100000, maxAmount:10000000, profitRate:'‡ßÆ-‡ßß‡ß´%', duration:'‡ß®-‡ß≠ ‡¶¨‡¶õ‡¶∞', features:['‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶´‡ßã‡¶≤‡¶ø‡¶ì','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü','‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ'], icon:'fas fa-chart-line' },
                { id:'sukuk_bond', name:'‡¶∏‡ßÅ‡¶ï‡ßÅ‡¶ï ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡¶®‡ßç‡¶°', description:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡¶®‡ßç‡¶°‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:50000, maxAmount:10000000, profitRate:'‡ßØ-‡ßß‡ßß%', duration:'‡ß©-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶°','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶Ü‡¶Ø‡¶º','‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ','‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡¶ú‡¶æ‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø'], icon:'fas fa-file-contract' },
                { id:'takaful_insurance', name:'‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ', description:'‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'insurance', category:'‡¶¨‡ßÄ‡¶Æ‡¶æ', minAmount:5000, maxAmount:1000000, profitRate:'‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤', duration:'‡ßß-‡ß®‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ','‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶ï‡¶≠‡¶æ‡¶∞‡ßá‡¶ú','‡¶≤‡¶æ‡¶≠ ‡¶¨‡¶£‡ßç‡¶ü‡¶®'], icon:'fas fa-shield-alt' },
                { id:'hajj_savings', name:'‡¶π‡¶ú ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ', description:'‡¶π‡¶ú ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ‡•§', type:'savings', category:'‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', minAmount:5000, maxAmount:500000, profitRate:'‡ß´-‡ß≠%', duration:'‡ßß-‡ß´ ‡¶¨‡¶õ‡¶∞', features:['‡¶π‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º','‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§','‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®','‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏'], icon:'fas fa-kaaba' },
                { id:'education_finance', name:'‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:20000, maxAmount:1000000, profitRate:'‡ß´-‡ßÆ%', duration:'‡ßß-‡ß´ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶ã‡¶£','‡¶®‡¶Æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø','‡¶¨‡¶ø‡¶®‡¶æ ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶®‡¶§','‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£'], icon:'fas fa-graduation-cap' }
            ],
            applications: [
                { id:1001, userId:'user_1001', userName:'‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Ü‡¶≤ ‡¶Æ‡¶æ‡¶Æ‡ßÅ‡¶®', userType:'personal', serviceId:'mudarabah_savings', serviceName:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', amount:50000, duration:'‡ß© ‡¶¨‡¶õ‡¶∞', purpose:'‡¶¨‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶Æ‡¶æ‡¶£‡ßá‡¶∞ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º', status:'approved', appliedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß¶', approvedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß´', approvedBy:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', shariaReview:true, reviewComment:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§' },
                { id:1002, userId:'user_1002', userName:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞', userType:'business', serviceId:'musharakah_business', serviceName:'‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', amount:200000, duration:'‡ß´ ‡¶¨‡¶õ‡¶∞', purpose:'‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ', status:'pending', appliedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´', shariaReview:false }
            ],
            transactions: [
                { id:5001, userId:'user_1001', type:'deposit', amount:50000, description:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', date:new Date().toLocaleString('bn-BD'), status:'completed', balance:50000 },
                { id:5002, userId:'user_1002', type:'deposit', amount:150000, description:'‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', date:new Date().toLocaleString('bn-BD'), status:'completed', balance:150000 }
            ],
            messages: [
                { id:2001, from:'user_1001', to:'admin', text:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º‡ßá‡¶∞ ‡¶≤‡¶æ‡¶≠ ‡¶ï‡¶ñ‡¶® ‡¶™‡¶æ‡¶¨‡ßã?', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß® ‡ßß‡ß¶:‡ßß‡ß´', read:true },
                { id:2002, from:'admin', to:'user_1001', text:'‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡ßß‡ß¶ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡•§', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß® ‡ßß‡ß¶:‡ß©‡ß¶', read:true },
                { id:2003, from:'user_1002', to:'admin', text:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ï‡ßÄ?', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß¨ ‡ßß‡ß™:‡ß®‡ß¶', read:false }
            ],
            notifications: [
                { id:3001, userId:'admin', title:'‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', message:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®', type:'application', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´ ‡ßß‡ßß:‡ß©‡ß¶', read:false },
                { id:3002, userId:'user_1002', title:'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ', message:'‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', type:'success', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´ ‡ßß‡ßß:‡ß©‡ß¶', read:false }
            ],
            settings: { 
                bankName:'‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', 
                supportEmail:'support@nurislamicbank.com', 
                contactNumber:'‡ßß‡ß¨‡ß®‡ß©‡ß≠', 
                address:'‡¶¨‡¶æ‡¶Ø‡¶º‡¶§‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶ï‡¶æ‡¶∞‡¶∞‡¶Æ, ‡¶¢‡¶æ‡¶ï‡¶æ', 
                workingHours:'‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞-‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßØ‡¶ü‡¶æ - ‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß´‡¶ü‡¶æ', 
                prayerBreak:'‡¶ú‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø: ‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞ ‡ßß‡ß®:‡ß©‡ß¶ - ‡ß®:‡ß©‡ß¶',
                enableCaptcha: true,
                enable2FA: false,
                enableLogging: true,
                sessionTimeout: 30,
                maxLoginAttempts: 5
            }
        };
    },

    async load() {
        if (dbCache) return dbCache;
        
        const data = await storageGet(DB_KEY);
        if (data) {
            try { 
                dbCache = JSON.parse(data); 
                return dbCache; 
            } catch(e) {}
        }
        
        if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': jsonBinConfig.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    dbCache = data.record || data;
                    await this.save(dbCache);
                    return dbCache;
                }
            } catch(e) {
                console.warn('Failed to load from JSONBin', e);
            }
        }
        
        dbCache = this.getDefaultData();
        await this.save(dbCache);
        return dbCache;
    },

    async save(data) {
        dbCache = data;
        const ok = await storageSet(DB_KEY, JSON.stringify(data));
        if (ok) showSyncIndicator();
        
        if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
            this.syncToJsonBinBackground(data);
        }
        
        return ok;
    },
    
    async syncToJsonBinBackground(data) {
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': jsonBinConfig.apiKey
                },
                body: JSON.stringify(data)
            });
        } catch(e) {
            console.warn('Background JSONBin sync failed', e);
        }
    },

    findUser(identifier, password = null) {
        if (!dbCache) return null;
        const u = dbCache.users.find(u =>
            (u.id === identifier || u.nid === identifier || u.email === identifier)
        );
        if (!u) return null;
        if (password && u.password !== password) return null;
        return u;
    },

    async addNotification(userId, title, message, type = 'info') {
        const db = await this.load();
        const notif = { id:Date.now(), userId, title, message, type, timestamp:new Date().toLocaleString('bn-BD'), read:false };
        db.notifications.push(notif);
        await this.save(db);
        if (currentUser && currentUser.id === userId) updateNotificationCount();
        return notif;
    },

    async addApplication(app) {
        const db = await this.load();
        app.id = Date.now();
        app.status = 'pending';
        app.appliedDate = new Date().toLocaleString('bn-BD');
        db.applications.push(app);
        await this.save(db);
        await this.addNotification('admin','‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®',`${app.userName} - ${app.serviceName}`,'application');
        await this.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'success');
        return app;
    },

    async addMessage(from, to, text) {
        const db = await this.load();
        const msg = { id:Date.now(), from, to, text, timestamp:new Date().toLocaleString('bn-BD'), read:false };
        db.messages.push(msg);
        await this.save(db);
        if (to !== from) {
            const fromUser = this.findUser(from);
            await this.addNotification(to,'‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ',`${fromUser?.name||'‡¶ï‡ßá‡¶â'} ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®`,'message');
        }
        return msg;
    },

    async addTransaction(txn) {
        const db = await this.load();
        txn.id = Date.now();
        txn.date = new Date().toLocaleString('bn-BD');
        txn.status = txn.status || 'completed';
        const user = db.users.find(u => u.id === txn.userId);
        txn.balance = user ? (user.balance || 0) : 0;
        db.transactions.push(txn);
        await this.save(db);
        return txn;
    }
};

// ========== UTILS ==========
function formatMoney(n) {
    return Number(n||0).toLocaleString('bn-BD');
}
function getUserTypeText(t) {
    return { personal:'‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§', business:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ', corporate:'‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü', student:'‡¶õ‡¶æ‡¶§‡ßç‡¶∞', admin:'‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' }[t] || t;
}
function showToast(msg, type='info') {
    const icons = { success:'fas fa-check-circle', error:'fas fa-times-circle', warning:'fas fa-exclamation-triangle', info:'fas fa-info-circle' };
    const colors = { success:'#27ae60', error:'#e74c3c', warning:'#f39c12', info:'#3498db' };
    const c = document.getElementById('toast-container');
    const d = document.createElement('div');
    d.className = `toast ${type}`;
    d.innerHTML = `<i class="${icons[type]}" style="color:${colors[type]};font-size:1.2rem;"></i><span>${msg}</span>`;
    c.appendChild(d);
    setTimeout(() => { d.style.opacity='0'; d.style.transform='translateX(100%)'; d.style.transition='all 0.3s'; setTimeout(() => d.remove(), 300); }, 3200);
}
function showSyncIndicator() {
    const el = document.getElementById('sync-indicator');
    if (!el) return;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2500);
}
function generateCaptcha() {
    const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    captchaValue = Array.from({length:4}, () => c[Math.floor(Math.random()*c.length)]).join('');
    const el = document.getElementById('captcha-code');
    if (el) el.textContent = captchaValue;
}
function generateResetCaptcha() {
    const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    resetCaptchaValue = Array.from({length:4}, () => c[Math.floor(Math.random()*c.length)]).join('');
    const el = document.getElementById('reset-captcha-code');
    if (el) el.textContent = resetCaptchaValue;
}
function togglePasswordVisibility(id, icon) {
    const inp = document.getElementById(id);
    if (inp.type === 'password') { inp.type = 'text'; icon.className = 'fas fa-eye-slash'; }
    else { inp.type = 'password'; icon.className = 'fas fa-eye'; }
}
function checkPasswordStrength(v) {
    let s = 0;
    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v)) s++;
    if (/[0-9]/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;
    const bar = document.getElementById('password-strength-bar');
    if (!bar) return;
    const w = ['0%','30%','55%','80%','100%'][s];
    const clr = ['#e74c3c','#e74c3c','#f39c12','#3498db','#27ae60'][s];
    bar.style.width = w; bar.style.background = clr;
}

// ========== AUTH ==========
function showLoginForm() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
    document.getElementById('forgot-password-form').classList.add('hidden');
    generateCaptcha();
}

function showRegisterForm() {
    document.getElementById('register-form').classList.remove('hidden');
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('forgot-password-form').classList.add('hidden');
}

function showForgotPassword() {
    document.getElementById('forgot-password-form').classList.remove('hidden');
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('register-form').classList.add('hidden');
    generateResetCaptcha();
}

function showTermsModal() { document.getElementById('terms-modal').classList.remove('hidden'); }
function closeTermsModal() { document.getElementById('terms-modal').classList.add('hidden'); }

async function handleResetPassword() {
    const nid = document.getElementById('reset-nid').value.trim();
    const email = document.getElementById('reset-email').value.trim();
    const newPass = document.getElementById('reset-new-password').value;
    const confirmPass = document.getElementById('reset-confirm-password').value;
    const captcha = document.getElementById('reset-captcha').value.trim().toUpperCase();
    
    if (!nid || !email || !newPass || !confirmPass || !captcha) {
        showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
        return;
    }
    
    if (captcha !== resetCaptchaValue) {
        showToast('‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error');
        generateResetCaptcha();
        return;
    }
    
    if (newPass !== confirmPass) {
        showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error');
        return;
    }
    
    if (newPass.length < 8) {
        showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
        return;
    }
    
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.nid === nid && u.email === email);
    
    if (!user) {
        showToast('NID ‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error');
        return;
    }
    
    user.password = newPass;
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(user.id, '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    
    showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    showLoginForm();
}

async function handleLogin() {
    const uid = document.getElementById('login-userid').value.trim();
    const pwd = document.getElementById('login-password').value;
    const cap = document.getElementById('login-captcha').value.trim().toUpperCase();
    
    if (!uid || !pwd) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (cap !== captchaValue) { showToast('‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); generateCaptcha(); return; }
    
    const db = await IslamicBankSystem.load();
    const user = IslamicBankSystem.findUser(uid, pwd);
    
    if (!user) { showToast('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); generateCaptcha(); return; }
    if (user.status === 'suspended') { showToast('‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§‡•§ ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error'); return; }
    
    currentUser = {...user};
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    loadDashboard();
}

async function handleRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const title = document.getElementById('reg-title').value;
    const nid = document.getElementById('reg-nid').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const phone = document.getElementById('reg-phone').value.trim();
    const type = document.getElementById('reg-type').value;
    const pwd = document.getElementById('reg-password').value;
    const confirmPwd = document.getElementById('reg-confirm-password').value;
    const dob = document.getElementById('reg-dob').value;
    const address = document.getElementById('reg-address').value.trim();
    const occupation = document.getElementById('reg-occupation').value;
    const income = parseInt(document.getElementById('reg-income').value) || 0;
    const terms = document.getElementById('reg-terms').checked;

    if (!name || !nid || !email || !phone || !type || !pwd || !address) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (!/^\d{10}$|^\d{17}$/.test(nid)) { showToast('NID ‡ßß‡ß¶ ‡¶¨‡¶æ ‡ßß‡ß≠ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    if (pwd.length < 8) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    if (pwd !== confirmPwd) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error'); return; }
    if (!terms) { showToast('‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶Æ‡ßá‡¶®‡ßá ‡¶®‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }

    const db = await IslamicBankSystem.load();
    if (db.users.find(u => u.nid === nid)) { showToast('‡¶è‡¶á NID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ü‡¶õ‡ßá', 'error'); return; }
    if (db.users.find(u => u.email === email)) { showToast('‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ü‡¶õ‡ßá', 'error'); return; }

    const userId = 'user_' + Date.now();
    const fullName = title ? `${title} ${name}` : name;
    const newUser = { id:userId, nid, password:pwd, name:fullName, email, phone, type, balance:0, joined:new Date().toLocaleDateString('bn-BD'), status:'active', address, occupation, monthlyIncome:income, dob };
    
    db.users.push(newUser);
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification('admin','‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®',`${fullName} ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßá‡¶õ‡ßá‡¶®`,'registration');
    showToast('‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤! ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'success');
    showLoginForm();
}

function logout() {
    currentUser = null;
    activeChatWith = null;
    sessionStorage.removeItem('currentUser');
    document.getElementById('app-section').classList.add('hidden');
    document.getElementById('auth-section').classList.remove('hidden');
    showLoginForm();
}

// ========== DASHBOARD ==========
function loadDashboard() {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('app-section').classList.remove('hidden');
    document.getElementById('sidebar-username').textContent = currentUser.name;
    document.getElementById('sidebar-usertype').textContent = getUserTypeText(currentUser.type);
    document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
    buildMenu();
    switchTab('dashboard');
    updateNotificationCount();
}

function buildMenu() {
    const mc = document.getElementById('menu-container');
    mc.innerHTML = '';
    const isAdmin = currentUser.type === 'admin';
    const db = dbCache || {};
    const pendingApps = (db.applications||[]).filter(a => a.status === 'pending').length;
    const unreadMsgs = (db.messages||[]).filter(m => m.to === currentUser.id && !m.read).length;

    const sections = isAdmin ? [
        { label:'‡¶Æ‡ßÇ‡¶≤', items:[
            { id:'dashboard', label:'‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°', icon:'fas fa-tachometer-alt' },
        ]},
        { label:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', items:[
            { id:'applications', label:'‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π', icon:'fas fa-file-alt', badge:pendingApps },
            { id:'users', label:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ', icon:'fas fa-users' },
            { id:'services', label:'‡¶∏‡ßá‡¶¨‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', icon:'fas fa-hand-holding-usd' },
            { id:'transactions', label:'‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®', icon:'fas fa-exchange-alt' },
        ]},
        { label:'‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£', items:[
            { id:'reports', label:'‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£', icon:'fas fa-chart-bar' },
            { id:'sharia-panel', label:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤', icon:'fas fa-gavel' },
        ]},
        { label:'‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó', items:[
            { id:'chat-admin', label:'‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü', icon:'fas fa-comments', badge:unreadMsgs },
            { id:'settings', label:'‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏', icon:'fas fa-cog' },
            { id:'jsonbin-settings', label:'JSONBin ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú', icon:'fas fa-database' },
        ]},
    ] : [
        { label:'‡¶Æ‡ßÇ‡¶≤', items:[
            { id:'dashboard', label:'‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°', icon:'fas fa-home' },
            { id:'my-accounts', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü', icon:'fas fa-wallet' },
        ]},
        { label:'‡¶∏‡ßá‡¶¨‡¶æ', items:[
            { id:'services-list', label:'‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π', icon:'fas fa-hand-holding-usd' },
            { id:'apply-service', label:'‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', icon:'fas fa-plus-circle' },
            { id:'my-applications', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', icon:'fas fa-file-alt', badge:(db.applications||[]).filter(a=>a.userId===currentUser.id&&a.status==='pending').length },
        ]},
        { label:'‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï', items:[
            { id:'transactions', label:'‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏', icon:'fas fa-history' },
            { id:'calculator', label:'‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞', icon:'fas fa-calculator' },
        ]},
        { label:'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ', items:[
            { id:'chat-user', label:'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü', icon:'fas fa-comment-dots', badge:unreadMsgs },
            { id:'sharia-advice', label:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂', icon:'fas fa-hands-helping' },
            { id:'profile', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤', icon:'fas fa-user' },
        ]},
    ];

    sections.forEach(sec => {
        const sectionDiv = document.createElement('div');
        const sectionTitle = document.createElement('div');
        sectionTitle.className = 'menu-section';
        sectionTitle.textContent = sec.label;
        sectionDiv.appendChild(sectionTitle);
        
        sec.items.forEach(item => {
            const d = document.createElement('div');
            d.className = 'menu-item';
            d.id = `menu-${item.id}`;
            d.innerHTML = `<i class="${item.icon}"></i><span>${item.label}</span>${item.badge ? `<span class="badge">${item.badge}</span>` : ''}`;
            if (item.id === 'jsonbin-settings') {
                d.onclick = () => showJsonBinSettings();
            } else {
                d.onclick = () => switchTab(item.id);
            }
            sectionDiv.appendChild(d);
        });
        mc.appendChild(sectionDiv);
    });
}

function switchTab(tabId) {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    const am = document.getElementById(`menu-${tabId}`);
    if (am) am.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    const ca = document.getElementById('content-area');

    const map = {
        'dashboard': showDashboard, 'services-list': showServices, 'services': showServices,
        'apply-service': showApplyService, 'my-applications': showApplications, 'applications': showApplications,
        'chat-user': showChat, 'chat-admin': showChat, 'sharia-advice': showShariaPanel, 'sharia-panel': showShariaPanel,
        'my-accounts': showMyAccounts, 'users': showUsers, 'transactions': showTransactions,
        'reports': showReports, 'profile': showProfile, 'settings': showSettings,
        'calculator': () => { document.getElementById('calc-modal').classList.remove('hidden'); showDashboard(ca); }
    };
    if (map[tabId]) map[tabId](ca);
}

// ========== DASHBOARD VIEW ==========
async function showDashboard(container) {
    const db = await IslamicBankSystem.load();
    let statsHtml = '';
    if (currentUser.type === 'admin') {
        const totalUsers = db.users.filter(u => u.type !== 'admin').length;
        const pendingApps = db.applications.filter(a => a.status === 'pending').length;
        const approvedApps = db.applications.filter(a => a.status === 'approved').length;
        const totalBalance = db.users.filter(u => u.type !== 'admin').reduce((s,u) => s+(u.balance||0), 0);
        statsHtml = `<div class="stats-grid">
            <div class="stat-card"><div class="stat-info"><h3>${totalUsers}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</p></div><div class="stat-icon"><i class="fas fa-users"></i></div></div>
            <div class="stat-card warning"><div class="stat-info"><h3>${pendingApps}</h3><p>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
            <div class="stat-card success"><div class="stat-info"><h3>${approvedApps}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
            <div class="stat-card info"><div class="stat-info"><h3>‡ß≥${formatMoney(totalBalance)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
        </div>`;
    } else {
        const myApps = db.applications.filter(a => a.userId === currentUser.id);
        const myTxns = db.transactions.filter(t => t.userId === currentUser.id);
        const me = db.users.find(u => u.id === currentUser.id);
        currentUser.balance = me ? me.balance : 0;
        statsHtml = `<div class="stats-grid">
            <div class="stat-card"><div class="stat-info"><h3>‡ß≥${formatMoney(currentUser.balance||0)}</h3><p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
            <div class="stat-card warning"><div class="stat-info"><h3>${myApps.filter(a=>a.status==='pending').length}</h3><p>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
            <div class="stat-card success"><div class="stat-info"><h3>${myApps.filter(a=>a.status==='approved').length}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
            <div class="stat-card info"><div class="stat-info"><h3>${myTxns.length}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</p></div><div class="stat-icon"><i class="fas fa-exchange-alt"></i></div></div>
        </div>`;
    }

    const recentTxns = db.transactions.filter(t => currentUser.type === 'admin' || t.userId === currentUser.id).slice(-5).reverse();
    const txnHtml = recentTxns.length ? recentTxns.map(t => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:36px;height:36px;border-radius:50%;background:${t.type==='deposit'?'#d4edda':'#f8d7da'};display:flex;align-items:center;justify-content:center;color:${t.type==='deposit'?'var(--success)':'var(--danger)'};">
                    <i class="fas fa-${t.type==='deposit'?'arrow-down':'arrow-up'}"></i>
                </div>
                <div><div style="font-weight:600;font-size:0.92rem;">${t.description}</div><div style="font-size:0.8rem;color:var(--gray);">${t.date}</div></div>
            </div>
            <div style="font-weight:700;color:${t.type==='deposit'?'var(--success)':'var(--danger)'};">${t.type==='deposit'?'+':'-'}‡ß≥${formatMoney(t.amount)}</div>
        </div>`).join('') : '<div style="text-align:center;padding:25px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</div>';

    container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div>
                    <h2 style="margin-bottom:8px;">‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ, ${currentUser.name}</h2>
                    <p style="opacity:0.85;">‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ‡•§</p>
                    ${currentUser.type !== 'admin' ? `<div style="margin-top:12px;"><span class="sharia-badge"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç</span></div>` : ''}
                </div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-mosque"></i></div>
            </div>
            ${statsHtml}
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:8px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-history"></i> ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h4>
                    ${txnHtml}
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-bolt"></i> ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        ${currentUser.type === 'admin' ? `
                            <div onclick="switchTab('applications')" style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;transition:var(--transition);" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='var(--primary-light)'">
                                <i class="fas fa-file-alt" style="font-size:1.8rem;color:var(--primary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</div>
                            </div>
                            <div onclick="switchTab('users')" style="background:#e3f2fd;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
                                <i class="fas fa-users" style="font-size:1.8rem;color:var(--info);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                            </div>
                            <div onclick="switchTab('chat-admin')" style="background:#e8f5e9;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'">
                                <i class="fas fa-comments" style="font-size:1.8rem;color:var(--success);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</div>
                            </div>
                            <div onclick="switchTab('reports')" style="background:#fff9e6;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#fff3cc'" onmouseout="this.style.background='#fff9e6'">
                                <i class="fas fa-chart-bar" style="font-size:1.8rem;color:var(--secondary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</div>
                            </div>
                        ` : `
                            <div onclick="switchTab('apply-service')" style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='var(--primary-light)'">
                                <i class="fas fa-plus-circle" style="font-size:1.8rem;color:var(--primary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ</div>
                            </div>
                            <div onclick="switchTab('my-applications')" style="background:#e3f2fd;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
                                <i class="fas fa-file-alt" style="font-size:1.8rem;color:var(--info);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</div>
                            </div>
                            <div onclick="switchTab('chat-user')" style="background:#e8f5e9;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'">
                                <i class="fas fa-comment-dots" style="font-size:1.8rem;color:var(--success);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ</div>
                            </div>
                            <div onclick="document.getElementById('calc-modal').classList.remove('hidden')" style="background:#fff9e6;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#fff3cc'" onmouseout="this.style.background='#fff9e6'">
                                <i class="fas fa-calculator" style="font-size:1.8rem;color:var(--secondary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°`;
}

// ========== SERVICES ==========
async function showServices(container) {
    const db = await IslamicBankSystem.load();
    const search = (container._search || '').toLowerCase();
    const filtered = db.services.filter(s =>
        s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search) || s.category.toLowerCase().includes(search)
    );
    const cardsHtml = filtered.map(s => `
        <div class="service-card">
            <div class="service-icon"><i class="${s.icon}"></i></div>
            <div class="service-body">
                <div class="service-title">${s.name}</div>
                <span class="sharia-badge" style="margin-bottom:10px;"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
                <div class="service-desc">${s.description}</div>
                <div class="service-meta">
                    <span><i class="fas fa-percentage" style="color:var(--success);"></i> ${s.profitRate}</span>
                    <span><i class="fas fa-calendar" style="color:var(--info);"></i> ${s.duration}</span>
                </div>
                <div class="service-features">
                    ${s.features.map(f => `<div class="feature-item"><i class="fas fa-check-circle"></i>${f}</div>`).join('')}
                </div>
                <div style="display:flex;gap:8px;margin-top:auto;">
                    <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('${s.id}')"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
                    ${currentUser.type !== 'admin' ? `<button class="btn btn-primary btn-sm flex-1" onclick="openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</button>` : ''}
                </div>
            </div>
        </div>`).join('');

    container.innerHTML = `
        <div class="services-container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px;">
                <h2 style="color:var(--primary-dark);">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
                <div style="position:relative;">
                    <i class="fas fa-search" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--gray);"></i>
                    <input type="text" placeholder="‡¶∏‡ßá‡¶¨‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="form-control" style="padding-left:38px;width:250px;" oninput="container._search=this.value;showServices(document.getElementById('content-area'))" id="service-search">
                </div>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterServices(this,'all')">‡¶∏‡¶¨ ‡¶∏‡ßá‡¶¨‡¶æ</button>
                <button class="filter-btn" onclick="filterServices(this,'savings')">‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º</button>
                <button class="filter-btn" onclick="filterServices(this,'investment')">‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</button>
                <button class="filter-btn" onclick="filterServices(this,'finance')">‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</button>
                <button class="filter-btn" onclick="filterServices(this,'loan')">‡¶ã‡¶£</button>
                <button class="filter-btn" onclick="filterServices(this,'insurance')">‡¶¨‡ßÄ‡¶Æ‡¶æ</button>
            </div>
            <div class="services-grid" id="services-grid">${cardsHtml || '<div style="text-align:center;padding:50px;color:var(--gray);grid-column:1/-1;">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>'}</div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-hand-holding-usd"></i> ‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π`;
}

function filterServices(btn, type) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!dbCache) return;
    const grid = document.getElementById('services-grid');
    const filtered = type === 'all' ? dbCache.services : dbCache.services.filter(s => s.type === type);
    grid.innerHTML = filtered.map(s => `
        <div class="service-card">
            <div class="service-icon"><i class="${s.icon}"></i></div>
            <div class="service-body">
                <div class="service-title">${s.name}</div>
                <span class="sharia-badge" style="margin-bottom:10px;"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
                <div class="service-desc">${s.description}</div>
                <div class="service-meta"><span><i class="fas fa-percentage" style="color:var(--success);"></i> ${s.profitRate}</span><span><i class="fas fa-calendar" style="color:var(--info);"></i> ${s.duration}</span></div>
                <div style="display:flex;gap:8px;margin-top:auto;">
                    <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('${s.id}')"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
                    ${currentUser.type !== 'admin' ? `<button class="btn btn-primary btn-sm flex-1" onclick="openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</button>` : ''}
                </div>
            </div>
        </div>`).join('') || '<div style="text-align:center;padding:50px;color:var(--gray);grid-column:1/-1;">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡ßá‡¶á</div>';
}

async function viewServiceDetails(svcId) {
    const db = await IslamicBankSystem.load();
    const s = db.services.find(x => x.id === svcId);
    if (!s) return;
    document.getElementById('modal-title').textContent = s.name;
    document.getElementById('modal-body').innerHTML = `
        <div style="text-align:center;padding:25px;background:linear-gradient(135deg,#fff9e6,#fff3cc);border-radius:var(--radius);margin-bottom:20px;">
            <div style="font-size:3.5rem;color:var(--secondary);margin-bottom:10px;"><i class="${s.icon}"></i></div>
            <span class="sharia-badge"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
        </div>
        <p style="color:var(--gray);margin-bottom:18px;">${s.description}</p>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px;">
            <div class="info-item"><div class="info-label">‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞</div><div class="info-value" style="color:var(--success);">${s.profitRate}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${s.duration}</div></div>
            <div class="info-item"><div class="info-label">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ</div><div class="info-value">‡ß≥${formatMoney(s.minAmount)}</div></div>
        </div>
        <h4 style="color:var(--primary-dark);margin-bottom:12px;">‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;">
            ${s.features.map(f => `<div class="feature-item" style="background:#f8f9fa;padding:8px 12px;border-radius:var(--radius-sm);"><i class="fas fa-check-circle"></i>${f}</div>`).join('')}
        </div>
        ${currentUser.type !== 'admin' ? `<button class="btn btn-primary w-100" onclick="closeModal();openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶è‡¶ñ‡¶®‡¶á ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>` : ''}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

async function showApplyService(container) {
    const db = await IslamicBankSystem.load();
    const opts = db.services.map(s => `<option value="${s.id}" data-min="${s.minAmount}" data-max="${s.maxAmount}" data-rate="${s.profitRate}">${s.name} (${s.profitRate})</option>`).join('');
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:700px;margin:0 auto;">
            <div class="card" style="cursor:default;">
                <h3 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-plus-circle"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</h3>
                <div class="form-group"><label>‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="apply-service-id" class="form-control" onchange="onServiceChange(this)"><option value="">-- ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® --</option>${opts}</select>
                </div>
                <div id="service-info-box" style="display:none;background:var(--primary-light);border-radius:var(--radius-sm);padding:14px;margin-bottom:18px;">
                    <div id="service-info-text"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                        <input type="number" id="apply-amount" class="form-control" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" oninput="validateAmount(this)">
                        <small id="amount-hint" style="color:var(--gray);font-size:0.8rem;"></small>
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</label>
                        <select id="apply-duration" class="form-control">
                            <option>‡ßß ‡¶¨‡¶õ‡¶∞</option><option>‡ß® ‡¶¨‡¶õ‡¶∞</option><option>‡ß© ‡¶¨‡¶õ‡¶∞</option><option>‡ß´ ‡¶¨‡¶õ‡¶∞</option><option>‡ß≠ ‡¶¨‡¶õ‡¶∞</option><option>‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø</label>
                    <textarea id="apply-purpose" class="form-control" rows="3" placeholder="‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                </div>
                <div class="form-group"><label>‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶®‡¶•‡¶ø‡¶™‡¶§‡ßç‡¶∞</label>
                    <div id="doc-checklist" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        ${['NID ‡¶ï‡¶™‡¶ø','‡¶õ‡¶¨‡¶ø (‡¶™‡¶æ‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú)','‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£','‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü'].map(d => `
                            <div style="display:flex;align-items:center;gap:8px;background:#f8f9fa;padding:8px 12px;border-radius:var(--radius-sm);">
                                <input type="checkbox" id="doc-${d.replace(/\s/g,'-')}">
                                <label for="doc-${d.replace(/\s/g,'-')}" style="margin:0;font-size:0.88rem;">${d}</label>
                            </div>`).join('')}
                    </div>
                </div>
                <button class="btn btn-primary w-100 btn-lg" onclick="submitApplication()">
                    <i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
                </button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-plus-circle"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®`;
}

function onServiceChange(sel) {
    const opt = sel.options[sel.selectedIndex];
    const min = opt.dataset.min, max = opt.dataset.max, rate = opt.dataset.rate;
    const box = document.getElementById('service-info-box');
    const txt = document.getElementById('service-info-text');
    if (sel.value && min) {
        txt.innerHTML = `<strong style="color:var(--primary-dark);">‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø:</strong> ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ <strong>‡ß≥${formatMoney(Number(min))}</strong>, ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö <strong>‡ß≥${formatMoney(Number(max))}</strong>, ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞ <strong style="color:var(--success);">${rate}</strong>`;
        document.getElementById('amount-hint').textContent = `‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ß≥${formatMoney(Number(min))} - ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß≥${formatMoney(Number(max))}`;
        box.style.display = 'block';
    } else { box.style.display = 'none'; }
}
function validateAmount(inp) {
    const sel = document.getElementById('apply-service-id');
    const opt = sel.options[sel.selectedIndex];
    if (!opt.dataset.min) return;
    const v = Number(inp.value);
    const min = Number(opt.dataset.min), max = Number(opt.dataset.max);
    if (v < min) inp.style.borderColor = 'var(--danger)';
    else if (v > max) inp.style.borderColor = 'var(--warning)';
    else inp.style.borderColor = 'var(--success)';
}

async function openApplyModal(svcId) {
    await showApplyService(document.getElementById('content-area'));
    const sel = document.getElementById('apply-service-id');
    sel.value = svcId;
    onServiceChange(sel);
    switchTab('apply-service');
}

async function submitApplication() {
    const svcId = document.getElementById('apply-service-id').value;
    const amount = parseInt(document.getElementById('apply-amount').value);
    const duration = document.getElementById('apply-duration').value;
    const purpose = document.getElementById('apply-purpose').value.trim();
    if (!svcId) { showToast('‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (!amount || amount <= 0) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error'); return; }
    if (!purpose) { showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const svc = db.services.find(s => s.id === svcId);
    if (!svc) return;
    if (amount < svc.minAmount) { showToast(`‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß≥${formatMoney(svc.minAmount)}`, 'error'); return; }
    if (amount > svc.maxAmount) { showToast(`‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß≥${formatMoney(svc.maxAmount)}`, 'error'); return; }
    const app = { userId:currentUser.id, userName:currentUser.name, userType:currentUser.type, serviceId:svcId, serviceName:svc.name, amount, duration, purpose };
    await IslamicBankSystem.addApplication(app);
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    switchTab('my-applications');
}

// ========== APPLICATIONS ==========
async function showApplications(container) {
    const db = await IslamicBankSystem.load();
    let apps = currentUser.type === 'admin' ? db.applications : db.applications.filter(a => a.userId === currentUser.id);
    apps = apps.slice().reverse();
    const tRows = apps.map(a => `
        <tr>
            <td>${a.userName || currentUser.name}<div style="font-size:0.8rem;color:var(--gray);">${getUserTypeText(a.userType||'personal')}</div></td>
            <td><div style="font-weight:600;">${a.serviceName}</div></td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(a.amount)}</td>
            <td>${a.duration}</td>
            <td style="font-size:0.85rem;">${a.appliedDate}</td>
            <td><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',processing:'‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ß‡ßÄ‡¶®'}[a.status]||a.status}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i></button>
                ${currentUser.type==='admin'&&a.status==='pending'?`<button class="btn btn-sm btn-success" onclick="quickApprove(${a.id})"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="quickReject(${a.id})"><i class="fas fa-times"></i></button>`:''}
            </div></td>
        </tr>`).join('');

    container.innerHTML = `
        <div class="table-container">
            <div class="table-header">
                <h2>${currentUser.type==='admin'?'‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®':'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®'} <span style="font-size:0.85rem;font-weight:400;color:var(--gray);">(${apps.length}‡¶ü‡¶ø)</span></h2>
                ${currentUser.type==='admin'?`<div class="filter-bar">
                    <button class="filter-btn active" onclick="filterApps(this,'all')">‡¶∏‡¶¨</button>
                    <button class="filter-btn" onclick="filterApps(this,'pending')">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</button>
                    <button class="filter-btn" onclick="filterApps(this,'approved')">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</button>
                    <button class="filter-btn" onclick="filterApps(this,'rejected')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>`:''}
            </div>
            <div class="table-responsive">
                <table><thead><tr><th>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ</th><th>‡¶∏‡ßá‡¶¨‡¶æ</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th><th>‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th></tr></thead>
                <tbody id="apps-tbody">${tRows||`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--gray);"><i class="fas fa-file-alt" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:12px;"></i>‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</td></tr>`}</tbody>
                </table>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-file-alt"></i> ${currentUser.type==='admin'?'‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π':'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®'}`;
}

function filterApps(btn, status) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!dbCache) return;
    let apps = status === 'all' ? dbCache.applications : dbCache.applications.filter(a => a.status === status);
    apps = apps.slice().reverse();
    const tbody = document.getElementById('apps-tbody');
    if (!tbody) return;
    tbody.innerHTML = apps.map(a => `
        <tr>
            <td>${a.userName}<div style="font-size:0.8rem;color:var(--gray);">${getUserTypeText(a.userType||'personal')}</div></td>
            <td><div style="font-weight:600;">${a.serviceName}</div></td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(a.amount)}</td>
            <td>${a.duration}</td>
            <td style="font-size:0.85rem;">${a.appliedDate}</td>
            <td><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[a.status]||a.status}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i></button>
                ${a.status==='pending'?`<button class="btn btn-sm btn-success" onclick="quickApprove(${a.id})"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="quickReject(${a.id})"><i class="fas fa-times"></i></button>`:''}
            </div></td>
        </tr>`).join('') || `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</td></tr>`;
}

async function viewApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    const svc = db.services.find(s => s.id === app.serviceId);
    document.getElementById('modal-title').textContent = '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
    const reviewSection = (currentUser.type === 'admin' && app.status === 'pending') ? `
        <div style="background:var(--primary-light);border-radius:var(--radius);padding:20px;margin:20px 0;">
            <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-gavel"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</h4>
            <div class="form-row">
                <div class="form-group"><label>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡¶ø</label>
                    <select id="sharia-compliance" class="form-control"><option value="approved">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</option><option value="conditionally-approved">‡¶∂‡¶∞‡ßç‡¶§‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑‡ßá</option><option value="not-approved">‡¶Ö‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</option></select>
                </div>
            </div>
            <div class="form-group"><label>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</label>
                <textarea id="sharia-comment" class="form-control" rows="3" placeholder="‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø..."></textarea>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-success flex-1" onclick="approveApplication(${app.id})"><i class="fas fa-check"></i> ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-danger flex-1" onclick="rejectApplication(${app.id})"><i class="fas fa-times"></i> ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>` : '';

    document.getElementById('modal-body').innerHTML = `
        <div style="background:linear-gradient(135deg,var(--primary-light),#e8f5e9);border-radius:var(--radius);padding:20px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                    <div style="font-size:0.85rem;color:var(--gray);">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                    <div style="font-size:1.2rem;font-weight:700;">${app.userName}</div>
                    <div style="font-size:0.88rem;color:var(--gray);">${getUserTypeText(app.userType||'personal')}</div>
                </div>
                <span class="status-badge status-${app.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[app.status]||app.status}</span>
            </div>
        </div>
        <div class="info-grid" style="margin-bottom:20px;">
            <div class="info-item"><div class="info-label">‡¶∏‡ßá‡¶¨‡¶æ</div><div class="info-value">${app.serviceName}</div></div>
            <div class="info-item"><div class="info-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div><div class="info-value" style="color:var(--primary);">‡ß≥${formatMoney(app.amount)}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${app.duration}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</div><div class="info-value" style="font-size:0.88rem;">${app.appliedDate}</div></div>
        </div>
        <div style="margin-bottom:20px;"><h4 style="color:var(--primary-dark);margin-bottom:10px;"><i class="fas fa-file-alt"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø</h4>
            <div style="background:#f8f9fa;border-radius:var(--radius-sm);padding:14px;">${app.purpose}</div>
        </div>
        ${reviewSection}
        ${app.status !== 'pending' ? `
        <div style="background:${app.status==='approved'?'#d4edda':'#f8d7da'};border-radius:var(--radius);padding:18px;">
            <h4 style="color:${app.status==='approved'?'#155724':'#721c24'};margin-bottom:10px;"><i class="fas fa-${app.status==='approved'?'check-circle':'times-circle'}"></i> ${app.status==='approved'?'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®':'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'} ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h4>
            <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${app.approvedDate||app.rejectedDate||'-'}</p>
            <p><strong>‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞:</strong> ${app.approvedBy||app.rejectedBy||'-'}</p>
            ${app.reviewComment?`<p><strong>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</strong> ${app.reviewComment}</p>`:''}
        </div>` : ''}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

async function approveApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'approved';
    app.approvedBy = currentUser.name;
    app.approvedDate = new Date().toLocaleString('bn-BD');
    app.shariaReview = true;
    app.reviewComment = document.getElementById('sharia-comment')?.value || '‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§';
    const user = db.users.find(u => u.id === app.userId);
    if (user && (app.serviceId.includes('savings') || app.serviceId.includes('deposit'))) {
        user.balance = (user.balance || 0) + app.amount;
        db.transactions.push({ id:Date.now(), userId:app.userId, type:'deposit', amount:app.amount, description:app.serviceName, date:new Date().toLocaleString('bn-BD'), status:'completed', balance:user.balance });
    }
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'success');
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    closeModal();
    showApplications(document.getElementById('content-area'));
    updateNotificationCount();
}

async function rejectApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'rejected';
    app.rejectedBy = currentUser.name;
    app.rejectedDate = new Date().toLocaleString('bn-BD');
    app.reviewComment = document.getElementById('sharia-comment')?.value || '‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶≤‡¶ô‡ßç‡¶ò‡¶®';
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'error');
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
    closeModal();
    showApplications(document.getElementById('content-area'));
    updateNotificationCount();
}

async function quickApprove(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'approved'; app.approvedBy = currentUser.name; app.approvedDate = new Date().toLocaleString('bn-BD'); app.reviewComment = '‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®';
    const user = db.users.find(u => u.id === app.userId);
    if (user && app.serviceId.includes('savings')) { user.balance = (user.balance||0) + app.amount; }
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',`${app.serviceName} ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§`,'success');
    showToast('‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    showApplications(document.getElementById('content-area'));
}

async function quickReject(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'rejected'; app.rejectedBy = currentUser.name; app.rejectedDate = new Date().toLocaleString('bn-BD');
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',`${app.serviceName} ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤`,'error');
    showToast('‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
    showApplications(document.getElementById('content-area'));
}

// ========== CHAT ==========
async function showChat(container) {
    const db = await IslamicBankSystem.load();
    if (currentUser.type === 'admin') {
        const users = db.users.filter(u => u.type !== 'admin');
        const userListHtml = users.map(u => {
            const unread = db.messages.filter(m => m.from === u.id && m.to === 'admin' && !m.read).length;
            const last = db.messages.filter(m => (m.from===u.id&&m.to==='admin')||(m.from==='admin'&&m.to===u.id)).sort((a,b)=>b.id-a.id)[0];
            return `<div class="chat-user-item ${activeChatWith===u.id?'active':''}" onclick="openChatWith('${u.id}')">
                <div class="user-avatar" style="width:36px;height:36px;font-size:0.95rem;">${u.name.charAt(0)}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:0.92rem;">${u.name}</div>
                    <div style="font-size:0.8rem;color:var(--gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${last?last.text.substring(0,28)+'...':'‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á'}</div>
                </div>
                ${unread?`<span class="badge">${unread}</span>`:''}
            </div>`;
        }).join('');

        const messagesHtml = activeChatWith ? await getChatMessages('admin', activeChatWith) : '<div style="text-align:center;padding:60px;color:var(--gray);"><i class="fas fa-comment-dots" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:15px;"></i>‡¶è‡¶ï‡¶ú‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>';
        const activeName = activeChatWith ? (db.users.find(u=>u.id===activeChatWith)?.name || '') : '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';

        container.innerHTML = `<div class="chat-container">
            <div class="chat-list"><div class="chat-header"><i class="fas fa-users"></i> ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
            <div style="overflow-y:auto;flex:1;">${userListHtml||'<div style="padding:20px;text-align:center;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡ßá‡¶á</div>'}</div></div>
            <div class="chat-window">
                <div class="chat-header"><i class="fas fa-user"></i> ${activeName} ${activeChatWith?'<span style="margin-left:8px;font-size:0.75rem;color:var(--success);font-weight:400;">‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</span>':''}</div>
                <div class="chat-messages" id="chat-messages">${messagesHtml}</div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input" placeholder="${activeChatWith?'‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...':'‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'}" ${!activeChatWith?'disabled':''} onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()" ${!activeChatWith?'disabled':''}><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>`;
    } else {
        const messagesHtml = await getChatMessages(currentUser.id, 'admin');
        container.innerHTML = `<div class="chat-container" style="flex-direction:column;height:auto;">
            <div class="chat-window" style="height:calc(100vh - 170px);">
                <div class="chat-header"><i class="fas fa-headset"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ <span style="margin-left:auto;font-size:0.75rem;font-weight:400;color:var(--success);">‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</span></div>
                <div class="chat-messages" id="chat-messages">${messagesHtml||'<div style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</div>'}</div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>`;
    }
    document.getElementById('page-title').innerHTML = `<i class="fas fa-comments"></i> ${currentUser.type==='admin'?'‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü':'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü'}`;
}

async function getChatMessages(user1, user2) {
    const db = await IslamicBankSystem.load();
    const msgs = db.messages.filter(m =>
        (m.from===user1&&m.to===user2)||(m.from===user2&&m.to===user1)
    ).sort((a,b) => a.id - b.id);
    let changed = false;
    msgs.forEach(m => { if (m.to === currentUser.id && !m.read) { m.read = true; changed = true; } });
    if (changed) await IslamicBankSystem.save(db);
    return msgs.map(m => `
        <div class="message ${m.from===currentUser.id?'msg-sent':'msg-received'}">
            <div>${m.text}</div>
            <div class="message-time">${m.timestamp} ${m.from===currentUser.id?'‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶ø':''}</div>
        </div>`).join('') || '<div style="text-align:center;padding:30px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</div>';
}

async function openChatWith(userId) {
    activeChatWith = userId;
    showChat(document.getElementById('content-area'));
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    const to = currentUser.type === 'admin' ? activeChatWith : 'admin';
    if (!to) return;
    await IslamicBankSystem.addMessage(currentUser.id, to, text);
    input.value = '';
    const msgs = document.getElementById('chat-messages');
    if (msgs) {
        const newMsg = document.createElement('div');
        newMsg.className = 'message msg-sent';
        newMsg.innerHTML = `<div>${text}</div><div class="message-time">${new Date().toLocaleString('bn-BD')} ‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶ø</div>`;
        if (msgs.querySelector('div[style*="text-align:center"]')) msgs.innerHTML = '';
        msgs.appendChild(newMsg);
        msgs.scrollTop = msgs.scrollHeight;
    }
    updateNotificationCount();
    buildMenu();
}

// ========== SHARIA PANEL ==========
async function showShariaPanel(container) {
    const db = await IslamicBankSystem.load();
    if (currentUser.type === 'admin') {
        const pendingReviews = db.applications.filter(a => a.status === 'pending').length;
        container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div><h2>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2><p>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶Ü‡¶á‡¶®‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶ï‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ</p></div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-gavel"></i></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-info"><h3>${pendingReviews}</h3><p>‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
                <div class="stat-card success"><div class="stat-info"><h3>${db.applications.filter(a=>a.shariaReview&&a.status==='approved').length}</h3><p>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${db.services.length}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶∏‡ßá‡¶¨‡¶æ</p></div><div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-book-open"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h4>
                    <div class="timeline">
                        ${[['‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß','‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßÅ‡¶¶ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß','success'],['‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø','success'],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ','‡¶ï‡ßç‡¶∞‡¶Ø‡¶º-‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ','success'],['‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ','‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®','success'],['‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤','‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ','success']].map(([t,d,c]) => `
                            <div class="timeline-item"><div class="timeline-dot ${c}"></div>
                            <div class="timeline-content"><strong>${t}</strong><div style="font-size:0.85rem;color:var(--gray);margin-top:4px;">${d}</div></div></div>`).join('')}
                    </div>
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-chart-pie"></i> ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞</h4>
                    ${[['‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º','‡ßØ‡ßÆ%',98],['‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó','‡ßØ‡ß´%',95],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏','‡ßØ‡ß≠%',97],['‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ','‡ßß‡ß¶‡ß¶%',100]].map(([n,p,w]) => `
                        <div style="margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.88rem;margin-bottom:5px;"><span>${n}</span><span style="color:var(--success);font-weight:600;">${p}</span></div>
                            <div class="progress-bar"><div class="chart-bar" style="width:${w}%;"></div></div>
                        </div>`).join('')}
                </div>
            </div>
        </div>`;
    } else {
        container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div><h2>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞</h2><p>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßÄ‡¶§‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶ø‡¶®</p></div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-hands-helping"></i></div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:18px;margin-bottom:25px;">
                ${[['‡¶∏‡ßÅ‡¶¶ ‡¶ï‡¶ø ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ?','‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßÅ‡¶¶ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§','fas fa-ban'],['‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶ï‡¶ø?','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡•§ ‡¶è‡¶ï‡¶ú‡¶® ‡¶™‡ßÅ‡¶Å‡¶ú‡¶ø ‡¶¶‡ßá‡¶Ø‡¶º, ‡¶Ö‡¶®‡ßç‡¶Ø‡¶ú‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡•§','fas fa-handshake'],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶ï‡¶ø?','‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§','fas fa-store'],['‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶ï‡¶ø?','‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§','fas fa-shield-alt']].map(([q,a,i]) => `
                    <div class="card" style="cursor:default;">
                        <div style="font-size:2rem;color:var(--secondary);margin-bottom:12px;"><i class="${i}"></i></div>
                        <h4 style="color:var(--primary-dark);margin-bottom:8px;">${q}</h4>
                        <p style="color:var(--gray);font-size:0.9rem;">${a}</p>
                    </div>`).join('')}
            </div>
            <div style="text-align:center;">
                <button class="btn btn-primary btn-lg" onclick="openShariaAdviceModal()"><i class="fas fa-comment-dots"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶®</button>
            </div>
        </div>`;
    }
    document.getElementById('page-title').innerHTML = `<i class="fas fa-gavel"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤`;
}

function openShariaAdviceModal() { document.getElementById('sharia-advice-modal').classList.remove('hidden'); }
function closeShariaAdviceModal() { document.getElementById('sharia-advice-modal').classList.add('hidden'); }

function sendShariaMessage() {
    const input = document.getElementById('sharia-chat-input');
    const text = input.value.trim();
    if (!text) return;
    const chatWin = document.getElementById('sharia-chat-messages');
    chatWin.innerHTML += `<div class="message msg-sent"><div>${text}</div><div class="message-time">${new Date().toLocaleString('bn-BD')}</div></div>`;
    input.value = '';
    chatWin.scrollTop = chatWin.scrollHeight;
    setTimeout(() => {
        const replies = {
            '‡¶∏‡ßÅ‡¶¶': '‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ‡•§ ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶§‡¶æ‡¶Ü‡¶≤‡¶æ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá ‡¶¨‡¶≤‡ßá‡¶õ‡ßá‡¶®: "‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶ï‡ßá ‡¶π‡¶æ‡¶≤‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßÅ‡¶¶‡¶ï‡ßá ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§" (‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶¨‡¶æ‡¶ï‡¶æ‡¶∞‡¶æ: ‡ß®‡ß≠‡ß´)',
            '‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ': '‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶π‡¶≤‡ßã ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§ ‡¶è‡¶ï‡¶™‡¶ï‡ßç‡¶∑ ‡¶Æ‡ßÇ‡¶≤‡¶ß‡¶® ‡¶¶‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶Ø‡¶™‡¶ï‡ßç‡¶∑ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡¶®‡•§ ‡¶≤‡¶æ‡¶≠ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡¶æ‡¶∞‡ßá ‡¶¨‡¶£‡ßç‡¶ü‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡•§',
            '‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ': '‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡•§',
            '‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤': '‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶π‡¶≤‡ßã ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ‡•§ ‡¶è‡¶§‡ßá ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶∞‡¶æ ‡¶™‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ï‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡¶§‡ßá ‡¶ö‡¶æ‡¶Å‡¶¶‡¶æ ‡¶¶‡ßá‡¶®‡•§ ‡¶™‡ßç‡¶∞‡¶ö‡¶≤‡¶ø‡¶§ ‡¶¨‡ßÄ‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶∏‡ßÅ‡¶¶ ‡¶¨‡¶æ ‡¶Ö‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§',
            '‡¶ú‡¶æ‡¶ï‡¶æ‡¶§': '‡¶ú‡¶æ‡¶ï‡¶æ‡¶§ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶Å‡¶ö‡¶ü‡¶ø ‡¶∏‡ßç‡¶§‡¶Æ‡ßç‡¶≠‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø‡•§ ‡¶®‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶õ‡¶∞ ‡ß®.‡ß´% ‡¶ú‡¶æ‡¶ï‡¶æ‡¶§ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡•§',
            '‡¶π‡¶æ‡¶≤‡¶æ‡¶≤': '‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá ‡¶π‡¶æ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡•§',
            '‡¶π‡¶ú': '‡¶π‡¶ú ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ ‡¶π‡¶ú ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶¶‡ßá‡¶Ø‡¶º‡•§ ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡•§',
            '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ': '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡¶§‡ßá ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßá‡¶ü‡¶æ‡¶§‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ï‡¶∞‡ßá‡•§'
        };
        let reply = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡¶¶‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø: ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§‡•§';
        for (const [key, val] of Object.entries(replies)) {
            if (text.includes(key)) { reply = val; break; }
        }
        chatWin.innerHTML += `<div class="message msg-received"><div>${reply}</div><div class="message-time">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï</div></div>`;
        chatWin.scrollTop = chatWin.scrollHeight;
    }, 900);
}

// ========== MY ACCOUNTS ==========
async function showMyAccounts(container) {
    const db = await IslamicBankSystem.load();
    const me = db.users.find(u => u.id === currentUser.id);
    currentUser.balance = me?.balance || 0;
    const accounts = db.applications.filter(a => a.userId === currentUser.id && a.status === 'approved');
    const accountsHtml = accounts.map(a => {
        const svc = db.services.find(s => s.id === a.serviceId);
        return `<div class="service-card">
            <div class="service-icon"><i class="${svc?.icon||'fas fa-wallet'}"></i></div>
            <div class="service-body">
                <div class="service-title">${a.serviceName}</div>
                <span class="status-badge status-approved" style="margin-bottom:14px;">‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</span>
                <div class="info-grid" style="margin-bottom:15px;">
                    <div class="info-item"><div class="info-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div><div class="info-value" style="color:var(--primary);">‡ß≥${formatMoney(a.amount)}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${a.duration}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</div><div class="info-value" style="font-size:0.82rem;">${a.approvedDate||'-'}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶π‡¶æ‡¶∞</div><div class="info-value" style="color:var(--success);">${svc?.profitRate||'-'}</div></div>
                </div>
                <button class="btn btn-outline w-100" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
            </div>
        </div>`;
    }).join('');
    container.innerHTML = `
        <div class="services-container">
            <div style="background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;border-radius:var(--radius);padding:25px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;">
                <div><h3 style="margin-bottom:5px;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</h3><div style="font-size:2.2rem;font-weight:700;">‡ß≥${formatMoney(currentUser.balance)}</div></div>
                <div style="text-align:right;"><div style="opacity:0.8;font-size:0.9rem;">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div><div style="font-size:2.5rem;font-weight:700;">${accounts.length}</div></div>
            </div>
            <h2 style="margin-bottom:18px;color:var(--primary-dark);">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div class="services-grid">${accountsHtml||`<div style="text-align:center;padding:50px;grid-column:1/-1;"><i class="fas fa-wallet" style="font-size:3rem;color:var(--gray);opacity:0.3;display:block;margin-bottom:15px;"></i><h3 style="color:var(--gray);margin-bottom:10px;">‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á</h3><button class="btn btn-primary" onclick="switchTab('apply-service')"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶®</button></div>`}</div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-wallet"></i> ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü`;
}

// ========== USERS ==========
async function showUsers(container) {
    const db = await IslamicBankSystem.load();
    const users = db.users.filter(u => u.type !== 'admin');
    const rows = users.map(u => {
        const apps = db.applications.filter(a => a.userId === u.id && a.status === 'approved').length;
        const total = db.applications.filter(a => a.userId === u.id && a.status === 'approved').reduce((s,a) => s+a.amount, 0);
        return `<tr>
            <td><div style="display:flex;align-items:center;gap:10px;">
                <div class="user-avatar" style="width:34px;height:34px;font-size:0.9rem;">${u.name.charAt(0)}</div>
                <div><div style="font-weight:600;">${u.name}</div><div style="font-size:0.8rem;color:var(--gray);">${u.nid}</div></div>
            </div></td>
            <td>${u.email}</td>
            <td>${u.phone}</td>
            <td><span class="status-badge status-approved">${getUserTypeText(u.type)}</span></td>
            <td style="text-align:center;">${apps}</td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(total)}</td>
            <td>${u.joined}</td>
            <td><span class="status-badge ${u.status==='active'?'status-approved':'status-rejected'}">${u.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewUserDetails('${u.id}')"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-primary" onclick="activeChatWith='${u.id}';switchTab('chat-admin')"><i class="fas fa-comment"></i></button>
                <button class="btn btn-sm ${u.status==='active'?'btn-warning':'btn-success'}" onclick="toggleUserStatus('${u.id}')"><i class="fas fa-${u.status==='active'?'ban':'check'}"></i></button>
            </div></td>
        </tr>`;
    }).join('');
    container.innerHTML = `
        <div class="table-container">
            <div class="table-header"><h2>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ <span style="font-size:0.85rem;font-weight:400;color:var(--gray);">(${users.length}‡¶ú‡¶®)</span></h2></div>
            <div class="table-responsive"><table><thead><tr><th>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</th><th>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th><th>‡¶´‡ßã‡¶®</th><th>‡¶ß‡¶∞‡¶®</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</th><th>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</th><th>‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th><th>‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th></tr></thead>
            <tbody>${rows||`<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡ßá‡¶á</td></tr>`}</tbody></table></div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-users"></i> ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ`;
}

async function toggleUserStatus(userId) {
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === userId);
    if (!user) return;
    user.status = user.status === 'active' ? 'suspended' : 'active';
    await IslamicBankSystem.save(db);
    showToast(`‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ${user.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
    showUsers(document.getElementById('content-area'));
}

async function viewUserDetails(userId) {
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === userId);
    if (!user) return;
    const userApps = db.applications.filter(a => a.userId === userId);
    document.getElementById('modal-title').textContent = '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
    document.getElementById('modal-body').innerHTML = `
        <div class="profile-header">
            <div class="profile-avatar">${user.name.charAt(0)}</div>
            <div><h3 style="margin-bottom:4px;">${user.name}</h3><div style="opacity:0.85;">${getUserTypeText(user.type)} ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</div></div>
        </div>
        <div class="info-grid" style="margin-bottom:20px;">
            <div class="info-item"><div class="info-label">NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div><div class="info-value">${user.nid}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</div><div class="info-value">${user.joined}</div></div>
            <div class="info-item"><div class="info-label">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</div><div class="info-value">${user.email}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</div><div class="info-value">${user.phone}</div></div>
            <div class="info-item"><div class="info-label">‡¶™‡ßá‡¶∂‡¶æ</div><div class="info-value">${user.occupation||'-'}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</div><div class="info-value">‡ß≥${formatMoney(user.monthlyIncome)}</div></div>
            <div class="info-item"><div class="info-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div><div class="info-value" style="color:var(--primary);font-size:1.1rem;">‡ß≥${formatMoney(user.balance)}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</div><div class="info-value"><span class="status-badge ${user.status==='active'?'status-approved':'status-rejected'}">${user.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'}</span></div></div>
        </div>
        <div style="margin-bottom:18px;"><div class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</div><div class="info-value">${user.address}</div></div>
        <h4 style="color:var(--primary-dark);margin-bottom:12px;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π (${userApps.length}‡¶ü‡¶ø)</h4>
        ${userApps.map(a => `<div style="background:#f8f9fa;border-radius:var(--radius-sm);padding:11px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:600;">${a.serviceName}</div><div style="font-size:0.83rem;color:var(--gray);">‡ß≥${formatMoney(a.amount)} ‚Ä¢ ${a.duration}</div></div><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[a.status]||a.status}</span></div>`).join('')||'<div style="color:var(--gray);padding:10px;">‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</div>'}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

// ========== TRANSACTIONS ==========
async function showTransactions(container) {
    const db = await IslamicBankSystem.load();
    let txns = currentUser.type === 'admin' ? db.transactions : db.transactions.filter(t => t.userId === currentUser.id);
    txns = txns.slice().reverse();
    const rows = txns.map(t => {
        const u = db.users.find(u => u.id === t.userId);
        return `<tr>
            <td style="font-family:monospace;font-size:0.85rem;">#${t.id}</td>
            ${currentUser.type==='admin'?`<td>${u?.name||'-'}</td>`:''}
            <td>${t.description}</td>
            <td style="color:${t.type==='deposit'?'var(--success)':'var(--danger)'};font-weight:700;">${t.type==='deposit'?'+':'-'}‡ß≥${formatMoney(t.amount)}</td>
            <td>‡ß≥${formatMoney(t.balance)}</td>
            <td style="font-size:0.85rem;">${t.date}</td>
            <td><span class="status-badge ${t.status==='completed'?'status-approved':t.status==='pending'?'status-pending':'status-processing'}">${{completed:'‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®',pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',processing:'‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ß‡ßÄ‡¶®'}[t.status]||t.status}</span></td>
        </tr>`;
    }).join('');

    const totalDeposit = txns.filter(t=>t.type==='deposit').reduce((s,t)=>s+t.amount,0);
    const totalWithdraw = txns.filter(t=>t.type==='withdrawal').reduce((s,t)=>s+t.amount,0);

    container.innerHTML = `
        <div class="table-container">
            <div class="stats-grid" style="margin-bottom:20px;">
                <div class="stat-card success"><div class="stat-info"><h3>‡ß≥${formatMoney(totalDeposit)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</p></div><div class="stat-icon"><i class="fas fa-arrow-down"></i></div></div>
                <div class="stat-card warning"><div class="stat-info"><h3>‡ß≥${formatMoney(totalWithdraw)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</p></div><div class="stat-icon"><i class="fas fa-arrow-up"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${txns.length}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</p></div><div class="stat-icon"><i class="fas fa-exchange-alt"></i></div></div>
            </div>
            <div class="table-header"><h2>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2></div>
            <div class="table-responsive"><table><thead><tr><th>ID</th>${currentUser.type==='admin'?'<th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>':''}<th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th></tr></thead>
            <tbody>${rows||`<tr><td colspan="${currentUser.type==='admin'?7:6}" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>`}</tbody></table></div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-exchange-alt"></i> ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®`;
}

// ========== REPORTS ==========
async function showReports(container) {
    const db = await IslamicBankSystem.load();
    const totalUsers = db.users.filter(u=>u.type!=='admin').length;
    const totalApps = db.applications.length;
    const approvedApps = db.applications.filter(a=>a.status==='approved').length;
    const rejectedApps = db.applications.filter(a=>a.status==='rejected').length;
    const totalDeposit = db.transactions.filter(t=>t.type==='deposit').reduce((s,t)=>s+t.amount,0);
    const typeCount = {};
    db.applications.forEach(a => { typeCount[a.serviceName] = (typeCount[a.serviceName]||0)+1; });
    const maxCount = Math.max(...Object.values(typeCount), 1);

    container.innerHTML = `
        <div class="dashboard-content">
            <h2 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-chart-bar"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h2>
            <div class="stats-grid" style="margin-bottom:25px;">
                <div class="stat-card"><div class="stat-info"><h3>${totalUsers}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</p></div><div class="stat-icon"><i class="fas fa-users"></i></div></div>
                <div class="stat-card success"><div class="stat-info"><h3>‡ß≥${formatMoney(totalDeposit)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
                <div class="stat-card warning"><div class="stat-info"><h3>${approvedApps}/${totalApps}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞</p></div><div class="stat-icon"><i class="fas fa-chart-pie"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${db.services.length}</h3><p>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡ßá‡¶¨‡¶æ</p></div><div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:18px;"><i class="fas fa-chart-pie"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶§‡¶∞‡¶£</h4>
                    <div>
                        ${[['‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',approvedApps,totalApps,'success'],['‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',db.applications.filter(a=>a.status==='pending').length,totalApps,'warning'],['‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',rejectedApps,totalApps,'danger']].map(([l,v,t,c]) => `
                        <div style="margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.88rem;"><span>${l}</span><span style="color:var(--${c});font-weight:700;">${v} (${t?Math.round(v/t*100):0}%)</span></div>
                            <div class="progress-bar"><div style="height:100%;width:${t?v/t*100:0}%;background:var(--${c});border-radius:12px;transition:width 1s;"></div></div>
                        </div>`).join('')}
                    </div>
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:18px;"><i class="fas fa-list-ol"></i> ‡¶∏‡ßá‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</h4>
                    ${Object.entries(typeCount).slice(0,6).map(([n,c]) => `
                        <div style="margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:4px;"><span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;">${n}</span><span style="font-weight:700;color:var(--primary);">${c}</span></div>
                            <div class="progress-bar"><div class="chart-bar" style="width:${Math.round(c/maxCount*100)}%;"></div></div>
                        </div>`).join('')||'<p style="color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</p>'}
                </div>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-chart-bar"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`;
}

// ========== PROFILE ==========
async function showProfile(container) {
    const db = await IslamicBankSystem.load();
    const me = db.users.find(u => u.id === currentUser.id);
    if (!me) return;
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:700px;margin:0 auto;">
            <div class="profile-header">
                <div class="profile-avatar">${me.name.charAt(0)}</div>
                <div><h2 style="margin-bottom:4px;">${me.name}</h2><div style="opacity:0.85;">${getUserTypeText(me.type)} ‚Ä¢ ${me.joined}</div><div style="margin-top:10px;"><span class="sharia-badge"><i class="fas fa-check"></i> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡ßÉ‡¶§ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</span></div></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-user"></i> ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div><div class="info-value">${me.nid}</div></div>
                    <div class="info-item"><div class="info-label">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</div><div class="info-value">${me.email}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</div><div class="info-value">${me.phone}</div></div>
                    <div class="info-item"><div class="info-label">‡¶™‡ßá‡¶∂‡¶æ</div><div class="info-value">${me.occupation||'-'}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</div><div class="info-value">‡ß≥${formatMoney(me.monthlyIncome)}</div></div>
                    <div class="info-item"><div class="info-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div><div class="info-value" style="color:var(--primary);font-size:1.1rem;">‡ß≥${formatMoney(me.balance)}</div></div>
                </div>
                <div class="info-item" style="margin-top:12px;"><div class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</div><div class="info-value">${me.address}</div></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-edit"></i> ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                <div class="form-row">
                    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</label><input type="tel" id="edit-phone" class="form-control" value="${me.phone}"></div>
                    <div class="form-group"><label>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</label><input type="number" id="edit-income" class="form-control" value="${me.monthlyIncome}"></div>
                </div>
                <div class="form-group"><label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><textarea id="edit-address" class="form-control" rows="2">${me.address}</textarea></div>
                <button class="btn btn-primary" onclick="updateProfile()"><i class="fas fa-save"></i> ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div class="card" style="cursor:default;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h4>
                <div class="form-group"><label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="current-password" class="form-control"></div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="new-password" class="form-control"></div>
                    <div class="form-group"><label>‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="password" id="confirm-new-password" class="form-control"></div>
                </div>
                <button class="btn btn-warning" onclick="updatePassword()"><i class="fas fa-key"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-user"></i> ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤`;
}

async function updateProfile() {
    const phone = document.getElementById('edit-phone').value.trim();
    const income = parseInt(document.getElementById('edit-income').value) || 0;
    const address = document.getElementById('edit-address').value.trim();
    if (!phone || !address) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === currentUser.id);
    if (user) { user.phone = phone; user.monthlyIncome = income; user.address = address; }
    await IslamicBankSystem.save(db);
    currentUser.phone = phone;
    showToast('‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

async function updatePassword() {
    const cur = document.getElementById('current-password').value;
    const nw = document.getElementById('new-password').value;
    const cfm = document.getElementById('confirm-new-password').value;
    if (cur !== currentUser.password) { showToast('‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); return; }
    if (nw !== cfm) { showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error'); return; }
    if (nw.length < 8) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === currentUser.id);
    if (user) { user.password = nw; }
    await IslamicBankSystem.save(db);
    currentUser.password = nw;
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-new-password').value = '';
    showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

// ========== SETTINGS ==========
async function showSettings(container) {
    const db = await IslamicBankSystem.load();
    const s = db.settings;
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:750px;margin:0 auto;">
            <h2 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-cog"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-building"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h3>
                <div class="form-group"><label>‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label><input type="text" id="bank-name" class="form-control" value="${s.bankName}"></div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="support-email" class="form-control" value="${s.supportEmail}"></div>
                    <div class="form-group"><label>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="contact-number" class="form-control" value="${s.contactNumber}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º</label><input type="text" id="working-hours" class="form-control" value="${s.workingHours}"></div>
                    <div class="form-group"><label>‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø</label><input type="text" id="prayer-break" class="form-control" value="${s.prayerBreak}"></div>
                </div>
                <div class="form-group"><label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><textarea id="bank-address" class="form-control" rows="2">${s.address}</textarea></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-shield-alt"></i> ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                <div class="form-row">
                    <div class="form-group"><label>‡¶∏‡ßá‡¶∂‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)</label><input type="number" id="session-timeout" class="form-control" value="${s.sessionTimeout||30}" min="5" max="120"></div>
                    <div class="form-group"><label>‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ</label><input type="number" id="max-login" class="form-control" value="${s.maxLoginAttempts||5}" min="1" max="10"></div>
                </div>
                <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">
                    ${[['enable-captcha','‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ö‡¶æ ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ',s.enableCaptcha!==false],['enable-2fa','‡ß®-‡¶´‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶®',s.enable2FA||false],['enable-logging','‡¶≤‡¶ó‡¶ø‡¶Ç ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ',s.enableLogging!==false]].map(([id,label,checked]) => `
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#f8f9fa;border-radius:var(--radius-sm);">
                        <input type="checkbox" id="${id}" ${checked?'checked':''} style="width:16px;height:16px;">
                        <span>${label}</span>
                    </label>`).join('')}
                </div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-database"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <button class="btn btn-info" onclick="exportData()"><i class="fas fa-download"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
                    <button class="btn btn-danger" onclick="clearOldData()"><i class="fas fa-trash"></i> ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                </div>
            </div>
            <div style="text-align:center;margin-top:15px;">
                <button class="btn btn-primary btn-lg" onclick="saveSettings()"><i class="fas fa-save"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div style="text-align:center;margin-top:15px;">
                <button class="btn btn-secondary" onclick="showJsonBinSettings()"><i class="fas fa-cloud-upload-alt"></i> JSONBin.io ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-cog"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏`;
}

async function saveSettings() {
    const db = await IslamicBankSystem.load();
    db.settings.bankName = document.getElementById('bank-name').value;
    db.settings.supportEmail = document.getElementById('support-email').value;
    db.settings.contactNumber = document.getElementById('contact-number').value;
    db.settings.workingHours = document.getElementById('working-hours').value;
    db.settings.prayerBreak = document.getElementById('prayer-break').value;
    db.settings.address = document.getElementById('bank-address').value;
    db.settings.sessionTimeout = parseInt(document.getElementById('session-timeout').value) || 30;
    db.settings.maxLoginAttempts = parseInt(document.getElementById('max-login').value) || 5;
    db.settings.enableCaptcha = document.getElementById('enable-captcha').checked;
    db.settings.enable2FA = document.getElementById('enable-2fa').checked;
    db.settings.enableLogging = document.getElementById('enable-logging').checked;
    await IslamicBankSystem.save(db);
    showToast('‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

function exportData() {
    if (!dbCache) return;
    const json = JSON.stringify(dbCache, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `nur_bank_backup_${Date.now()}.json`;
    a.click(); URL.revokeObjectURL(url);
    showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤', 'success');
}

async function clearOldData() {
    if (!confirm('‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶° ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) return;
    const db = await IslamicBankSystem.load();
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
    db.notifications = db.notifications.filter(n => !n.read || n.id > thirtyDaysAgo);
    db.messages = db.messages.filter(m => !m.read || m.id > thirtyDaysAgo);
    await IslamicBankSystem.save(db);
    showToast('‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

// ========== NOTIFICATIONS ==========
function toggleNotifications() {
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('show');
    if (panel.classList.contains('show')) loadNotifications();
}

async function loadNotifications() {
    const db = await IslamicBankSystem.load();
    const notifs = db.notifications.filter(n => n.userId === currentUser.id).sort((a,b) => b.id - a.id);
    const icons = { application:'fas fa-file-alt', message:'fas fa-comment', success:'fas fa-check-circle', error:'fas fa-exclamation-circle', registration:'fas fa-user-plus', info:'fas fa-info-circle' };
    const colors = { application:'var(--info)', message:'var(--success)', success:'var(--success)', error:'var(--danger)', registration:'var(--secondary)', info:'var(--primary)' };
    document.getElementById('notifications-list').innerHTML = notifs.length ? notifs.map(n => `
        <div class="notification-item ${n.read?'':'unread'}" onclick="openNotification(${n.id})">
            ${!n.read?'<div class="notification-dot"></div>':''}
            <div style="color:${colors[n.type]||'var(--primary)'};font-size:1.1rem;margin-top:2px;"><i class="${icons[n.type]||'fas fa-bell'}"></i></div>
            <div class="notification-content">
                <div class="notification-title">${n.title}</div>
                <div class="notification-message">${n.message}</div>
                <div class="notification-time">${n.timestamp}</div>
            </div>
        </div>`).join('') : '<div style="padding:35px;text-align:center;color:var(--gray);"><i class="fas fa-bell-slash" style="font-size:2rem;opacity:0.4;display:block;margin-bottom:10px;"></i>‡¶ï‡ßã‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</div>';
}

async function openNotification(notifId) {
    const db = await IslamicBankSystem.load();
    const notif = db.notifications.find(n => n.id == notifId);
    if (notif) {
        notif.read = true;
        await IslamicBankSystem.save(db);
        document.getElementById('notifications-panel').classList.remove('show');
        updateNotificationCount();
        if (notif.type === 'application') switchTab(currentUser.type==='admin'?'applications':'my-applications');
        else if (notif.type === 'message') switchTab(currentUser.type==='admin'?'chat-admin':'chat-user');
    }
}

async function markAllNotificationsRead() {
    const db = await IslamicBankSystem.load();
    db.notifications.filter(n => n.userId === currentUser.id).forEach(n => n.read = true);
    await IslamicBankSystem.save(db);
    updateNotificationCount();
    loadNotifications();
}

async function updateNotificationCount() {
    if (!currentUser) return;
    const db = await IslamicBankSystem.load();
    const count = db.notifications.filter(n => n.userId === currentUser.id && !n.read).length;
    const badge = document.getElementById('notification-badge');
    if (badge) { badge.textContent = count; count > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden'); }
}

// ========== CALCULATOR ==========
function calculateProfit() {
    const amount = parseFloat(document.getElementById('calc-amount').value);
    const rate = parseFloat(document.getElementById('calc-rate').value) / 100;
    const years = parseFloat(document.getElementById('calc-years').value);
    const type = document.getElementById('calc-type').value;
    const res = document.getElementById('calc-result');
    if (!amount || !rate || !years) { res.style.display = 'none'; return; }
    let total, profit;
    if (type === 'simple') { profit = amount * rate * years; total = amount + profit; }
    else { total = amount * Math.pow(1 + rate, years); profit = total - amount; }
    document.getElementById('calc-principal').textContent = '‡ß≥' + formatMoney(Math.round(amount));
    document.getElementById('calc-profit').textContent = '‡ß≥' + formatMoney(Math.round(profit));
    document.getElementById('calc-total').textContent = '‡ß≥' + formatMoney(Math.round(total));
    res.style.display = 'block';
}

// ========== MISC ==========
function closeModal() { document.getElementById('service-modal').classList.add('hidden'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', async () => {
    generateCaptcha();
    generateResetCaptcha();

    await loadJsonBinConfig();
    await IslamicBankSystem.load();

    const savedUser = sessionStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const u = JSON.parse(savedUser);
            const dbUser = IslamicBankSystem.findUser(u.id);
            if (dbUser && dbUser.status !== 'suspended') {
                currentUser = {...dbUser};
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        } catch(e) { sessionStorage.removeItem('currentUser'); }
    }

    setTimeout(() => {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.transition = 'opacity 0.5s';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.classList.add('hidden');
            if (currentUser) {
                loadDashboard();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
            }
        }, 500);
    }, 1800);

    document.addEventListener('click', e => {
        const panel = document.getElementById('notifications-panel');
        const btn = document.querySelector('.notification-btn');
        if (panel && panel.classList.contains('show') && !panel.contains(e.target) && btn && !btn.contains(e.target))
            panel.classList.remove('show');
        const sidebar = document.getElementById('sidebar');
        const mobileBtn = document.querySelector('.mobile-menu-btn');
        if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target) && mobileBtn && !mobileBtn.contains(e.target))
            sidebar.classList.remove('open');
    });
});

// Override window.storage to use localStorage (guaranteed to work offline)
if (!window.storage) {
    window.storage = {
        get: function(key, shared) {
            return new Promise(function(resolve, reject) {
                try {
                    var val = localStorage.getItem(key);
                    if (val !== null) {
                        resolve({key: key, value: val, shared: !!shared});
                    } else {
                        reject(new Error('Key not found: ' + key));
                    }
                } catch(e) { reject(e); }
            });
        },
        set: function(key, value, shared) {
            return new Promise(function(resolve, reject) {
                try {
                    localStorage.setItem(key, value);
                    resolve({key: key, value: value, shared: !!shared});
                } catch(e) { reject(e); }
            });
        }
    };
}
</script>

</body>
</html>        .fa-pie-chart::before { content: "üìä"; }
        .fa-line-chart::before { content: "üìà"; }
        .fa-area-chart::before { content: "üìä"; }
        
        /* Regular CSS */
        :root {
            --primary: #1a472a;
            --primary-dark: #0d2e1a;
            --primary-light: #e8f5e9;
            --secondary: #d4af37;
            --secondary-dark: #b8941f;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --white: #ffffff;
            --gray: #7f8c8d;
            --border: #bdc3c7;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-heavy: 0 10px 30px rgba(0,0,0,0.15);
            --radius: 10px;
            --radius-sm: 6px;
            --transition: all 0.3s ease;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI','SolaimanLipi',sans-serif; }
        body { background:linear-gradient(135deg,#f5f7fa 0%,#e4e8f0 100%); color:#2c3e50; min-height:100vh; line-height:1.6; }
        .hidden { display:none !important; }
        .flex { display:flex; } .flex-col { flex-direction:column; } .center { align-items:center; justify-content:center; }
        .between { justify-content:space-between; } .gap-10 { gap:10px; } .gap-15 { gap:15px; } .gap-20 { gap:20px; }
        .wrap { flex-wrap:wrap; } .text-center { text-align:center; } .w-100 { width:100%; }
        .mt-10 { margin-top:10px; } .mt-20 { margin-top:20px; } .mb-10 { margin-bottom:10px; } .mb-20 { margin-bottom:20px; }
        .p-20 { padding:20px; } .pointer { cursor:pointer; }
        .btn { padding:12px 24px; border:none; border-radius:var(--radius-sm); cursor:pointer; font-weight:600; transition:var(--transition); display:inline-flex; align-items:center; justify-content:center; gap:8px; font-size:0.95rem; }
        .btn-primary { background:var(--primary); color:var(--white); }
        .btn-primary:hover { background:var(--primary-dark); transform:translateY(-2px); box-shadow:0 5px 15px rgba(26,71,42,0.3); }
        .btn-secondary { background:var(--secondary); color:#333; }
        .btn-secondary:hover { background:var(--secondary-dark); transform:translateY(-2px); }
        .btn-outline { background:transparent; border:2px solid var(--primary); color:var(--primary); }
        .btn-outline:hover { background:var(--primary); color:var(--white); }
        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--danger); color:white; }
        .btn-info { background:var(--info); color:white; }
        .btn-sm { padding:8px 16px; font-size:0.85rem; }
        .btn-lg { padding:16px 32px; font-size:1.1rem; }
        .flex-1 { flex:1; }
        .card { background:var(--white); padding:24px; border-radius:var(--radius); box-shadow:var(--shadow); transition:var(--transition); }
        .card:hover { transform:translateY(-5px); box-shadow:var(--shadow-heavy); }

        /* AUTH */
        #auth-section { min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%); padding:20px; position:relative; overflow:hidden; }
        #auth-section::before { content:''; position:absolute; width:400px; height:400px; background:rgba(255,255,255,0.03); border-radius:50%; top:-100px; right:-100px; }
        #auth-section::after { content:''; position:absolute; width:300px; height:300px; background:rgba(255,255,255,0.03); border-radius:50%; bottom:-80px; left:-80px; }
        .auth-container { width:100%; max-width:480px; position:relative; z-index:1; }
        .auth-box { background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow-heavy); overflow:hidden; }
        .auth-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:var(--white); padding:30px; text-align:center; }
        .auth-logo { font-size:3rem; margin-bottom:10px; }
        .auth-body { padding:30px; }
        .form-group { margin-bottom:18px; }
        .form-group label { display:block; margin-bottom:7px; font-weight:600; color:var(--dark); font-size:0.93rem; }
        .form-control { width:100%; padding:12px 15px; border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.97rem; transition:var(--transition); }
        .form-control:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(26,71,42,0.1); }
        .form-row { display:flex; gap:15px; }
        .auth-footer { text-align:center; padding:18px; border-top:1px solid var(--border); background:var(--light); }
        .auth-link { color:var(--primary); cursor:pointer; font-weight:600; text-decoration:underline; }

        /* LOADING OVERLAY */
        #loading-overlay { position:fixed; inset:0; background:var(--primary-dark); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        #loading-overlay .logo { font-size:4rem; color:var(--secondary); margin-bottom:20px; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { transform:scale(1); opacity:1; } 50% { transform:scale(1.1); opacity:0.8; } }
        .loading-bar { width:200px; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; overflow:hidden; margin-top:20px; }
        .loading-bar-fill { height:100%; background:var(--secondary); border-radius:2px; animation:loadBar 1.8s ease forwards; }
        @keyframes loadBar { 0% { width:0%; } 100% { width:100%; } }

        /* DASHBOARD */
        .app-container { display:flex; min-height:100vh; }
        .sidebar { width:280px; background:var(--white); border-right:1px solid var(--border); display:flex; flex-direction:column; transition:var(--transition); box-shadow:2px 0 10px rgba(0,0,0,0.05); z-index:1000; }
        .sidebar-header { padding:25px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:var(--white); text-align:center; }
        .sidebar-logo { font-size:2.2rem; margin-bottom:8px; }
        .sidebar-menu { flex:1; padding:15px 0; overflow-y:auto; }
        .menu-section { padding:5px 25px 3px; font-size:0.75rem; color:var(--gray); text-transform:uppercase; letter-spacing:1px; margin-top:10px; }
        .menu-item { padding:12px 25px; cursor:pointer; display:flex; align-items:center; gap:12px; color:var(--dark); transition:var(--transition); border-left:4px solid transparent; margin:2px 0; position:relative; }
        .menu-item:hover, .menu-item.active { background:var(--primary-light); color:var(--primary); border-left:4px solid var(--primary); }
        .menu-item i { font-size:1rem; width:22px; text-align:center; }
        .badge { background:var(--danger); color:white; padding:2px 7px; border-radius:10px; font-size:0.72rem; margin-left:auto; min-width:18px; text-align:center; }
        .sidebar-footer { padding:18px; border-top:1px solid var(--border); background:var(--light); }
        .user-info { display:flex; align-items:center; gap:12px; }
        .user-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.1rem; flex-shrink:0; }
        .main-content { flex:1; overflow-y:auto; background:#f8f9fa; }
        .top-bar { background:var(--white); padding:16px 28px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:sticky; top:0; z-index:900; }
        .page-title { font-size:1.3rem; font-weight:700; color:var(--primary-dark); display:flex; align-items:center; gap:10px; }
        .top-actions { display:flex; align-items:center; gap:18px; position:relative; }
        .notification-btn { position:relative; cursor:pointer; font-size:1.3rem; color:var(--gray); padding:8px; border-radius:50%; transition:var(--transition); }
        .notification-btn:hover { background:var(--primary-light); color:var(--primary); }
        .notification-badge { position:absolute; top:0; right:0; background:var(--danger); color:white; font-size:0.68rem; padding:2px 5px; border-radius:50%; min-width:17px; text-align:center; }
        .sync-indicator { font-size:0.78rem; color:var(--success); display:flex; align-items:center; gap:5px; transition:var(--transition); }

        /* STATS */
        .dashboard-content { padding:25px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; margin-bottom:28px; }
        .stat-card { background:var(--white); padding:22px; border-radius:var(--radius); box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; border-left:5px solid var(--primary); transition:var(--transition); }
        .stat-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-heavy); }
        .stat-card.success { border-left-color:var(--success); }
        .stat-card.warning { border-left-color:var(--warning); }
        .stat-card.info { border-left-color:var(--info); }
        .stat-card.secondary { border-left-color:var(--secondary); }
        .stat-info h3 { font-size:1.8rem; color:var(--primary); margin-bottom:4px; }
        .stat-info p { color:var(--gray); font-size:0.88rem; }
        .stat-icon { font-size:2.3rem; color:var(--primary); opacity:0.6; }

        /* SERVICES */
        .services-container { padding:25px; }
        .services-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(290px,1fr)); gap:22px; margin-top:20px; }
        .service-card { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transition:var(--transition); border-top:4px solid var(--secondary); display:flex; flex-direction:column; }
        .service-card:hover { transform:translateY(-7px); box-shadow:var(--shadow-heavy); }
        .service-icon { padding:22px; text-align:center; font-size:2.8rem; color:var(--secondary); background:linear-gradient(135deg,#fff9e6,#fff3cc); }
        .service-body { padding:22px; flex:1; display:flex; flex-direction:column; }
        .service-title { font-size:1.2rem; font-weight:700; color:var(--primary-dark); margin-bottom:8px; }
        .service-desc { color:var(--gray); margin-bottom:14px; flex:1; line-height:1.6; font-size:0.93rem; }
        .service-features { margin-bottom:18px; }
        .feature-item { display:flex; align-items:center; gap:7px; margin-bottom:7px; font-size:0.88rem; }
        .feature-item i { color:var(--success); font-size:0.8rem; }
        .service-meta { display:flex; justify-content:space-between; background:var(--primary-light); border-radius:var(--radius-sm); padding:10px 14px; margin-bottom:14px; font-size:0.85rem; }

        /* TABLE */
        .table-container { padding:25px; }
        .table-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; flex-wrap:wrap; gap:12px; }
        .table-responsive { background:var(--white); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); margin-top:15px; overflow-x:auto; }
        table { width:100%; border-collapse:collapse; min-width:600px; }
        th,td { padding:14px 18px; text-align:left; border-bottom:1px solid var(--border); }
        th { background:var(--primary-light); color:var(--primary); font-weight:700; font-size:0.92rem; white-space:nowrap; }
        tr:hover { background:#f9f9f9; }
        .status-badge { padding:5px 11px; border-radius:20px; font-size:0.82rem; font-weight:600; display:inline-block; white-space:nowrap; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-approved { background:#d4edda; color:#155724; }
        .status-rejected { background:#f8d7da; color:#721c24; }
        .status-processing { background:#cce5ff; color:#004085; }
        .status-completed { background:#d1ecf1; color:#0c5460; }
        .action-buttons { display:flex; gap:7px; flex-wrap:wrap; }

        /* CHAT */
        .chat-container { display:flex; height:calc(100vh - 130px); padding:20px; gap:18px; }
        .chat-list { width:300px; background:var(--white); border-radius:var(--radius); overflow:hidden; display:flex; flex-direction:column; box-shadow:var(--shadow); }
        .chat-window { flex:1; background:var(--white); border-radius:var(--radius); display:flex; flex-direction:column; overflow:hidden; box-shadow:var(--shadow); }
        .chat-header { padding:18px 22px; border-bottom:1px solid var(--border); background:var(--primary-light); font-weight:700; color:var(--primary-dark); display:flex; align-items:center; gap:10px; }
        .chat-messages { flex:1; padding:22px; overflow-y:auto; background:#f8f9fa; display:flex; flex-direction:column; gap:14px; }
        .message { max-width:72%; padding:11px 16px; border-radius:18px; font-size:0.93rem; line-height:1.5; word-wrap:break-word; }
        .msg-sent { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:5px; }
        .msg-received { align-self:flex-start; background:var(--white); color:#333; border-bottom-left-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
        .message-time { font-size:0.73rem; opacity:0.7; margin-top:4px; text-align:right; }
        .chat-input-area { padding:18px; border-top:1px solid var(--border); background:var(--white); display:flex; gap:10px; }
        .chat-input { flex:1; padding:12px 18px; border:1px solid var(--border); border-radius:30px; outline:none; font-size:0.95rem; transition:var(--transition); }
        .chat-input:focus { border-color:var(--primary); }
        .chat-user-item { padding:14px 18px; cursor:pointer; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; transition:var(--transition); }
        .chat-user-item:hover, .chat-user-item.active { background:var(--primary-light); }

        /* MODAL */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px; }
        .modal { background:var(--white); border-radius:var(--radius); width:100%; max-width:700px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.3); animation:modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity:0; transform:translateY(-25px); } to { opacity:1; transform:translateY(0); } }
        .modal-header { padding:22px 28px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:white; z-index:1; }
        .modal-body { padding:28px; }

        /* NOTIFICATIONS */
        .notifications-panel { position:absolute; top:calc(100% + 10px); right:0; width:360px; background:var(--white); border-radius:var(--radius); box-shadow:var(--shadow-heavy); border:1px solid var(--border); z-index:1000; display:none; }
        .notifications-panel.show { display:block; animation:fadeInDown 0.25s; }
        @keyframes fadeInDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
        .notifications-header { padding:18px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .notifications-list { max-height:380px; overflow-y:auto; }
        .notification-item { padding:15px 18px; border-bottom:1px solid var(--border); cursor:pointer; transition:var(--transition); display:flex; gap:12px; align-items:flex-start; }
        .notification-item:hover { background:#f9f9f9; }
        .notification-item.unread { background:#f0f7ff; }
        .notification-dot { width:8px; height:8px; border-radius:50%; background:var(--danger); margin-top:7px; flex-shrink:0; }
        .notification-content { flex:1; }
        .notification-title { font-weight:600; color:var(--dark); margin-bottom:3px; font-size:0.92rem; }
        .notification-message { font-size:0.87rem; color:var(--gray); margin-bottom:3px; }
        .notification-time { font-size:0.78rem; color:var(--gray); }

        /* SPECIAL */
        .sharia-badge { background:linear-gradient(135deg,var(--success),#27ae60); color:white; padding:4px 11px; border-radius:20px; font-size:0.78rem; font-weight:600; display:inline-flex; align-items:center; gap:5px; }
        .welcome-banner { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:28px; border-radius:var(--radius); margin-bottom:22px; display:flex; justify-content:space-between; align-items:center; position:relative; overflow:hidden; }
        .welcome-banner::after { content:''; position:absolute; right:80px; font-size:8rem; opacity:0.05; font-family:'Font Awesome 6 Free'; font-weight:900; }
        .toast-container { position:fixed; bottom:20px; right:20px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .toast { background:var(--white); color:#333; padding:14px 20px; border-radius:var(--radius); box-shadow:var(--shadow-heavy); border-left:5px solid var(--primary); animation:slideInRight 0.3s ease; display:flex; align-items:center; gap:13px; max-width:340px; }
        .toast.success { border-left-color:var(--success); }
        .toast.error { border-left-color:var(--danger); }
        .toast.warning { border-left-color:var(--warning); }
        .toast.info { border-left-color:var(--info); }
        @keyframes slideInRight { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        .loading-spinner { display:inline-block; width:18px; height:18px; border:3px solid rgba(26,71,42,0.3); border-radius:50%; border-top-color:var(--primary); animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .mobile-menu-btn { display:none; font-size:1.5rem; cursor:pointer; color:var(--primary); padding:8px; border-radius:5px; }
        .mobile-menu-btn:hover { background:var(--primary-light); }

        /* PROFILE/ACCOUNT */
        .profile-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border-radius:var(--radius); padding:30px; color:white; display:flex; align-items:center; gap:25px; margin-bottom:25px; }
        .profile-avatar { width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.2); border:3px solid var(--secondary); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; }
        .info-grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
        .info-item { background:#f8f9fa; border-radius:var(--radius-sm); padding:14px; }
        .info-label { font-size:0.82rem; color:var(--gray); margin-bottom:4px; }
        .info-value { font-weight:600; color:var(--dark); }

        /* CHARTS/REPORTS */
        .chart-bar { height:24px; border-radius:12px; background:linear-gradient(90deg,var(--primary),var(--secondary)); transition:width 1s ease; }
        .progress-bar { background:#eee; border-radius:12px; overflow:hidden; margin-bottom:8px; }

        /* FILTER BAR */
        .filter-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
        .filter-btn { padding:8px 16px; border:2px solid var(--border); background:white; border-radius:20px; cursor:pointer; font-size:0.88rem; transition:var(--transition); }
        .filter-btn:hover, .filter-btn.active { border-color:var(--primary); background:var(--primary); color:white; }

        /* TIMELINE */
        .timeline { position:relative; padding-left:25px; }
        .timeline::before { content:''; position:absolute; left:8px; top:0; bottom:0; width:2px; background:var(--border); }
        .timeline-item { position:relative; margin-bottom:20px; }
        .timeline-dot { position:absolute; left:-21px; width:14px; height:14px; border-radius:50%; background:var(--primary); border:2px solid white; box-shadow:0 0 0 2px var(--primary); top:4px; }
        .timeline-dot.success { background:var(--success); box-shadow:0 0 0 2px var(--success); }
        .timeline-dot.warning { background:var(--warning); box-shadow:0 0 0 2px var(--warning); }
        .timeline-dot.danger { background:var(--danger); box-shadow:0 0 0 2px var(--danger); }
        .timeline-content { background:white; padding:14px 18px; border-radius:var(--radius-sm); box-shadow:var(--shadow); }

        /* CALCULATOR */
        .calc-result { background:linear-gradient(135deg,var(--primary-light),#e8f5e9); border-radius:var(--radius); padding:20px; margin-top:20px; }

        /* RESPONSIVE */
        @media (max-width:768px) {
            .sidebar { position:fixed; left:-280px; height:100%; box-shadow:2px 0 15px rgba(0,0,0,0.2); }
            .sidebar.open { left:0; }
            .mobile-menu-btn { display:block; }
            .chat-container { flex-direction:column; height:auto; }
            .chat-list { width:100%; height:250px; }
            .chat-window { height:450px; }
            .services-grid { grid-template-columns:1fr; }
            .stats-grid { grid-template-columns:1fr; }
            .form-row { flex-direction:column; gap:0; }
            .welcome-banner { flex-direction:column; text-align:center; gap:18px; }
            .info-grid { grid-template-columns:1fr; }
            .table-header { flex-direction:column; align-items:flex-start; }
        }

        /* PWA Install Banner */
        #pwa-banner { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg,#1a472a,#0d2e1a); color:white; padding:12px 20px; border-radius:50px; display:flex; align-items:center; gap:10px; z-index:99999; box-shadow:0 8px 25px rgba(0,0,0,0.4); animation:slideUp 0.5s ease; cursor:pointer; white-space:nowrap; }
        @keyframes slideUp { from { transform:translateX(-50%) translateY(100px); opacity:0; } to { transform:translateX(-50%) translateY(0); opacity:1; } }
        
        /* JSONBin Status */
        .jsonbin-status { display:flex; align-items:center; gap:8px; font-size:0.8rem; padding:5px 12px; border-radius:20px; background:var(--primary-light); color:var(--primary); cursor:pointer; }
        .jsonbin-status.online { background:#d4edda; color:#155724; }
        .jsonbin-status.offline { background:#f8d7da; color:#721c24; }
        .jsonbin-status.syncing { background:#fff3cd; color:#856404; }
    </style>
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<!-- LOADING -->
<div id="loading-overlay">
    <div class="logo"><i class="fas fa-mosque"></i></div>
    <h2 style="color:white;margin-bottom:5px;">‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ‡¶π‡ßç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶É</h2>
    <p style="color:rgba(255,255,255,0.6);font-size:0.9rem;">‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶¶ ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
    <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- AUTH -->
<section id="auth-section" class="hidden">
    <div class="auth-container">
        <!-- LOGIN -->
        <div id="login-form" class="auth-box">
            <div class="auth-header">
                <div class="auth-logo"><i class="fas fa-mosque"></i></div>
                <h2>‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ‡¶π‡ßç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶≤‡¶ø‡¶É</h2>
                <p>‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶¶ ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ</p>
            </div>
            <div class="auth-body">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø / NID / ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                    <input type="text" id="login-userid" class="form-control" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                    <div style="position:relative;">
                        <input type="password" id="login-password" class="form-control" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" style="padding-right:45px;">
                        <i class="fas fa-eye" onclick="togglePasswordVisibility('login-password',this)" style="position:absolute;right:14px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--gray);"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-shield-alt"></i> ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶°</label>
                    <div class="form-row">
                        <input type="text" id="login-captcha" class="form-control" placeholder="‡¶ï‡ßã‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                        <div id="captcha-code" onclick="generateCaptcha()" class="form-control" style="background:#f8f9fa;font-family:monospace;font-size:1.3rem;letter-spacing:4px;text-align:center;cursor:pointer;color:var(--primary-dark);font-weight:bold;">A3B7</div>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt"></i> ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <div style="text-align:center;margin-top:15px;">
                    <span class="auth-link" onclick="showForgotPassword()">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span>
                </div>
            </div>
            <div class="auth-footer">
                <p>‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <span class="auth-link" onclick="showRegisterForm()">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
            </div>
        </div>

        <!-- REGISTER -->
        <div id="register-form" class="auth-box hidden">
            <div class="auth-header">
                <div class="auth-logo"><i class="fas fa-user-plus"></i></div>
                <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</h2>
                <p>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
            <div class="auth-body">
                <div class="form-row">
                    <div class="form-group" style="flex:2;">
                        <label><i class="fas fa-user"></i> ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="reg-name" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label><i class="fas fa-user-tag"></i> ‡¶â‡¶™‡¶æ‡¶ß‡¶ø</label>
                        <select id="reg-title" class="form-control">
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                            <option value="‡¶ú‡¶®‡¶æ‡¶¨">‡¶ú‡¶®‡¶æ‡¶¨</option>
                            <option value="‡¶ú‡¶®‡¶æ‡¶¨‡¶æ">‡¶ú‡¶®‡¶æ‡¶¨‡¶æ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> ‡¶ú‡¶æ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º‡¶™‡¶§‡ßç‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (NID)</label>
                    <input type="text" id="reg-nid" class="form-control" placeholder="‡ßß‡ß¶ ‡¶¨‡¶æ ‡ßß‡ß≠ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                        <input type="email" id="reg-email" class="form-control" placeholder="example@email.com">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</label>
                        <input type="tel" id="reg-phone" class="form-control" placeholder="‡ß¶‡ßßXXXXXXXXX">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-tag"></i> ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                    <select id="reg-type" class="form-control">
                        <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                        <option value="personal">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º</option>
                        <option value="business">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</option>
                        <option value="corporate">‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</option>
                        <option value="student">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                        <input type="password" id="reg-password" class="form-control" placeholder="‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" onkeyup="checkPasswordStrength(this.value)">
                        <div style="margin-top:5px;height:4px;background:#eee;border-radius:2px;overflow:hidden;">
                            <div id="password-strength-bar" style="height:100%;width:0%;background:#e74c3c;transition:width 0.3s;"></div>
                        </div>
                        <small style="color:var(--gray);font-size:0.78rem;">‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞, ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ì ‡¶¨‡¶°‡¶º ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞</small>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§</label>
                        <input type="password" id="reg-confirm-password" class="form-control" placeholder="‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="reg-dob" class="form-control">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-industry"></i> ‡¶™‡ßá‡¶∂‡¶æ</label>
                        <select id="reg-occupation" class="form-control">
                            <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                            <option value="‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø">‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø</option>
                            <option value="‡¶¨‡ßá‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø">‡¶¨‡ßá‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶ï‡¶∞‡¶ø</option>
                            <option value="‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ</option>
                            <option value="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</option>
                            <option value="‡¶ó‡ßÉ‡¶π‡¶ø‡¶£‡ßÄ">‡¶ó‡ßÉ‡¶π‡¶ø‡¶£‡ßÄ</option>
                            <option value="‡¶Ö‡¶¨‡¶∏‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§">‡¶Ö‡¶¨‡¶∏‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label>
                    <textarea id="reg-address" class="form-control" rows="2" placeholder="‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ"></textarea>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                    <input type="number" id="reg-income" class="form-control" placeholder="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º" min="0">
                </div>
                <div class="form-group">
                    <div style="display:flex;align-items:flex-start;gap:10px;">
                        <input type="checkbox" id="reg-terms" style="margin-top:3px;">
                        <label for="reg-terms" style="font-size:0.9rem;margin:0;">
                            ‡¶Ü‡¶Æ‡¶ø <span class="auth-link" onclick="showTermsModal()">‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</span> ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶®‡ßá ‡¶ö‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§
                        </label>
                    </div>
                </div>
                <button class="btn btn-secondary w-100" onclick="handleRegister()">
                    <i class="fas fa-user-plus"></i> ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            <div class="auth-footer">
                <p>‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <span class="auth-link" onclick="showLoginForm()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></p>
            </div>
        </div>
    </div>
</section>

<!-- MAIN APP -->
<section id="app-section" class="app-container hidden">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><i class="fas fa-mosque"></i></div>
            <h3>‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</h3>
            <p style="font-size:0.82rem;opacity:0.8;">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç</p>
        </div>
        <div class="sidebar-menu" id="menu-container"></div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">‡¶Ü</div>
                <div style="flex:1;min-width:0;">
                    <div id="sidebar-username" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                    <div id="sidebar-usertype" style="font-size:0.82rem;color:var(--gray);">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</div>
                </div>
            </div>
            <button class="btn btn-outline w-100 mt-10" onclick="logout()" style="font-size:0.88rem;padding:9px;">
                <i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
            </button>
        </div>
    </nav>
    <main class="main-content">
        <div class="top-bar">
            <div class="flex center gap-15">
                <div class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
                <div class="page-title" id="page-title"><i class="fas fa-home"></i> <span>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</span></div>
            </div>
            <div class="top-actions">
                <div class="sync-indicator hidden" id="sync-indicator"><i class="fas fa-cloud-upload-alt"></i> <span>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</span></div>
                <div class="jsonbin-status" id="jsonbin-status" onclick="showJsonBinSettings()" title="JSONBin.io ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏">
                    <i class="fas fa-database"></i> <span id="jsonbin-status-text">‡¶≤‡ßã‡¶ï‡¶æ‡¶≤</span>
                </div>
                <div class="notification-btn" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge hidden" id="notification-badge">0</span>
                </div>
                <div class="notifications-panel" id="notifications-panel">
                    <div class="notifications-header">
                        <h4><i class="fas fa-bell"></i> ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h4>
                        <span class="auth-link" onclick="markAllNotificationsRead()" style="font-size:0.85rem;">‡¶∏‡¶¨ ‡¶™‡¶°‡¶º‡¶æ</span>
                    </div>
                    <div class="notifications-list" id="notifications-list"></div>
                </div>
            </div>
        </div>
        <div id="content-area"></div>
    </main>
</section>

<!-- MODALS -->
<div id="service-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div id="sharia-advice-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:780px;">
        <div class="modal-header">
            <h3><i class="fas fa-hands-helping"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞</h3>
            <button onclick="closeShariaAdviceModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;height:480px;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);">
                <div class="chat-header"><i class="fas fa-user-tie"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶® <span style="margin-left:auto;font-size:0.78rem;font-weight:400;opacity:0.7;">AI ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂</span></div>
                <div class="chat-messages" id="sharia-chat-messages">
                    <div class="message msg-received">
                        <div>‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶∞‡¶æ‡¶π‡¶Æ‡¶æ‡¶§‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                        <div class="message-time">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="sharia-chat-input" class="chat-input" placeholder="‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter')sendShariaMessage()">
                    <button class="btn btn-primary" onclick="sendShariaMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="terms-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:780px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-contract"></i> ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</h3>
            <button onclick="closeTermsModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div style="max-height:420px;overflow-y:auto;padding-right:8px;">
                <div style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;margin-bottom:20px;">
                    <h4 style="color:var(--primary-dark);">üïå ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ</h4>
                </div>
                <p>‡ßß. ‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡ßá‡•§</p>
                <p>‡ß®. ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§‡•§</p>
                <p>‡ß©. ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá ‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ (‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨) ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£‡•§</p>
                <p>‡ß™. ‡¶ã‡¶£‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ (‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£) ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§</p>
                <h4 style="margin-top:20px;color:var(--primary-dark);">üîê ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</h4>
                <p>‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶®‡ßç‡¶°-‡¶ü‡ßÅ-‡¶è‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶°‡•§</p>
                <p>‡ß®. ‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶ï‡¶ñ‡¶®‡ßã ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
                <p>‡ß©. ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
                <p>‡ß™. ‡¶∏‡¶ï‡¶≤ ‡¶≤‡¶ó ‡¶§‡¶•‡ßç‡¶Ø ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞ ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
                <h4 style="margin-top:20px;color:var(--primary-dark);">üìã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨</h4>
                <p>‡ßß. ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ì ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
                <p>‡ß®. ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
                <p>‡ß©. ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶¨‡ßà‡¶ß ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§</p>
                <div class="text-center mt-20">
                    <button class="btn btn-primary" onclick="closeTermsModal()"><i class="fas fa-check"></i> ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø ‡¶ì ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="calc-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header">
            <h3><i class="fas fa-calculator"></i> ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h3>
            <button onclick="document.getElementById('calc-modal').classList.add('hidden')" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                <input type="number" id="calc-amount" class="form-control" placeholder="‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" oninput="calculateProfit()">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞ (%)</label>
                    <input type="number" id="calc-rate" class="form-control" value="8" step="0.5" oninput="calculateProfit()">
                </div>
                <div class="form-group">
                    <label>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ (‡¶¨‡¶õ‡¶∞)</label>
                    <input type="number" id="calc-years" class="form-control" value="3" min="1" max="30" oninput="calculateProfit()">
                </div>
            </div>
            <div class="form-group">
                <label>‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                <select id="calc-type" class="form-control" onchange="calculateProfit()">
                    <option value="simple">‡¶∏‡¶∞‡¶≤ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ (‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ)</option>
                    <option value="compound">‡¶ö‡¶ï‡ßç‡¶∞‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ (‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ)</option>
                </select>
            </div>
            <div class="calc-result" id="calc-result" style="display:none;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--primary);" id="calc-principal">‡ß≥‡ß¶</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--success);" id="calc-profit">‡ß≥‡ß¶</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:0.85rem;color:var(--gray);">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</div>
                        <div style="font-size:1.4rem;font-weight:700;color:var(--secondary);" id="calc-total">‡ß≥‡ß¶</div>
                    </div>
                </div>
                <div style="margin-top:15px;font-size:0.85rem;color:var(--gray);text-align:center;">
                    <i class="fas fa-info-circle"></i> ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡•§ ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶∂‡ßÄ‡¶≤‡•§
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JSONBin Settings Modal -->
<div id="jsonbin-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header">
            <h3><i class="fas fa-database"></i> JSONBin.io ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <button onclick="closeJsonBinModal()" class="btn btn-sm btn-outline"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:15px;color:var(--gray);">JSONBin.io ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <div class="form-group">
                <label><i class="fas fa-key"></i> API ‡¶ï‡ßÄ (Master Key)</label>
                <input type="password" id="jsonbin-api-key" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSONBin API ‡¶ï‡ßÄ">
                <small style="color:var(--gray);font-size:0.75rem;">$2a$10$... ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá</small>
            </div>
            <div class="form-group">
                <label><i class="fas fa-folder"></i> ‡¶¨‡¶ø‡¶® ID</label>
                <input type="text" id="jsonbin-bin-id" class="form-control" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSONBin ‡¶¨‡¶ø‡¶® ID">
                <small style="color:var(--gray);font-size:0.75rem;">‡ß¨‡ß™‡ß´... ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá</small>
            </div>
            <div class="form-row" style="gap:10px;">
                <button class="btn btn-success flex-1" onclick="testJsonBinConnection()"><i class="fas fa-plug"></i> ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
                <button class="btn btn-info flex-1" onclick="syncToJsonBin()"><i class="fas fa-cloud-upload-alt"></i> ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
            </div>
            <div class="form-row" style="gap:10px;margin-top:10px;">
                <button class="btn btn-primary flex-1" onclick="syncFromJsonBin()"><i class="fas fa-cloud-download-alt"></i> ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-warning flex-1" onclick="disableJsonBin()"><i class="fas fa-ban"></i> ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</button>
            </div>
            <div id="jsonbin-test-result" style="margin-top:15px;font-size:0.9rem;text-align:center;"></div>
        </div>
    </div>
</div>
</script>
    <script>
// ========== JSONBin ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶π ==========
const JSONBIN_CONFIG = {
    apiKey: "$2a$10$nQcUsm.IExsgjr6WgFnRLO5zyNueZqIbQsX3DrYCuGCZ87JiXGzGa",
    binId: "6997655bd0ea881f40c7b5b7",
    accountId: "699763851a35bc0895802c88",
    enabled: true
};

// JSONBin ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°)
async function loadJsonBinConfig() {
    try {
        // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶°
        const config = localStorage.getItem(JSONBIN_CONFIG_KEY);
        if (config) {
            jsonBinConfig = JSON.parse(config);
        } else {
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
            jsonBinConfig = {
                apiKey: JSONBIN_CONFIG.apiKey,
                binId: JSONBIN_CONFIG.binId,
                enabled: JSONBIN_CONFIG.enabled
            };
            // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
            localStorage.setItem(JSONBIN_CONFIG_KEY, JSON.stringify(jsonBinConfig));
        }
        updateJsonBinStatus();
    } catch(e) {
        console.warn('Failed to load JSONBin config', e);
        jsonBinConfig = {
            apiKey: JSONBIN_CONFIG.apiKey,
            binId: JSONBIN_CONFIG.binId,
            enabled: JSONBIN_CONFIG.enabled
        };
    }
}

// JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°)
async function testJsonBinConnection() {
    const apiKey = document.getElementById('jsonbin-api-key')?.value || jsonBinConfig.apiKey;
    const binId = document.getElementById('jsonbin-bin-id')?.value || jsonBinConfig.binId;
    const resultEl = document.getElementById('jsonbin-test-result');
    
    if (!apiKey || !binId) {
        if (resultEl) resultEl.innerHTML = '<span style="color:var(--danger);">API ‡¶ï‡ßÄ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶® ID ‡¶¶‡¶ø‡¶®</span>';
        return;
    }
    
    if (resultEl) resultEl.innerHTML = '<span style="color:var(--info);">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: 'GET',
            headers: {
                'X-Master-Key': apiKey
            }
        });
        
        if (response.ok) {
            if (resultEl) resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶´‡¶≤!</span>';
            jsonBinConfig.apiKey = apiKey;
            jsonBinConfig.binId = binId;
            jsonBinConfig.enabled = true;
            saveJsonBinConfig();
            showToast('JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } else {
            if (resultEl) resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        if (resultEl) resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}
// ========== STATE ==========
let currentUser = null;
let activeChatWith = null;
let captchaValue = '';
let dbCache = null;
let jsonBinConfig = { apiKey: '', binId: '', enabled: false };

// ========== PERSISTENT STORAGE ==========
const DB_KEY = 'nur_islamic_bank_v3';
const JSONBIN_CONFIG_KEY = 'nur_jsonbin_config';

// Storage functions with JSONBin fallback
async function storageGet(key) {
    // Try localStorage first
    try {
        return localStorage.getItem(key);
    } catch(e) {
        console.warn('localStorage read failed', e);
        return null;
    }
}

async function storageSet(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch(e) {
        console.warn('localStorage write failed', e);
        return false;
    }
}

// JSONBin.io functions
async function loadJsonBinConfig() {
    try {
        const config = localStorage.getItem(JSONBIN_CONFIG_KEY);
        if (config) {
            jsonBinConfig = JSON.parse(config);
        }
        updateJsonBinStatus();
    } catch(e) {
        console.warn('Failed to load JSONBin config', e);
    }
}

async function saveJsonBinConfig() {
    try {
        localStorage.setItem(JSONBIN_CONFIG_KEY, JSON.stringify(jsonBinConfig));
        updateJsonBinStatus();
    } catch(e) {
        console.warn('Failed to save JSONBin config', e);
    }
}

function updateJsonBinStatus() {
    const statusEl = document.getElementById('jsonbin-status');
    const statusText = document.getElementById('jsonbin-status-text');
    if (!statusEl || !statusText) return;
    
    if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
        statusEl.className = 'jsonbin-status online';
        statusText.textContent = 'JSONBin';
    } else {
        statusEl.className = 'jsonbin-status offline';
        statusText.textContent = '‡¶≤‡ßã‡¶ï‡¶æ‡¶≤';
    }
}

async function testJsonBinConnection() {
    const apiKey = document.getElementById('jsonbin-api-key').value.trim();
    const binId = document.getElementById('jsonbin-bin-id').value.trim();
    const resultEl = document.getElementById('jsonbin-test-result');
    
    if (!apiKey || !binId) {
        resultEl.innerHTML = '<span style="color:var(--danger);">API ‡¶ï‡ßÄ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶® ID ‡¶¶‡¶ø‡¶®</span>';
        return;
    }
    
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: 'GET',
            headers: {
                'X-Master-Key': apiKey
            }
        });
        
        if (response.ok) {
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶´‡¶≤!</span>';
            jsonBinConfig.apiKey = apiKey;
            jsonBinConfig.binId = binId;
            jsonBinConfig.enabled = true;
            saveJsonBinConfig();
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

async function syncToJsonBin() {
    if (!jsonBinConfig.enabled || !jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
        return;
    }
    
    const resultEl = document.getElementById('jsonbin-test-result');
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': jsonBinConfig.apiKey
            },
            body: JSON.stringify(dbCache || IslamicBankSystem.getDefaultData())
        });
        
        if (response.ok) {
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤!</span>';
            showToast('‡¶°‡ßá‡¶ü‡¶æ JSONBin-‡¶è ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

async function syncFromJsonBin() {
    if (!jsonBinConfig.enabled || !jsonBinConfig.apiKey || !jsonBinConfig.binId) {
        showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá JSONBin ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®', 'warning');
        return;
    }
    
    const resultEl = document.getElementById('jsonbin-test-result');
    resultEl.innerHTML = '<span style="color:var(--info);">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>';
    
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}/latest`, {
            method: 'GET',
            headers: {
                'X-Master-Key': jsonBinConfig.apiKey
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            dbCache = data.record || data;
            await IslamicBankSystem.save(dbCache);
            resultEl.innerHTML = '<span style="color:var(--success);">‚úì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤!</span>';
            showToast('‡¶°‡ßá‡¶ü‡¶æ JSONBin ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
            
            // Refresh current view if user is logged in
            if (currentUser) {
                const currentTab = document.querySelector('.menu-item.active')?.id?.replace('menu-', '') || 'dashboard';
                switchTab(currentTab);
            }
        } else {
            resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${response.status}</span>`;
        }
    } catch(e) {
        resultEl.innerHTML = `<span style="color:var(--danger);">‚úó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${e.message}</span>`;
    }
}

function disableJsonBin() {
    jsonBinConfig.enabled = false;
    jsonBinConfig.apiKey = '';
    jsonBinConfig.binId = '';
    saveJsonBinConfig();
    document.getElementById('jsonbin-test-result').innerHTML = '<span style="color:var(--info);">JSONBin ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</span>';
    document.getElementById('jsonbin-api-key').value = '';
    document.getElementById('jsonbin-bin-id').value = '';
    showToast('JSONBin ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'info');
}

function showJsonBinSettings() {
    document.getElementById('jsonbin-api-key').value = jsonBinConfig.apiKey || '';
    document.getElementById('jsonbin-bin-id').value = jsonBinConfig.binId || '';
    document.getElementById('jsonbin-test-result').innerHTML = '';
    document.getElementById('jsonbin-modal').classList.remove('hidden');
}

function closeJsonBinModal() {
    document.getElementById('jsonbin-modal').classList.add('hidden');
}

// ========== DATABASE ==========
const IslamicBankSystem = {
    getDefaultData() {
        return {
            version: 3,
            users: [
                { id:'admin', nid:'admin', password:'Admin@123', name:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', email:'admin@nurislamicbank.com', phone:'‡ß¶‡ßß‡ß¨‡ß®‡ß©‡ß≠', type:'admin', balance:0, joined:new Date().toLocaleDateString('bn-BD'), status:'active', address:'‡¶¨‡¶æ‡¶Ø‡¶º‡¶§‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶ï‡¶æ‡¶∞‡¶∞‡¶Æ, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', monthlyIncome:0, dob:'1990-01-01' },
                { id:'user_1001', nid:'1234567890123', password:'User@123', name:'‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Ü‡¶≤ ‡¶Æ‡¶æ‡¶Æ‡ßÅ‡¶®', email:'mamun@example.com', phone:'‡ß¶‡ßß‡ß≠‡ßß‡ßß‡ß®‡ß®‡ß©‡ß©‡ß™‡ß™', type:'personal', balance:50000, joined:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ßß-‡ßß‡ß´', status:'active', address:'‡¶Æ‡¶ø‡¶∞‡¶™‡ßÅ‡¶∞, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶∏‡¶´‡¶ü‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞', monthlyIncome:80000, dob:'1985-05-15' },
                { id:'user_1002', nid:'9876543210987', password:'User@456', name:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞', email:'fatema@example.com', phone:'‡ß¶‡ßß‡ßÆ‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ', type:'business', balance:150000, joined:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß©-‡ßß‡ß¶', status:'active', address:'‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ, ‡¶¢‡¶æ‡¶ï‡¶æ', occupation:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ', monthlyIncome:200000, dob:'1988-11-20' }
            ],
            services: [
                { id:'mudarabah_savings', name:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', description:'‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ‡•§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ì ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡¶æ‡¶∞‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶≠‡¶æ‡¶ó‡¶æ‡¶≠‡¶æ‡¶ó‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá‡•§', type:'savings', category:'‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', minAmount:1000, maxAmount:10000000, profitRate:'‡ß≠-‡ßØ%', duration:'‡ßß-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≤‡¶æ‡¶≠','‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ','‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®','‡¶ï‡¶∞ ‡¶õ‡¶æ‡¶°‡¶º'], icon:'fas fa-piggy-bank' },
                { id:'musharakah_business', name:'‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', description:'‡¶Ø‡ßå‡¶• ‡¶Æ‡ßÇ‡¶≤‡¶ß‡¶®‡ßá ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡•§ ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:50000, maxAmount:50000000, profitRate:'‡ßß‡ß®-‡ßß‡ßÆ%', duration:'‡ß©-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶Ø‡ßå‡¶• ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶≠‡¶æ‡¶ó‡¶æ‡¶≠‡¶æ‡¶ó‡¶ø','‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü'], icon:'fas fa-handshake' },
                { id:'murabaha_home', name:'‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶π‡ßã‡¶Æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º-‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶π‡¶æ‡¶â‡¶ú‡¶ø‡¶Ç ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:500000, maxAmount:50000000, profitRate:'‡ßØ-‡ßß‡ß®%', duration:'‡ß´-‡ß®‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡¶ø‡¶Ç','‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡ßÄ ‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø','‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶¨‡ßÄ‡¶Æ‡¶æ','‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß'], icon:'fas fa-home' },
                { id:'ijarah_vehicle', name:'‡¶á‡¶ú‡¶æ‡¶∞‡¶æ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶≤‡¶ø‡¶ú‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:300000, maxAmount:5000000, profitRate:'‡ßß‡ß¶-‡ßß‡ß™%', duration:'‡ß©-‡ß≠ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≤‡¶ø‡¶ú‡¶ø‡¶Ç','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶Æ‡¶°‡ßá‡¶≤','‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ','‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ'], icon:'fas fa-car' },
                { id:'qard_hasan', name:'‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ (‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£)', description:'‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶ã‡¶£ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'loan', category:'‡¶ã‡¶£', minAmount:10000, maxAmount:500000, profitRate:'‡ß¶%', duration:'‡ß¨-‡ß®‡ß™ ‡¶Æ‡¶æ‡¶∏', features:['‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£','‡¶∏‡¶π‡¶ú ‡¶∂‡¶∞‡ßç‡¶§','‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£','‡¶®‡¶Æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶'], icon:'fas fa-hand-holding-heart' },
                { id:'wakala_investment', name:'‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡¶æ‡¶≤‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', description:'‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:100000, maxAmount:10000000, profitRate:'‡ßÆ-‡ßß‡ß´%', duration:'‡ß®-‡ß≠ ‡¶¨‡¶õ‡¶∞', features:['‡¶™‡ßá‡¶∂‡¶æ‡¶¶‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶´‡ßã‡¶≤‡¶ø‡¶ì','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü','‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ'], icon:'fas fa-chart-line' },
                { id:'sukuk_bond', name:'‡¶∏‡ßÅ‡¶ï‡ßÅ‡¶ï ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡¶®‡ßç‡¶°', description:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡¶®‡ßç‡¶°‡•§', type:'investment', category:'‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', minAmount:50000, maxAmount:10000000, profitRate:'‡ßØ-‡ßß‡ßß%', duration:'‡ß©-‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡¶Æ‡ßç‡¶™‡¶¶ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶°','‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶Ü‡¶Ø‡¶º','‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ','‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡¶ú‡¶æ‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø'], icon:'fas fa-file-contract' },
                { id:'takaful_insurance', name:'‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ', description:'‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'insurance', category:'‡¶¨‡ßÄ‡¶Æ‡¶æ', minAmount:5000, maxAmount:1000000, profitRate:'‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤', duration:'‡ßß-‡ß®‡ß¶ ‡¶¨‡¶õ‡¶∞', features:['‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ','‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§','‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶ï‡¶≠‡¶æ‡¶∞‡ßá‡¶ú','‡¶≤‡¶æ‡¶≠ ‡¶¨‡¶£‡ßç‡¶ü‡¶®'], icon:'fas fa-shield-alt' },
                { id:'hajj_savings', name:'‡¶π‡¶ú ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ', description:'‡¶π‡¶ú ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ‡•§', type:'savings', category:'‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', minAmount:5000, maxAmount:500000, profitRate:'‡ß´-‡ß≠%', duration:'‡ßß-‡ß´ ‡¶¨‡¶õ‡¶∞', features:['‡¶π‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º','‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§','‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®','‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏'], icon:'fas fa-kaaba' },
                { id:'education_finance', name:'‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', description:'‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡•§', type:'finance', category:'‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', minAmount:20000, maxAmount:1000000, profitRate:'‡ß´-‡ßÆ%', duration:'‡ßß-‡ß´ ‡¶¨‡¶õ‡¶∞', features:['‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶ã‡¶£','‡¶®‡¶Æ‡¶®‡ßÄ‡¶Ø‡¶º ‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø','‡¶¨‡¶ø‡¶®‡¶æ ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶®‡¶§','‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£'], icon:'fas fa-graduation-cap' }
            ],
            applications: [
                { id:1001, userId:'user_1001', userName:'‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Ü‡¶≤ ‡¶Æ‡¶æ‡¶Æ‡ßÅ‡¶®', userType:'personal', serviceId:'mudarabah_savings', serviceName:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', amount:50000, duration:'‡ß© ‡¶¨‡¶õ‡¶∞', purpose:'‡¶¨‡¶æ‡¶°‡¶º‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶Æ‡¶æ‡¶£‡ßá‡¶∞ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º', status:'approved', appliedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß¶', approvedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß´', approvedBy:'‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', shariaReview:true, reviewComment:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§' },
                { id:1002, userId:'user_1002', userName:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞', userType:'business', serviceId:'musharakah_business', serviceName:'‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó', amount:200000, duration:'‡ß´ ‡¶¨‡¶õ‡¶∞', purpose:'‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ', status:'pending', appliedDate:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´', shariaReview:false }
            ],
            transactions: [
                { id:5001, userId:'user_1001', type:'deposit', amount:50000, description:'‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', date:new Date().toLocaleString('bn-BD'), status:'completed', balance:50000 },
                { id:5002, userId:'user_1002', type:'deposit', amount:150000, description:'‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§', date:new Date().toLocaleString('bn-BD'), status:'completed', balance:150000 }
            ],
            messages: [
                { id:2001, from:'user_1001', to:'admin', text:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º‡ßá‡¶∞ ‡¶≤‡¶æ‡¶≠ ‡¶ï‡¶ñ‡¶® ‡¶™‡¶æ‡¶¨‡ßã?', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß® ‡ßß‡ß¶:‡ßß‡ß´', read:true },
                { id:2002, from:'admin', to:'user_1001', text:'‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡ßß‡ß¶ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡•§', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß®-‡ßß‡ß® ‡ßß‡ß¶:‡ß©‡ß¶', read:true },
                { id:2003, from:'user_1002', to:'admin', text:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ï‡ßÄ?', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß¨ ‡ßß‡ß™:‡ß®‡ß¶', read:false }
            ],
            notifications: [
                { id:3001, userId:'admin', title:'‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', message:'‡¶´‡¶æ‡¶§‡ßá‡¶Æ‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®', type:'application', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´ ‡ßß‡ßß:‡ß©‡ß¶', read:false },
                { id:3002, userId:'user_1002', title:'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ', message:'‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', type:'success', timestamp:'‡ß®‡ß¶‡ß®‡ß©-‡ß¶‡ß™-‡ß¶‡ß´ ‡ßß‡ßß:‡ß©‡ß¶', read:false }
            ],
            settings: { 
                bankName:'‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', 
                supportEmail:'support@nurislamicbank.com', 
                contactNumber:'‡ßß‡ß¨‡ß®‡ß©‡ß≠', 
                address:'‡¶¨‡¶æ‡¶Ø‡¶º‡¶§‡ßÅ‡¶≤ ‡¶Æ‡ßã‡¶ï‡¶æ‡¶∞‡¶∞‡¶Æ, ‡¶¢‡¶æ‡¶ï‡¶æ', 
                workingHours:'‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞-‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßØ‡¶ü‡¶æ - ‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß´‡¶ü‡¶æ', 
                prayerBreak:'‡¶ú‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø: ‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞ ‡ßß‡ß®:‡ß©‡ß¶ - ‡ß®:‡ß©‡ß¶',
                enableCaptcha: true,
                enable2FA: false,
                enableLogging: true,
                sessionTimeout: 30,
                maxLoginAttempts: 5
            }
        };
    },

    async load() {
        if (dbCache) return dbCache;
        
        // Try localStorage first
        const data = await storageGet(DB_KEY);
        if (data) {
            try { 
                dbCache = JSON.parse(data); 
                return dbCache; 
            } catch(e) {}
        }
        
        // If JSONBin is enabled, try to load from there
        if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': jsonBinConfig.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    dbCache = data.record || data;
                    await this.save(dbCache);
                    return dbCache;
                }
            } catch(e) {
                console.warn('Failed to load from JSONBin', e);
            }
        }
        
        // Fallback to default
        dbCache = this.getDefaultData();
        await this.save(dbCache);
        return dbCache;
    },

    async save(data) {
        dbCache = data;
        const ok = await storageSet(DB_KEY, JSON.stringify(data));
        if (ok) showSyncIndicator();
        
        // If JSONBin is enabled, sync in background
        if (jsonBinConfig.enabled && jsonBinConfig.apiKey && jsonBinConfig.binId) {
            this.syncToJsonBinBackground(data);
        }
        
        return ok;
    },
    
    async syncToJsonBinBackground(data) {
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': jsonBinConfig.apiKey
                },
                body: JSON.stringify(data)
            });
        } catch(e) {
            console.warn('Background JSONBin sync failed', e);
        }
    },

    findUser(identifier, password = null) {
        if (!dbCache) return null;
        const u = dbCache.users.find(u =>
            (u.id === identifier || u.nid === identifier || u.email === identifier)
        );
        if (!u) return null;
        if (password && u.password !== password) return null;
        return u;
    },

    async addNotification(userId, title, message, type = 'info') {
        const db = await this.load();
        const notif = { id:Date.now(), userId, title, message, type, timestamp:new Date().toLocaleString('bn-BD'), read:false };
        db.notifications.push(notif);
        await this.save(db);
        if (currentUser && currentUser.id === userId) updateNotificationCount();
        return notif;
    },

    async addApplication(app) {
        const db = await this.load();
        app.id = Date.now();
        app.status = 'pending';
        app.appliedDate = new Date().toLocaleString('bn-BD');
        db.applications.push(app);
        await this.save(db);
        await this.addNotification('admin','‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®',`${app.userName} - ${app.serviceName}`,'application');
        await this.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'success');
        return app;
    },

    async addMessage(from, to, text) {
        const db = await this.load();
        const msg = { id:Date.now(), from, to, text, timestamp:new Date().toLocaleString('bn-BD'), read:false };
        db.messages.push(msg);
        await this.save(db);
        if (to !== from) {
            const fromUser = this.findUser(from);
            await this.addNotification(to,'‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ',`${fromUser?.name||'‡¶ï‡ßá‡¶â'} ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®`,'message');
        }
        return msg;
    },

    async addTransaction(txn) {
        const db = await this.load();
        txn.id = Date.now();
        txn.date = new Date().toLocaleString('bn-BD');
        txn.status = txn.status || 'completed';
        const user = db.users.find(u => u.id === txn.userId);
        txn.balance = user ? (user.balance || 0) : 0;
        db.transactions.push(txn);
        await this.save(db);
        return txn;
    }
};

// ========== UTILS ==========
function formatMoney(n) {
    return Number(n||0).toLocaleString('bn-BD');
}
function getUserTypeText(t) {
    return { personal:'‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§', business:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡ßÄ', corporate:'‡¶ï‡¶∞‡ßç‡¶™‡ßã‡¶∞‡ßá‡¶ü', student:'‡¶õ‡¶æ‡¶§‡ßç‡¶∞', admin:'‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®' }[t] || t;
}
function showToast(msg, type='info') {
    const icons = { success:'fas fa-check-circle', error:'fas fa-times-circle', warning:'fas fa-exclamation-triangle', info:'fas fa-info-circle' };
    const colors = { success:'#27ae60', error:'#e74c3c', warning:'#f39c12', info:'#3498db' };
    const c = document.getElementById('toast-container');
    const d = document.createElement('div');
    d.className = `toast ${type}`;
    d.innerHTML = `<i class="${icons[type]}" style="color:${colors[type]};font-size:1.2rem;"></i><span>${msg}</span>`;
    c.appendChild(d);
    setTimeout(() => { d.style.opacity='0'; d.style.transform='translateX(100%)'; d.style.transition='all 0.3s'; setTimeout(() => d.remove(), 300); }, 3200);
}
function showSyncIndicator() {
    const el = document.getElementById('sync-indicator');
    if (!el) return;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2500);
}
function generateCaptcha() {
    const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    captchaValue = Array.from({length:4}, () => c[Math.floor(Math.random()*c.length)]).join('');
    const el = document.getElementById('captcha-code');
    if (el) el.textContent = captchaValue;
}
function togglePasswordVisibility(id, icon) {
    const inp = document.getElementById(id);
    if (inp.type === 'password') { inp.type = 'text'; icon.className = 'fas fa-eye-slash'; }
    else { inp.type = 'password'; icon.className = 'fas fa-eye'; }
}
function checkPasswordStrength(v) {
    let s = 0;
    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v)) s++;
    if (/[0-9]/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;
    const bar = document.getElementById('password-strength-bar');
    if (!bar) return;
    const w = ['0%','30%','55%','80%','100%'][s];
    const clr = ['#e74c3c','#e74c3c','#f39c12','#3498db','#27ae60'][s];
    bar.style.width = w; bar.style.background = clr;
}

// ========== AUTH ==========
function showLoginForm() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('register-form').classList.add('hidden');
    generateCaptcha();
}
function showRegisterForm() {
    document.getElementById('register-form').classList.remove('hidden');
    document.getElementById('login-form').classList.add('hidden');
}
function showTermsModal() { document.getElementById('terms-modal').classList.remove('hidden'); }
function closeTermsModal() { document.getElementById('terms-modal').classList.add('hidden'); }
function showForgotPassword() {
    document.getElementById('modal-title').textContent = '‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü';
    document.getElementById('modal-body').innerHTML = `
        <p style="margin-bottom:18px;color:var(--gray);">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ì ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶¨‡•§</p>
        <div class="form-group"><label>NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="reset-nid" class="form-control" placeholder="NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞"></div>
        <div class="form-group"><label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="reset-email" class="form-control" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ"></div>
        <div style="text-align:center;margin-top:18px;">
            <button class="btn btn-primary" onclick="handleForgotPassword()"><i class="fas fa-paper-plane"></i> ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        </div>`;
    document.getElementById('service-modal').classList.remove('hidden');
}
function handleForgotPassword() {
    const nid = document.getElementById('reset-nid').value.trim();
    const email = document.getElementById('reset-email').value.trim();
    if (!dbCache) { showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'warning'); return; }
    const user = dbCache.users.find(u => u.nid === nid && u.email === email);
    if (user) showToast('‚úì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶°‡ßá‡¶Æ‡ßã)', 'success');
    else showToast('NID ‡¶¨‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error');
    closeModal();
}

async function handleLogin() {
    const uid = document.getElementById('login-userid').value.trim();
    const pwd = document.getElementById('login-password').value;
    const cap = document.getElementById('login-captcha').value.trim().toUpperCase();
    if (!uid || !pwd) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (cap !== captchaValue) { showToast('‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ï‡ßã‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); generateCaptcha(); return; }
    const db = await IslamicBankSystem.load();
    const user = IslamicBankSystem.findUser(uid, pwd);
    if (!user) { showToast('‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); generateCaptcha(); return; }
    if (user.status === 'suspended') { showToast('‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§‡•§ ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error'); return; }
    currentUser = {...user};
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
    loadDashboard();
}

async function handleRegister() {
    const name = document.getElementById('reg-name').value.trim();
    const title = document.getElementById('reg-title').value;
    const nid = document.getElementById('reg-nid').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const phone = document.getElementById('reg-phone').value.trim();
    const type = document.getElementById('reg-type').value;
    const pwd = document.getElementById('reg-password').value;
    const confirmPwd = document.getElementById('reg-confirm-password').value;
    const dob = document.getElementById('reg-dob').value;
    const address = document.getElementById('reg-address').value.trim();
    const occupation = document.getElementById('reg-occupation').value;
    const income = parseInt(document.getElementById('reg-income').value) || 0;
    const terms = document.getElementById('reg-terms').checked;

    if (!name || !nid || !email || !phone || !type || !pwd || !address) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (!/^\d{10}$|^\d{17}$/.test(nid)) { showToast('NID ‡ßß‡ß¶ ‡¶¨‡¶æ ‡ßß‡ß≠ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    if (pwd.length < 8) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    if (pwd !== confirmPwd) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error'); return; }
    if (!terms) { showToast('‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ ‡¶Æ‡ßá‡¶®‡ßá ‡¶®‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }

    const db = await IslamicBankSystem.load();
    if (db.users.find(u => u.nid === nid)) { showToast('‡¶è‡¶á NID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ü‡¶õ‡ßá', 'error'); return; }
    if (db.users.find(u => u.email === email)) { showToast('‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ü‡¶õ‡ßá', 'error'); return; }

    const userId = 'user_' + Date.now();
    const fullName = title ? `${title} ${name}` : name;
    const newUser = { id:userId, nid, password:pwd, name:fullName, email, phone, type, balance:0, joined:new Date().toLocaleDateString('bn-BD'), status:'active', address, occupation, monthlyIncome:income, dob };
    db.users.push(newUser);
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification('admin','‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®',`${fullName} ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßá‡¶õ‡ßá‡¶®`,'registration');
    showToast('‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤! ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'success');
    showLoginForm();
}

function logout() {
    currentUser = null;
    activeChatWith = null;
    sessionStorage.removeItem('currentUser');
    document.getElementById('app-section').classList.add('hidden');
    document.getElementById('auth-section').classList.remove('hidden');
    showLoginForm();
}

// ========== DASHBOARD ==========
function loadDashboard() {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('app-section').classList.remove('hidden');
    document.getElementById('sidebar-username').textContent = currentUser.name;
    document.getElementById('sidebar-usertype').textContent = getUserTypeText(currentUser.type);
    document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
    buildMenu();
    switchTab('dashboard');
    updateNotificationCount();
}

function buildMenu() {
    const mc = document.getElementById('menu-container');
    mc.innerHTML = '';
    const isAdmin = currentUser.type === 'admin';
    const db = dbCache || {};
    const pendingApps = (db.applications||[]).filter(a => a.status === 'pending').length;
    const unreadMsgs = (db.messages||[]).filter(m => m.to === currentUser.id && !m.read).length;

    const sections = isAdmin ? [
        { label:'‡¶Æ‡ßÇ‡¶≤', items:[
            { id:'dashboard', label:'‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°', icon:'fas fa-tachometer-alt' },
        ]},
        { label:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', items:[
            { id:'applications', label:'‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π', icon:'fas fa-file-alt', badge:pendingApps },
            { id:'users', label:'‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ', icon:'fas fa-users' },
            { id:'services', label:'‡¶∏‡ßá‡¶¨‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ', icon:'fas fa-hand-holding-usd' },
            { id:'transactions', label:'‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®', icon:'fas fa-exchange-alt' },
        ]},
        { label:'‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£', items:[
            { id:'reports', label:'‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£', icon:'fas fa-chart-bar' },
            { id:'sharia-panel', label:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤', icon:'fas fa-gavel' },
        ]},
        { label:'‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó', items:[
            { id:'chat-admin', label:'‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü', icon:'fas fa-comments', badge:unreadMsgs },
            { id:'settings', label:'‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏', icon:'fas fa-cog' },
            { id:'jsonbin-settings', label:'JSONBin ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú', icon:'fas fa-database' },
        ]},
    ] : [
        { label:'‡¶Æ‡ßÇ‡¶≤', items:[
            { id:'dashboard', label:'‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°', icon:'fas fa-home' },
            { id:'my-accounts', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü', icon:'fas fa-wallet' },
        ]},
        { label:'‡¶∏‡ßá‡¶¨‡¶æ', items:[
            { id:'services-list', label:'‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π', icon:'fas fa-hand-holding-usd' },
            { id:'apply-service', label:'‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', icon:'fas fa-plus-circle' },
            { id:'my-applications', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®', icon:'fas fa-file-alt', badge:(db.applications||[]).filter(a=>a.userId===currentUser.id&&a.status==='pending').length },
        ]},
        { label:'‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï', items:[
            { id:'transactions', label:'‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏', icon:'fas fa-history' },
            { id:'calculator', label:'‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞', icon:'fas fa-calculator' },
        ]},
        { label:'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ', items:[
            { id:'chat-user', label:'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü', icon:'fas fa-comment-dots', badge:unreadMsgs },
            { id:'sharia-advice', label:'‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂', icon:'fas fa-hands-helping' },
            { id:'profile', label:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤', icon:'fas fa-user' },
        ]},
    ];

    sections.forEach(sec => {
        const sectionDiv = document.createElement('div');
        const sectionTitle = document.createElement('div');
        sectionTitle.className = 'menu-section';
        sectionTitle.textContent = sec.label;
        sectionDiv.appendChild(sectionTitle);
        
        sec.items.forEach(item => {
            const d = document.createElement('div');
            d.className = 'menu-item';
            d.id = `menu-${item.id}`;
            d.innerHTML = `<i class="${item.icon}"></i><span>${item.label}</span>${item.badge ? `<span class="badge">${item.badge}</span>` : ''}`;
            if (item.id === 'jsonbin-settings') {
                d.onclick = () => showJsonBinSettings();
            } else {
                d.onclick = () => switchTab(item.id);
            }
            sectionDiv.appendChild(d);
        });
        mc.appendChild(sectionDiv);
    });
}

function switchTab(tabId) {
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    const am = document.getElementById(`menu-${tabId}`);
    if (am) am.classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    const ca = document.getElementById('content-area');

    const map = {
        'dashboard': showDashboard, 'services-list': showServices, 'services': showServices,
        'apply-service': showApplyService, 'my-applications': showApplications, 'applications': showApplications,
        'chat-user': showChat, 'chat-admin': showChat, 'sharia-advice': showShariaPanel, 'sharia-panel': showShariaPanel,
        'my-accounts': showMyAccounts, 'users': showUsers, 'transactions': showTransactions,
        'reports': showReports, 'profile': showProfile, 'settings': showSettings,
        'calculator': () => { document.getElementById('calc-modal').classList.remove('hidden'); showDashboard(ca); }
    };
    if (map[tabId]) map[tabId](ca);
}

// ========== DASHBOARD VIEW ==========
async function showDashboard(container) {
    const db = await IslamicBankSystem.load();
    let statsHtml = '';
    if (currentUser.type === 'admin') {
        const totalUsers = db.users.filter(u => u.type !== 'admin').length;
        const pendingApps = db.applications.filter(a => a.status === 'pending').length;
        const approvedApps = db.applications.filter(a => a.status === 'approved').length;
        const totalBalance = db.users.filter(u => u.type !== 'admin').reduce((s,u) => s+(u.balance||0), 0);
        statsHtml = `<div class="stats-grid">
            <div class="stat-card"><div class="stat-info"><h3>${totalUsers}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</p></div><div class="stat-icon"><i class="fas fa-users"></i></div></div>
            <div class="stat-card warning"><div class="stat-info"><h3>${pendingApps}</h3><p>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
            <div class="stat-card success"><div class="stat-info"><h3>${approvedApps}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
            <div class="stat-card info"><div class="stat-info"><h3>‡ß≥${formatMoney(totalBalance)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
        </div>`;
    } else {
        const myApps = db.applications.filter(a => a.userId === currentUser.id);
        const myTxns = db.transactions.filter(t => t.userId === currentUser.id);
        const me = db.users.find(u => u.id === currentUser.id);
        currentUser.balance = me ? me.balance : 0;
        statsHtml = `<div class="stats-grid">
            <div class="stat-card"><div class="stat-info"><h3>‡ß≥${formatMoney(currentUser.balance||0)}</h3><p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
            <div class="stat-card warning"><div class="stat-info"><h3>${myApps.filter(a=>a.status==='pending').length}</h3><p>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
            <div class="stat-card success"><div class="stat-info"><h3>${myApps.filter(a=>a.status==='approved').length}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
            <div class="stat-card info"><div class="stat-info"><h3>${myTxns.length}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</p></div><div class="stat-icon"><i class="fas fa-exchange-alt"></i></div></div>
        </div>`;
    }

    const recentTxns = db.transactions.filter(t => currentUser.type === 'admin' || t.userId === currentUser.id).slice(-5).reverse();
    const txnHtml = recentTxns.length ? recentTxns.map(t => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:36px;height:36px;border-radius:50%;background:${t.type==='deposit'?'#d4edda':'#f8d7da'};display:flex;align-items:center;justify-content:center;color:${t.type==='deposit'?'var(--success)':'var(--danger)'};">
                    <i class="fas fa-${t.type==='deposit'?'arrow-down':'arrow-up'}"></i>
                </div>
                <div><div style="font-weight:600;font-size:0.92rem;">${t.description}</div><div style="font-size:0.8rem;color:var(--gray);">${t.date}</div></div>
            </div>
            <div style="font-weight:700;color:${t.type==='deposit'?'var(--success)':'var(--danger)'};">${t.type==='deposit'?'+':'-'}‡ß≥${formatMoney(t.amount)}</div>
        </div>`).join('') : '<div style="text-align:center;padding:25px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</div>';

    container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div>
                    <h2 style="margin-bottom:8px;">‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ, ${currentUser.name}</h2>
                    <p style="opacity:0.85;">‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ‡•§</p>
                    ${currentUser.type !== 'admin' ? `<div style="margin-top:12px;"><span class="sharia-badge"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç</span></div>` : ''}
                </div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-mosque"></i></div>
            </div>
            ${statsHtml}
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:8px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-history"></i> ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h4>
                    ${txnHtml}
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-bolt"></i> ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        ${currentUser.type === 'admin' ? `
                            <div onclick="switchTab('applications')" style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;transition:var(--transition);" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='var(--primary-light)'">
                                <i class="fas fa-file-alt" style="font-size:1.8rem;color:var(--primary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</div>
                            </div>
                            <div onclick="switchTab('users')" style="background:#e3f2fd;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
                                <i class="fas fa-users" style="font-size:1.8rem;color:var(--info);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                            </div>
                            <div onclick="switchTab('chat-admin')" style="background:#e8f5e9;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'">
                                <i class="fas fa-comments" style="font-size:1.8rem;color:var(--success);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</div>
                            </div>
                            <div onclick="switchTab('reports')" style="background:#fff9e6;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#fff3cc'" onmouseout="this.style.background='#fff9e6'">
                                <i class="fas fa-chart-bar" style="font-size:1.8rem;color:var(--secondary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</div>
                            </div>
                        ` : `
                            <div onclick="switchTab('apply-service')" style="background:var(--primary-light);border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='var(--primary-light)'">
                                <i class="fas fa-plus-circle" style="font-size:1.8rem;color:var(--primary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ</div>
                            </div>
                            <div onclick="switchTab('my-applications')" style="background:#e3f2fd;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'">
                                <i class="fas fa-file-alt" style="font-size:1.8rem;color:var(--info);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</div>
                            </div>
                            <div onclick="switchTab('chat-user')" style="background:#e8f5e9;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'">
                                <i class="fas fa-comment-dots" style="font-size:1.8rem;color:var(--success);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ</div>
                            </div>
                            <div onclick="document.getElementById('calc-modal').classList.remove('hidden')" style="background:#fff9e6;border-radius:var(--radius-sm);padding:15px;text-align:center;cursor:pointer;" onmouseover="this.style.background='#fff3cc'" onmouseout="this.style.background='#fff9e6'">
                                <i class="fas fa-calculator" style="font-size:1.8rem;color:var(--secondary);"></i><div style="font-weight:600;margin-top:7px;font-size:0.88rem;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</div>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°`;
}

// ========== SERVICES ==========
async function showServices(container) {
    const db = await IslamicBankSystem.load();
    const search = (container._search || '').toLowerCase();
    const filtered = db.services.filter(s =>
        s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search) || s.category.toLowerCase().includes(search)
    );
    const cardsHtml = filtered.map(s => `
        <div class="service-card">
            <div class="service-icon"><i class="${s.icon}"></i></div>
            <div class="service-body">
                <div class="service-title">${s.name}</div>
                <span class="sharia-badge" style="margin-bottom:10px;"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
                <div class="service-desc">${s.description}</div>
                <div class="service-meta">
                    <span><i class="fas fa-percentage" style="color:var(--success);"></i> ${s.profitRate}</span>
                    <span><i class="fas fa-calendar" style="color:var(--info);"></i> ${s.duration}</span>
                </div>
                <div class="service-features">
                    ${s.features.map(f => `<div class="feature-item"><i class="fas fa-check-circle"></i>${f}</div>`).join('')}
                </div>
                <div style="display:flex;gap:8px;margin-top:auto;">
                    <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('${s.id}')"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
                    ${currentUser.type !== 'admin' ? `<button class="btn btn-primary btn-sm flex-1" onclick="openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</button>` : ''}
                </div>
            </div>
        </div>`).join('');

    container.innerHTML = `
        <div class="services-container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px;">
                <h2 style="color:var(--primary-dark);">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
                <div style="position:relative;">
                    <i class="fas fa-search" style="position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--gray);"></i>
                    <input type="text" placeholder="‡¶∏‡ßá‡¶¨‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="form-control" style="padding-left:38px;width:250px;" oninput="container._search=this.value;showServices(document.getElementById('content-area'))" id="service-search">
                </div>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterServices(this,'all')">‡¶∏‡¶¨ ‡¶∏‡ßá‡¶¨‡¶æ</button>
                <button class="filter-btn" onclick="filterServices(this,'savings')">‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º</button>
                <button class="filter-btn" onclick="filterServices(this,'investment')">‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</button>
                <button class="filter-btn" onclick="filterServices(this,'finance')">‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</button>
                <button class="filter-btn" onclick="filterServices(this,'loan')">‡¶ã‡¶£</button>
                <button class="filter-btn" onclick="filterServices(this,'insurance')">‡¶¨‡ßÄ‡¶Æ‡¶æ</button>
            </div>
            <div class="services-grid" id="services-grid">${cardsHtml || '<div style="text-align:center;padding:50px;color:var(--gray);grid-column:1/-1;">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>'}</div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-hand-holding-usd"></i> ‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π`;
}

function filterServices(btn, type) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!dbCache) return;
    const grid = document.getElementById('services-grid');
    const filtered = type === 'all' ? dbCache.services : dbCache.services.filter(s => s.type === type);
    grid.innerHTML = filtered.map(s => `
        <div class="service-card">
            <div class="service-icon"><i class="${s.icon}"></i></div>
            <div class="service-body">
                <div class="service-title">${s.name}</div>
                <span class="sharia-badge" style="margin-bottom:10px;"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
                <div class="service-desc">${s.description}</div>
                <div class="service-meta"><span><i class="fas fa-percentage" style="color:var(--success);"></i> ${s.profitRate}</span><span><i class="fas fa-calendar" style="color:var(--info);"></i> ${s.duration}</span></div>
                <div style="display:flex;gap:8px;margin-top:auto;">
                    <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('${s.id}')"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
                    ${currentUser.type !== 'admin' ? `<button class="btn btn-primary btn-sm flex-1" onclick="openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</button>` : ''}
                </div>
            </div>
        </div>`).join('') || '<div style="text-align:center;padding:50px;color:var(--gray);grid-column:1/-1;">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡ßá‡¶á</div>';
}

async function viewServiceDetails(svcId) {
    const db = await IslamicBankSystem.load();
    const s = db.services.find(x => x.id === svcId);
    if (!s) return;
    document.getElementById('modal-title').textContent = s.name;
    document.getElementById('modal-body').innerHTML = `
        <div style="text-align:center;padding:25px;background:linear-gradient(135deg,#fff9e6,#fff3cc);border-radius:var(--radius);margin-bottom:20px;">
            <div style="font-size:3.5rem;color:var(--secondary);margin-bottom:10px;"><i class="${s.icon}"></i></div>
            <span class="sharia-badge"><i class="fas fa-check"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</span>
        </div>
        <p style="color:var(--gray);margin-bottom:18px;">${s.description}</p>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px;">
            <div class="info-item"><div class="info-label">‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞</div><div class="info-value" style="color:var(--success);">${s.profitRate}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${s.duration}</div></div>
            <div class="info-item"><div class="info-label">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ</div><div class="info-value">‡ß≥${formatMoney(s.minAmount)}</div></div>
        </div>
        <h4 style="color:var(--primary-dark);margin-bottom:12px;">‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;">
            ${s.features.map(f => `<div class="feature-item" style="background:#f8f9fa;padding:8px 12px;border-radius:var(--radius-sm);"><i class="fas fa-check-circle"></i>${f}</div>`).join('')}
        </div>
        ${currentUser.type !== 'admin' ? `<button class="btn btn-primary w-100" onclick="closeModal();openApplyModal('${s.id}')"><i class="fas fa-paper-plane"></i> ‡¶è‡¶ñ‡¶®‡¶á ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>` : ''}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

async function showApplyService(container) {
    const db = await IslamicBankSystem.load();
    const opts = db.services.map(s => `<option value="${s.id}" data-min="${s.minAmount}" data-max="${s.maxAmount}" data-rate="${s.profitRate}">${s.name} (${s.profitRate})</option>`).join('');
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:700px;margin:0 auto;">
            <div class="card" style="cursor:default;">
                <h3 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-plus-circle"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</h3>
                <div class="form-group"><label>‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="apply-service-id" class="form-control" onchange="onServiceChange(this)"><option value="">-- ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® --</option>${opts}</select>
                </div>
                <div id="service-info-box" style="display:none;background:var(--primary-light);border-radius:var(--radius-sm);padding:14px;margin-bottom:18px;">
                    <div id="service-info-text"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                        <input type="number" id="apply-amount" class="form-control" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" oninput="validateAmount(this)">
                        <small id="amount-hint" style="color:var(--gray);font-size:0.8rem;"></small>
                    </div>
                    <div class="form-group">
                        <label>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</label>
                        <select id="apply-duration" class="form-control">
                            <option>‡ßß ‡¶¨‡¶õ‡¶∞</option><option>‡ß® ‡¶¨‡¶õ‡¶∞</option><option>‡ß© ‡¶¨‡¶õ‡¶∞</option><option>‡ß´ ‡¶¨‡¶õ‡¶∞</option><option>‡ß≠ ‡¶¨‡¶õ‡¶∞</option><option>‡ßß‡ß¶ ‡¶¨‡¶õ‡¶∞</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø</label>
                    <textarea id="apply-purpose" class="form-control" rows="3" placeholder="‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                </div>
                <div class="form-group"><label>‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶®‡¶•‡¶ø‡¶™‡¶§‡ßç‡¶∞</label>
                    <div id="doc-checklist" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        ${['NID ‡¶ï‡¶™‡¶ø','‡¶õ‡¶¨‡¶ø (‡¶™‡¶æ‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú)','‡¶Ü‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£','‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡ßç‡¶ü‡ßá‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü'].map(d => `
                            <div style="display:flex;align-items:center;gap:8px;background:#f8f9fa;padding:8px 12px;border-radius:var(--radius-sm);">
                                <input type="checkbox" id="doc-${d.replace(/\s/g,'-')}">
                                <label for="doc-${d.replace(/\s/g,'-')}" style="margin:0;font-size:0.88rem;">${d}</label>
                            </div>`).join('')}
                    </div>
                </div>
                <button class="btn btn-primary w-100 btn-lg" onclick="submitApplication()">
                    <i class="fas fa-paper-plane"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
                </button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-plus-circle"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®`;
}

function onServiceChange(sel) {
    const opt = sel.options[sel.selectedIndex];
    const min = opt.dataset.min, max = opt.dataset.max, rate = opt.dataset.rate;
    const box = document.getElementById('service-info-box');
    const txt = document.getElementById('service-info-text');
    if (sel.value && min) {
        txt.innerHTML = `<strong style="color:var(--primary-dark);">‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø:</strong> ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ <strong>‡ß≥${formatMoney(Number(min))}</strong>, ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö <strong>‡ß≥${formatMoney(Number(max))}</strong>, ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞ <strong style="color:var(--success);">${rate}</strong>`;
        document.getElementById('amount-hint').textContent = `‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ß≥${formatMoney(Number(min))} - ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß≥${formatMoney(Number(max))}`;
        box.style.display = 'block';
    } else { box.style.display = 'none'; }
}
function validateAmount(inp) {
    const sel = document.getElementById('apply-service-id');
    const opt = sel.options[sel.selectedIndex];
    if (!opt.dataset.min) return;
    const v = Number(inp.value);
    const min = Number(opt.dataset.min), max = Number(opt.dataset.max);
    if (v < min) inp.style.borderColor = 'var(--danger)';
    else if (v > max) inp.style.borderColor = 'var(--warning)';
    else inp.style.borderColor = 'var(--success)';
}

async function openApplyModal(svcId) {
    await showApplyService(document.getElementById('content-area'));
    const sel = document.getElementById('apply-service-id');
    sel.value = svcId;
    onServiceChange(sel);
    switchTab('apply-service');
}

async function submitApplication() {
    const svcId = document.getElementById('apply-service-id').value;
    const amount = parseInt(document.getElementById('apply-amount').value);
    const duration = document.getElementById('apply-duration').value;
    const purpose = document.getElementById('apply-purpose').value.trim();
    if (!svcId) { showToast('‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    if (!amount || amount <= 0) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error'); return; }
    if (!purpose) { showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const svc = db.services.find(s => s.id === svcId);
    if (!svc) return;
    if (amount < svc.minAmount) { showToast(`‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß≥${formatMoney(svc.minAmount)}`, 'error'); return; }
    if (amount > svc.maxAmount) { showToast(`‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡ß≥${formatMoney(svc.maxAmount)}`, 'error'); return; }
    const app = { userId:currentUser.id, userName:currentUser.name, userType:currentUser.type, serviceId:svcId, serviceName:svc.name, amount, duration, purpose };
    await IslamicBankSystem.addApplication(app);
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    switchTab('my-applications');
}

// ========== APPLICATIONS ==========
async function showApplications(container) {
    const db = await IslamicBankSystem.load();
    let apps = currentUser.type === 'admin' ? db.applications : db.applications.filter(a => a.userId === currentUser.id);
    apps = apps.slice().reverse();
    const tRows = apps.map(a => `
        <tr>
            <td>${a.userName || currentUser.name}<div style="font-size:0.8rem;color:var(--gray);">${getUserTypeText(a.userType||'personal')}</div></td>
            <td><div style="font-weight:600;">${a.serviceName}</div></td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(a.amount)}</td>
            <td>${a.duration}</td>
            <td style="font-size:0.85rem;">${a.appliedDate}</td>
            <td><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',processing:'‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ß‡ßÄ‡¶®'}[a.status]||a.status}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i></button>
                ${currentUser.type==='admin'&&a.status==='pending'?`<button class="btn btn-sm btn-success" onclick="quickApprove(${a.id})"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="quickReject(${a.id})"><i class="fas fa-times"></i></button>`:''}
            </div></td>
        </tr>`).join('');

    container.innerHTML = `
        <div class="table-container">
            <div class="table-header">
                <h2>${currentUser.type==='admin'?'‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®':'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®'} <span style="font-size:0.85rem;font-weight:400;color:var(--gray);">(${apps.length}‡¶ü‡¶ø)</span></h2>
                ${currentUser.type==='admin'?`<div class="filter-bar">
                    <button class="filter-btn active" onclick="filterApps(this,'all')">‡¶∏‡¶¨</button>
                    <button class="filter-btn" onclick="filterApps(this,'pending')">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</button>
                    <button class="filter-btn" onclick="filterApps(this,'approved')">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</button>
                    <button class="filter-btn" onclick="filterApps(this,'rejected')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                </div>`:''}
            </div>
            <div class="table-responsive">
                <table><thead><tr><th>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ</th><th>‡¶∏‡ßá‡¶¨‡¶æ</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th><th>‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th></tr></thead>
                <tbody id="apps-tbody">${tRows||`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--gray);"><i class="fas fa-file-alt" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:12px;"></i>‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</td></tr>`}</tbody>
                </table>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-file-alt"></i> ${currentUser.type==='admin'?'‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π':'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®'}`;
}

function filterApps(btn, status) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!dbCache) return;
    let apps = status === 'all' ? dbCache.applications : dbCache.applications.filter(a => a.status === status);
    apps = apps.slice().reverse();
    const tbody = document.getElementById('apps-tbody');
    if (!tbody) return;
    tbody.innerHTML = apps.map(a => `
        <tr>
            <td>${a.userName}<div style="font-size:0.8rem;color:var(--gray);">${getUserTypeText(a.userType||'personal')}</div></td>
            <td><div style="font-weight:600;">${a.serviceName}</div></td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(a.amount)}</td>
            <td>${a.duration}</td>
            <td style="font-size:0.85rem;">${a.appliedDate}</td>
            <td><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[a.status]||a.status}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i></button>
                ${a.status==='pending'?`<button class="btn btn-sm btn-success" onclick="quickApprove(${a.id})"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-danger" onclick="quickReject(${a.id})"><i class="fas fa-times"></i></button>`:''}
            </div></td>
        </tr>`).join('') || `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</td></tr>`;
}

async function viewApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    const svc = db.services.find(s => s.id === app.serviceId);
    document.getElementById('modal-title').textContent = '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
    const reviewSection = (currentUser.type === 'admin' && app.status === 'pending') ? `
        <div style="background:var(--primary-light);border-radius:var(--radius);padding:20px;margin:20px 0;">
            <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-gavel"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</h4>
            <div class="form-row">
                <div class="form-group"><label>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡¶ø</label>
                    <select id="sharia-compliance" class="form-control"><option value="approved">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</option><option value="conditionally-approved">‡¶∂‡¶∞‡ßç‡¶§‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑‡ßá</option><option value="not-approved">‡¶Ö‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§</option></select>
                </div>
            </div>
            <div class="form-group"><label>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</label>
                <textarea id="sharia-comment" class="form-control" rows="3" placeholder="‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø..."></textarea>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-success flex-1" onclick="approveApplication(${app.id})"><i class="fas fa-check"></i> ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-danger flex-1" onclick="rejectApplication(${app.id})"><i class="fas fa-times"></i> ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>` : '';

    document.getElementById('modal-body').innerHTML = `
        <div style="background:linear-gradient(135deg,var(--primary-light),#e8f5e9);border-radius:var(--radius);padding:20px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                    <div style="font-size:0.85rem;color:var(--gray);">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                    <div style="font-size:1.2rem;font-weight:700;">${app.userName}</div>
                    <div style="font-size:0.88rem;color:var(--gray);">${getUserTypeText(app.userType||'personal')}</div>
                </div>
                <span class="status-badge status-${app.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[app.status]||app.status}</span>
            </div>
        </div>
        <div class="info-grid" style="margin-bottom:20px;">
            <div class="info-item"><div class="info-label">‡¶∏‡ßá‡¶¨‡¶æ</div><div class="info-value">${app.serviceName}</div></div>
            <div class="info-item"><div class="info-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div><div class="info-value" style="color:var(--primary);">‡ß≥${formatMoney(app.amount)}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${app.duration}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</div><div class="info-value" style="font-size:0.88rem;">${app.appliedDate}</div></div>
        </div>
        <div style="margin-bottom:20px;"><h4 style="color:var(--primary-dark);margin-bottom:10px;"><i class="fas fa-file-alt"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø</h4>
            <div style="background:#f8f9fa;border-radius:var(--radius-sm);padding:14px;">${app.purpose}</div>
        </div>
        ${reviewSection}
        ${app.status !== 'pending' ? `
        <div style="background:${app.status==='approved'?'#d4edda':'#f8d7da'};border-radius:var(--radius);padding:18px;">
            <h4 style="color:${app.status==='approved'?'#155724':'#721c24'};margin-bottom:10px;"><i class="fas fa-${app.status==='approved'?'check-circle':'times-circle'}"></i> ${app.status==='approved'?'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®':'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'} ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h4>
            <p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${app.approvedDate||app.rejectedDate||'-'}</p>
            <p><strong>‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞:</strong> ${app.approvedBy||app.rejectedBy||'-'}</p>
            ${app.reviewComment?`<p><strong>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</strong> ${app.reviewComment}</p>`:''}
        </div>` : ''}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

async function approveApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'approved';
    app.approvedBy = currentUser.name;
    app.approvedDate = new Date().toLocaleString('bn-BD');
    app.shariaReview = true;
    app.reviewComment = document.getElementById('sharia-comment')?.value || '‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®, ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§';
    const user = db.users.find(u => u.id === app.userId);
    if (user && (app.serviceId.includes('savings') || app.serviceId.includes('deposit'))) {
        user.balance = (user.balance || 0) + app.amount;
        db.transactions.push({ id:Date.now(), userId:app.userId, type:'deposit', amount:app.amount, description:app.serviceName, date:new Date().toLocaleString('bn-BD'), status:'completed', balance:user.balance });
    }
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'success');
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    closeModal();
    showApplications(document.getElementById('content-area'));
    updateNotificationCount();
}

async function rejectApplication(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'rejected';
    app.rejectedBy = currentUser.name;
    app.rejectedDate = new Date().toLocaleString('bn-BD');
    app.reviewComment = document.getElementById('sharia-comment')?.value || '‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶≤‡¶ô‡ßç‡¶ò‡¶®';
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${app.serviceName} ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,'error');
    showToast('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
    closeModal();
    showApplications(document.getElementById('content-area'));
    updateNotificationCount();
}

async function quickApprove(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'approved'; app.approvedBy = currentUser.name; app.approvedDate = new Date().toLocaleString('bn-BD'); app.reviewComment = '‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®';
    const user = db.users.find(u => u.id === app.userId);
    if (user && app.serviceId.includes('savings')) { user.balance = (user.balance||0) + app.amount; }
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',`${app.serviceName} ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§`,'success');
    showToast('‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
    showApplications(document.getElementById('content-area'));
}

async function quickReject(appId) {
    const db = await IslamicBankSystem.load();
    const app = db.applications.find(a => a.id == appId);
    if (!app) return;
    app.status = 'rejected'; app.rejectedBy = currentUser.name; app.rejectedDate = new Date().toLocaleString('bn-BD');
    await IslamicBankSystem.save(db);
    await IslamicBankSystem.addNotification(app.userId,'‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',`${app.serviceName} ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤`,'error');
    showToast('‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'warning');
    showApplications(document.getElementById('content-area'));
}

// ========== CHAT ==========
async function showChat(container) {
    const db = await IslamicBankSystem.load();
    if (currentUser.type === 'admin') {
        const users = db.users.filter(u => u.type !== 'admin');
        const userListHtml = users.map(u => {
            const unread = db.messages.filter(m => m.from === u.id && m.to === 'admin' && !m.read).length;
            const last = db.messages.filter(m => (m.from===u.id&&m.to==='admin')||(m.from==='admin'&&m.to===u.id)).sort((a,b)=>b.id-a.id)[0];
            return `<div class="chat-user-item ${activeChatWith===u.id?'active':''}" onclick="openChatWith('${u.id}')">
                <div class="user-avatar" style="width:36px;height:36px;font-size:0.95rem;">${u.name.charAt(0)}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:0.92rem;">${u.name}</div>
                    <div style="font-size:0.8rem;color:var(--gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${last?last.text.substring(0,28)+'...':'‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á'}</div>
                </div>
                ${unread?`<span class="badge">${unread}</span>`:''}
            </div>`;
        }).join('');

        const messagesHtml = activeChatWith ? await getChatMessages('admin', activeChatWith) : '<div style="text-align:center;padding:60px;color:var(--gray);"><i class="fas fa-comment-dots" style="font-size:3rem;opacity:0.3;display:block;margin-bottom:15px;"></i>‡¶è‡¶ï‡¶ú‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>';
        const activeName = activeChatWith ? (db.users.find(u=>u.id===activeChatWith)?.name || '') : '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';

        container.innerHTML = `<div class="chat-container">
            <div class="chat-list"><div class="chat-header"><i class="fas fa-users"></i> ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
            <div style="overflow-y:auto;flex:1;">${userListHtml||'<div style="padding:20px;text-align:center;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡ßá‡¶á</div>'}</div></div>
            <div class="chat-window">
                <div class="chat-header"><i class="fas fa-user"></i> ${activeName} ${activeChatWith?'<span style="margin-left:8px;font-size:0.75rem;color:var(--success);font-weight:400;">‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</span>':''}</div>
                <div class="chat-messages" id="chat-messages">${messagesHtml}</div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input" placeholder="${activeChatWith?'‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...':'‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'}" ${!activeChatWith?'disabled':''} onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()" ${!activeChatWith?'disabled':''}><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>`;
    } else {
        const messagesHtml = await getChatMessages(currentUser.id, 'admin');
        container.innerHTML = `<div class="chat-container" style="flex-direction:column;height:auto;">
            <div class="chat-window" style="height:calc(100vh - 170px);">
                <div class="chat-header"><i class="fas fa-headset"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ <span style="margin-left:auto;font-size:0.75rem;font-weight:400;color:var(--success);">‚óè ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</span></div>
                <div class="chat-messages" id="chat-messages">${messagesHtml||'<div style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</div>'}</div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>`;
    }
    document.getElementById('page-title').innerHTML = `<i class="fas fa-comments"></i> ${currentUser.type==='admin'?'‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü':'‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü'}`;
}

async function getChatMessages(user1, user2) {
    const db = await IslamicBankSystem.load();
    const msgs = db.messages.filter(m =>
        (m.from===user1&&m.to===user2)||(m.from===user2&&m.to===user1)
    ).sort((a,b) => a.id - b.id);
    // Mark as read
    let changed = false;
    msgs.forEach(m => { if (m.to === currentUser.id && !m.read) { m.read = true; changed = true; } });
    if (changed) await IslamicBankSystem.save(db);
    return msgs.map(m => `
        <div class="message ${m.from===currentUser.id?'msg-sent':'msg-received'}">
            <div>${m.text}</div>
            <div class="message-time">${m.timestamp} ${m.from===currentUser.id?'‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶ø':''}</div>
        </div>`).join('') || '<div style="text-align:center;padding:30px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</div>';
}

async function openChatWith(userId) {
    activeChatWith = userId;
    showChat(document.getElementById('content-area'));
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    const to = currentUser.type === 'admin' ? activeChatWith : 'admin';
    if (!to) return;
    await IslamicBankSystem.addMessage(currentUser.id, to, text);
    input.value = '';
    const msgs = document.getElementById('chat-messages');
    if (msgs) {
        const newMsg = document.createElement('div');
        newMsg.className = 'message msg-sent';
        newMsg.innerHTML = `<div>${text}</div><div class="message-time">${new Date().toLocaleString('bn-BD')} ‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶ø</div>`;
        if (msgs.querySelector('div[style*="text-align:center"]')) msgs.innerHTML = '';
        msgs.appendChild(newMsg);
        msgs.scrollTop = msgs.scrollHeight;
    }
    updateNotificationCount();
    buildMenu();
}

// ========== SHARIA PANEL ==========
async function showShariaPanel(container) {
    const db = await IslamicBankSystem.load();
    if (currentUser.type === 'admin') {
        const pendingReviews = db.applications.filter(a => a.status === 'pending').length;
        container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div><h2>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2><p>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶Ü‡¶á‡¶®‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶ï‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ</p></div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-gavel"></i></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-info"><h3>${pendingReviews}</h3><p>‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
                <div class="stat-card success"><div class="stat-info"><h3>${db.applications.filter(a=>a.shariaReview&&a.status==='approved').length}</h3><p>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§</p></div><div class="stat-icon"><i class="fas fa-check-circle"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${db.services.length}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶∏‡ßá‡¶¨‡¶æ</p></div><div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-book-open"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø‡¶Æ‡¶æ‡¶≤‡¶æ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h4>
                    <div class="timeline">
                        ${[['‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß','‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßÅ‡¶¶ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß','success'],['‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø','success'],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ','‡¶ï‡ßç‡¶∞‡¶Ø‡¶º-‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ','success'],['‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ','‡¶¨‡¶ø‡¶®‡¶æ ‡¶∏‡ßÅ‡¶¶‡ßá ‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®','success'],['‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤','‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ','success']].map(([t,d,c]) => `
                            <div class="timeline-item"><div class="timeline-dot ${c}"></div>
                            <div class="timeline-content"><strong>${t}</strong><div style="font-size:0.85rem;color:var(--gray);margin-top:4px;">${d}</div></div></div>`).join('')}
                    </div>
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:15px;"><i class="fas fa-chart-pie"></i> ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞</h4>
                    ${[['‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º','‡ßØ‡ßÆ%',98],['‡¶Æ‡ßÅ‡¶∂‡¶æ‡¶∞‡¶æ‡¶ï‡¶æ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó','‡ßØ‡ß´%',95],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏','‡ßØ‡ß≠%',97],['‡¶ï‡¶æ‡¶∞‡ßç‡¶¶‡ßá ‡¶π‡¶æ‡¶∏‡¶æ‡¶®‡¶æ','‡ßß‡ß¶‡ß¶%',100]].map(([n,p,w]) => `
                        <div style="margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.88rem;margin-bottom:5px;"><span>${n}</span><span style="color:var(--success);font-weight:600;">${p}</span></div>
                            <div class="progress-bar"><div class="chart-bar" style="width:${w}%;"></div></div>
                        </div>`).join('')}
                </div>
            </div>
        </div>`;
    } else {
        container.innerHTML = `
        <div class="dashboard-content">
            <div class="welcome-banner">
                <div><h2>‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞</h2><p>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶Ö‡¶∞‡ßç‡¶•‡¶®‡ßÄ‡¶§‡¶ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶ø‡¶®</p></div>
                <div style="font-size:4rem;opacity:0.15;"><i class="fas fa-hands-helping"></i></div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:18px;margin-bottom:25px;">
                ${[['‡¶∏‡ßÅ‡¶¶ ‡¶ï‡¶ø ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ?','‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßÅ‡¶¶ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§','fas fa-ban'],['‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶ï‡¶ø?','‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨‡ßá ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡•§ ‡¶è‡¶ï‡¶ú‡¶® ‡¶™‡ßÅ‡¶Å‡¶ú‡¶ø ‡¶¶‡ßá‡¶Ø‡¶º, ‡¶Ö‡¶®‡ßç‡¶Ø‡¶ú‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡•§','fas fa-handshake'],['‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ ‡¶ï‡¶ø?','‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§','fas fa-store'],['‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶ï‡¶ø?','‡¶™‡¶æ‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ø‡¶ï ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§','fas fa-shield-alt']].map(([q,a,i]) => `
                    <div class="card" style="cursor:default;">
                        <div style="font-size:2rem;color:var(--secondary);margin-bottom:12px;"><i class="${i}"></i></div>
                        <h4 style="color:var(--primary-dark);margin-bottom:8px;">${q}</h4>
                        <p style="color:var(--gray);font-size:0.9rem;">${a}</p>
                    </div>`).join('')}
            </div>
            <div style="text-align:center;">
                <button class="btn btn-primary btn-lg" onclick="openShariaAdviceModal()"><i class="fas fa-comment-dots"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶®</button>
            </div>
        </div>`;
    }
    document.getElementById('page-title').innerHTML = `<i class="fas fa-gavel"></i> ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤`;
}

function openShariaAdviceModal() { document.getElementById('sharia-advice-modal').classList.remove('hidden'); }
function closeShariaAdviceModal() { document.getElementById('sharia-advice-modal').classList.add('hidden'); }

function sendShariaMessage() {
    const input = document.getElementById('sharia-chat-input');
    const text = input.value.trim();
    if (!text) return;
    const chatWin = document.getElementById('sharia-chat-messages');
    chatWin.innerHTML += `<div class="message msg-sent"><div>${text}</div><div class="message-time">${new Date().toLocaleString('bn-BD')}</div></div>`;
    input.value = '';
    chatWin.scrollTop = chatWin.scrollHeight;
    setTimeout(() => {
        const replies = {
            '‡¶∏‡ßÅ‡¶¶': '‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡ßÅ‡¶¶ (‡¶∞‡¶ø‡¶¨‡¶æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ‡•§ ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶§‡¶æ‡¶Ü‡¶≤‡¶æ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®‡ßá ‡¶¨‡¶≤‡ßá‡¶õ‡ßá‡¶®: "‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶ï‡ßá ‡¶π‡¶æ‡¶≤‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßÅ‡¶¶‡¶ï‡ßá ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§" (‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶¨‡¶æ‡¶ï‡¶æ‡¶∞‡¶æ: ‡ß®‡ß≠‡ß´)',
            '‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ': '‡¶Æ‡ßÅ‡¶¶‡¶æ‡¶∞‡¶æ‡¶¨‡¶æ ‡¶π‡¶≤‡ßã ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶Ö‡¶Ç‡¶∂‡ßÄ‡¶¶‡¶æ‡¶∞‡¶ø‡¶§‡ßç‡¶¨ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡•§ ‡¶è‡¶ï‡¶™‡¶ï‡ßç‡¶∑ ‡¶Æ‡ßÇ‡¶≤‡¶ß‡¶® ‡¶¶‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶Ø‡¶™‡¶ï‡ßç‡¶∑ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡¶®‡•§ ‡¶≤‡¶æ‡¶≠ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡¶æ‡¶∞‡ßá ‡¶¨‡¶£‡ßç‡¶ü‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡•§',
            '‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ': '‡¶Æ‡ßÅ‡¶∞‡¶æ‡¶¨‡¶æ‡¶π‡¶æ‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡•§',
            '‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤': '‡¶§‡¶æ‡¶ï‡¶æ‡¶´‡ßÅ‡¶≤ ‡¶π‡¶≤‡ßã ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßÄ‡¶Æ‡¶æ‡•§ ‡¶è‡¶§‡ßá ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶∞‡¶æ ‡¶™‡¶∞‡¶∏‡ßç‡¶™‡¶∞‡¶ï‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡¶§‡ßá ‡¶ö‡¶æ‡¶Å‡¶¶‡¶æ ‡¶¶‡ßá‡¶®‡•§ ‡¶™‡ßç‡¶∞‡¶ö‡¶≤‡¶ø‡¶§ ‡¶¨‡ßÄ‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶∏‡ßÅ‡¶¶ ‡¶¨‡¶æ ‡¶Ö‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§',
            '‡¶ú‡¶æ‡¶ï‡¶æ‡¶§': '‡¶ú‡¶æ‡¶ï‡¶æ‡¶§ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡¶æ‡¶Å‡¶ö‡¶ü‡¶ø ‡¶∏‡ßç‡¶§‡¶Æ‡ßç‡¶≠‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø‡•§ ‡¶®‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶õ‡¶∞ ‡ß®.‡ß´% ‡¶ú‡¶æ‡¶ï‡¶æ‡¶§ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡•§',
            '‡¶π‡¶æ‡¶≤‡¶æ‡¶≤': '‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá ‡¶π‡¶æ‡¶≤‡¶æ‡¶≤ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶≠‡¶æ‡¶á‡¶ú‡¶∞‡¶ø ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡•§',
            '‡¶π‡¶ú': '‡¶π‡¶ú ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ ‡¶π‡¶ú ‡¶™‡¶æ‡¶≤‡¶®‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶û‡ßç‡¶ö‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶¶‡ßá‡¶Ø‡¶º‡•§ ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§‡•§',
            '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ': '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡¶§‡ßá ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö ‡¶Æ‡ßá‡¶ü‡¶æ‡¶§‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶ï‡¶∞‡ßá‡•§'
        };
        let reply = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡¶¶‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø: ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç ‡¶∏‡ßÅ‡¶¶‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§‡•§';
        for (const [key, val] of Object.entries(replies)) {
            if (text.includes(key)) { reply = val; break; }
        }
        chatWin.innerHTML += `<div class="message msg-received"><div>${reply}</div><div class="message-time">‡¶∂‡¶∞‡ßÄ‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂‡¶ï</div></div>`;
        chatWin.scrollTop = chatWin.scrollHeight;
    }, 900);
}

// ========== MY ACCOUNTS ==========
async function showMyAccounts(container) {
    const db = await IslamicBankSystem.load();
    const me = db.users.find(u => u.id === currentUser.id);
    currentUser.balance = me?.balance || 0;
    const accounts = db.applications.filter(a => a.userId === currentUser.id && a.status === 'approved');
    const accountsHtml = accounts.map(a => {
        const svc = db.services.find(s => s.id === a.serviceId);
        return `<div class="service-card">
            <div class="service-icon"><i class="${svc?.icon||'fas fa-wallet'}"></i></div>
            <div class="service-body">
                <div class="service-title">${a.serviceName}</div>
                <span class="status-badge status-approved" style="margin-bottom:14px;">‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</span>
                <div class="info-grid" style="margin-bottom:15px;">
                    <div class="info-item"><div class="info-label">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</div><div class="info-value" style="color:var(--primary);">‡ß≥${formatMoney(a.amount)}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶</div><div class="info-value">${a.duration}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</div><div class="info-value" style="font-size:0.82rem;">${a.approvedDate||'-'}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßÅ‡¶®‡¶æ‡¶´‡¶æ ‡¶π‡¶æ‡¶∞</div><div class="info-value" style="color:var(--success);">${svc?.profitRate||'-'}</div></div>
                </div>
                <button class="btn btn-outline w-100" onclick="viewApplication(${a.id})"><i class="fas fa-eye"></i> ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
            </div>
        </div>`;
    }).join('');
    container.innerHTML = `
        <div class="services-container">
            <div style="background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;border-radius:var(--radius);padding:25px;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;">
                <div><h3 style="margin-bottom:5px;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</h3><div style="font-size:2.2rem;font-weight:700;">‡ß≥${formatMoney(currentUser.balance)}</div></div>
                <div style="text-align:right;"><div style="opacity:0.8;font-size:0.9rem;">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div><div style="font-size:2.5rem;font-weight:700;">${accounts.length}</div></div>
            </div>
            <h2 style="margin-bottom:18px;color:var(--primary-dark);">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div class="services-grid">${accountsHtml||`<div style="text-align:center;padding:50px;grid-column:1/-1;"><i class="fas fa-wallet" style="font-size:3rem;color:var(--gray);opacity:0.3;display:block;margin-bottom:15px;"></i><h3 style="color:var(--gray);margin-bottom:10px;">‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á</h3><button class="btn btn-primary" onclick="switchTab('apply-service')"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶®</button></div>`}</div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-wallet"></i> ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü`;
}

// ========== USERS ==========
async function showUsers(container) {
    const db = await IslamicBankSystem.load();
    const users = db.users.filter(u => u.type !== 'admin');
    const rows = users.map(u => {
        const apps = db.applications.filter(a => a.userId === u.id && a.status === 'approved').length;
        const total = db.applications.filter(a => a.userId === u.id && a.status === 'approved').reduce((s,a) => s+a.amount, 0);
        return `<tr>
            <td><div style="display:flex;align-items:center;gap:10px;">
                <div class="user-avatar" style="width:34px;height:34px;font-size:0.9rem;">${u.name.charAt(0)}</div>
                <div><div style="font-weight:600;">${u.name}</div><div style="font-size:0.8rem;color:var(--gray);">${u.nid}</div></div>
            </div></td>
            <td>${u.email}</td>
            <td>${u.phone}</td>
            <td><span class="status-badge status-approved">${getUserTypeText(u.type)}</span></td>
            <td style="text-align:center;">${apps}</td>
            <td style="font-weight:600;color:var(--primary);">‡ß≥${formatMoney(total)}</td>
            <td>${u.joined}</td>
            <td><span class="status-badge ${u.status==='active'?'status-approved':'status-rejected'}">${u.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'}</span></td>
            <td><div class="action-buttons">
                <button class="btn btn-sm btn-info" onclick="viewUserDetails('${u.id}')"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-primary" onclick="activeChatWith='${u.id}';switchTab('chat-admin')"><i class="fas fa-comment"></i></button>
                <button class="btn btn-sm ${u.status==='active'?'btn-warning':'btn-success'}" onclick="toggleUserStatus('${u.id}')"><i class="fas fa-${u.status==='active'?'ban':'check'}"></i></button>
            </div></td>
        </tr>`;
    }).join('');
    container.innerHTML = `
        <div class="table-container">
            <div class="table-header"><h2>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ <span style="font-size:0.85rem;font-weight:400;color:var(--gray);">(${users.length}‡¶ú‡¶®)</span></h2></div>
            <div class="table-responsive"><table><thead><tr><th>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</th><th>‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th><th>‡¶´‡ßã‡¶®</th><th>‡¶ß‡¶∞‡¶®</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</th><th>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</th><th>‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th><th>‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th></tr></thead>
            <tbody>${rows||`<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡ßá‡¶á</td></tr>`}</tbody></table></div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-users"></i> ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ`;
}

async function toggleUserStatus(userId) {
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === userId);
    if (!user) return;
    user.status = user.status === 'active' ? 'suspended' : 'active';
    await IslamicBankSystem.save(db);
    showToast(`‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ${user.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
    showUsers(document.getElementById('content-area'));
}

async function viewUserDetails(userId) {
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === userId);
    if (!user) return;
    const userApps = db.applications.filter(a => a.userId === userId);
    document.getElementById('modal-title').textContent = '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
    document.getElementById('modal-body').innerHTML = `
        <div class="profile-header">
            <div class="profile-avatar">${user.name.charAt(0)}</div>
            <div><h3 style="margin-bottom:4px;">${user.name}</h3><div style="opacity:0.85;">${getUserTypeText(user.type)} ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</div></div>
        </div>
        <div class="info-grid" style="margin-bottom:20px;">
            <div class="info-item"><div class="info-label">NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div><div class="info-value">${user.nid}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</div><div class="info-value">${user.joined}</div></div>
            <div class="info-item"><div class="info-label">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</div><div class="info-value">${user.email}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</div><div class="info-value">${user.phone}</div></div>
            <div class="info-item"><div class="info-label">‡¶™‡ßá‡¶∂‡¶æ</div><div class="info-value">${user.occupation||'-'}</div></div>
            <div class="info-item"><div class="info-label">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</div><div class="info-value">‡ß≥${formatMoney(user.monthlyIncome)}</div></div>
            <div class="info-item"><div class="info-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div><div class="info-value" style="color:var(--primary);font-size:1.1rem;">‡ß≥${formatMoney(user.balance)}</div></div>
            <div class="info-item"><div class="info-label">‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</div><div class="info-value"><span class="status-badge ${user.status==='active'?'status-approved':'status-rejected'}">${user.status==='active'?'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º':'‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§'}</span></div></div>
        </div>
        <div style="margin-bottom:18px;"><div class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</div><div class="info-value">${user.address}</div></div>
        <h4 style="color:var(--primary-dark);margin-bottom:12px;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π (${userApps.length}‡¶ü‡¶ø)</h4>
        ${userApps.map(a => `<div style="background:#f8f9fa;border-radius:var(--radius-sm);padding:11px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:600;">${a.serviceName}</div><div style="font-size:0.83rem;color:var(--gray);">‡ß≥${formatMoney(a.amount)} ‚Ä¢ ${a.duration}</div></div><span class="status-badge status-${a.status}">${{pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',approved:'‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',rejected:'‡¶¨‡¶æ‡¶§‡¶ø‡¶≤'}[a.status]||a.status}</span></div>`).join('')||'<div style="color:var(--gray);padding:10px;">‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</div>'}`;
    document.getElementById('service-modal').classList.remove('hidden');
}

// ========== TRANSACTIONS ==========
async function showTransactions(container) {
    const db = await IslamicBankSystem.load();
    let txns = currentUser.type === 'admin' ? db.transactions : db.transactions.filter(t => t.userId === currentUser.id);
    txns = txns.slice().reverse();
    const rows = txns.map(t => {
        const u = db.users.find(u => u.id === t.userId);
        return `<tr>
            <td style="font-family:monospace;font-size:0.85rem;">#${t.id}</td>
            ${currentUser.type==='admin'?`<td>${u?.name||'-'}</td>`:''}
            <td>${t.description}</td>
            <td style="color:${t.type==='deposit'?'var(--success)':'var(--danger)'};font-weight:700;">${t.type==='deposit'?'+':'-'}‡ß≥${formatMoney(t.amount)}</td>
            <td>‡ß≥${formatMoney(t.balance)}</td>
            <td style="font-size:0.85rem;">${t.date}</td>
            <td><span class="status-badge ${t.status==='completed'?'status-approved':t.status==='pending'?'status-pending':'status-processing'}">${{completed:'‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®',pending:'‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',processing:'‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ß‡ßÄ‡¶®'}[t.status]||t.status}</span></td>
        </tr>`;
    }).join('');

    const totalDeposit = txns.filter(t=>t.type==='deposit').reduce((s,t)=>s+t.amount,0);
    const totalWithdraw = txns.filter(t=>t.type==='withdrawal').reduce((s,t)=>s+t.amount,0);

    container.innerHTML = `
        <div class="table-container">
            <div class="stats-grid" style="margin-bottom:20px;">
                <div class="stat-card success"><div class="stat-info"><h3>‡ß≥${formatMoney(totalDeposit)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</p></div><div class="stat-icon"><i class="fas fa-arrow-down"></i></div></div>
                <div class="stat-card warning"><div class="stat-info"><h3>‡ß≥${formatMoney(totalWithdraw)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</p></div><div class="stat-icon"><i class="fas fa-arrow-up"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${txns.length}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</p></div><div class="stat-icon"><i class="fas fa-exchange-alt"></i></div></div>
            </div>
            <div class="table-header"><h2>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2></div>
            <div class="table-responsive"><table><thead><tr><th>ID</th>${currentUser.type==='admin'?'<th>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</th>':''}<th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th></tr></thead>
            <tbody>${rows||`<tr><td colspan="${currentUser.type==='admin'?7:6}" style="text-align:center;padding:40px;color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>`}</tbody></table></div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-exchange-alt"></i> ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®`;
}

// ========== REPORTS ==========
async function showReports(container) {
    const db = await IslamicBankSystem.load();
    const totalUsers = db.users.filter(u=>u.type!=='admin').length;
    const totalApps = db.applications.length;
    const approvedApps = db.applications.filter(a=>a.status==='approved').length;
    const rejectedApps = db.applications.filter(a=>a.status==='rejected').length;
    const totalDeposit = db.transactions.filter(t=>t.type==='deposit').reduce((s,t)=>s+t.amount,0);
    const typeCount = {};
    db.applications.forEach(a => { typeCount[a.serviceName] = (typeCount[a.serviceName]||0)+1; });
    const maxCount = Math.max(...Object.values(typeCount), 1);

    container.innerHTML = `
        <div class="dashboard-content">
            <h2 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-chart-bar"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h2>
            <div class="stats-grid" style="margin-bottom:25px;">
                <div class="stat-card"><div class="stat-info"><h3>${totalUsers}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</p></div><div class="stat-icon"><i class="fas fa-users"></i></div></div>
                <div class="stat-card success"><div class="stat-info"><h3>‡ß≥${formatMoney(totalDeposit)}</h3><p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Æ‡¶æ‡¶®‡¶§</p></div><div class="stat-icon"><i class="fas fa-wallet"></i></div></div>
                <div class="stat-card warning"><div class="stat-info"><h3>${approvedApps}/${totalApps}</h3><p>‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞</p></div><div class="stat-icon"><i class="fas fa-chart-pie"></i></div></div>
                <div class="stat-card info"><div class="stat-info"><h3>${db.services.length}</h3><p>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡ßá‡¶¨‡¶æ</p></div><div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:18px;"><i class="fas fa-chart-pie"></i> ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶§‡¶∞‡¶£</h4>
                    <div>
                        ${[['‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§',approvedApps,totalApps,'success'],['‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®',db.applications.filter(a=>a.status==='pending').length,totalApps,'warning'],['‡¶¨‡¶æ‡¶§‡¶ø‡¶≤',rejectedApps,totalApps,'danger']].map(([l,v,t,c]) => `
                        <div style="margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.88rem;"><span>${l}</span><span style="color:var(--${c});font-weight:700;">${v} (${t?Math.round(v/t*100):0}%)</span></div>
                            <div class="progress-bar"><div style="height:100%;width:${t?v/t*100:0}%;background:var(--${c});border-radius:12px;transition:width 1s;"></div></div>
                        </div>`).join('')}
                    </div>
                </div>
                <div class="card" style="cursor:default;">
                    <h4 style="color:var(--primary-dark);margin-bottom:18px;"><i class="fas fa-list-ol"></i> ‡¶∏‡ßá‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®</h4>
                    ${Object.entries(typeCount).slice(0,6).map(([n,c]) => `
                        <div style="margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:4px;"><span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;">${n}</span><span style="font-weight:700;color:var(--primary);">${c}</span></div>
                            <div class="progress-bar"><div class="chart-bar" style="width:${Math.round(c/maxCount*100)}%;"></div></div>
                        </div>`).join('')||'<p style="color:var(--gray);">‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</p>'}
                </div>
            </div>
        </div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-chart-bar"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`;
}

// ========== PROFILE ==========
async function showProfile(container) {
    const db = await IslamicBankSystem.load();
    const me = db.users.find(u => u.id === currentUser.id);
    if (!me) return;
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:700px;margin:0 auto;">
            <div class="profile-header">
                <div class="profile-avatar">${me.name.charAt(0)}</div>
                <div><h2 style="margin-bottom:4px;">${me.name}</h2><div style="opacity:0.85;">${getUserTypeText(me.type)} ‚Ä¢ ${me.joined}</div><div style="margin-top:10px;"><span class="sharia-badge"><i class="fas fa-check"></i> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡ßÉ‡¶§ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</span></div></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-user"></i> ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø</h4>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">NID ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div><div class="info-value">${me.nid}</div></div>
                    <div class="info-item"><div class="info-label">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</div><div class="info-value">${me.email}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</div><div class="info-value">${me.phone}</div></div>
                    <div class="info-item"><div class="info-label">‡¶™‡ßá‡¶∂‡¶æ</div><div class="info-value">${me.occupation||'-'}</div></div>
                    <div class="info-item"><div class="info-label">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</div><div class="info-value">‡ß≥${formatMoney(me.monthlyIncome)}</div></div>
                    <div class="info-item"><div class="info-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div><div class="info-value" style="color:var(--primary);font-size:1.1rem;">‡ß≥${formatMoney(me.balance)}</div></div>
                </div>
                <div class="info-item" style="margin-top:12px;"><div class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</div><div class="info-value">${me.address}</div></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-edit"></i> ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                <div class="form-row">
                    <div class="form-group"><label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</label><input type="tel" id="edit-phone" class="form-control" value="${me.phone}"></div>
                    <div class="form-group"><label>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º</label><input type="number" id="edit-income" class="form-control" value="${me.monthlyIncome}"></div>
                </div>
                <div class="form-group"><label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><textarea id="edit-address" class="form-control" rows="2">${me.address}</textarea></div>
                <button class="btn btn-primary" onclick="updateProfile()"><i class="fas fa-save"></i> ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div class="card" style="cursor:default;">
                <h4 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-lock"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h4>
                <div class="form-group"><label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="current-password" class="form-control"></div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label><input type="password" id="new-password" class="form-control"></div>
                    <div class="form-group"><label>‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label><input type="password" id="confirm-new-password" class="form-control"></div>
                </div>
                <button class="btn btn-warning" onclick="updatePassword()"><i class="fas fa-key"></i> ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-user"></i> ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤`;
}

async function updateProfile() {
    const phone = document.getElementById('edit-phone').value.trim();
    const income = parseInt(document.getElementById('edit-income').value) || 0;
    const address = document.getElementById('edit-address').value.trim();
    if (!phone || !address) { showToast('‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === currentUser.id);
    if (user) { user.phone = phone; user.monthlyIncome = income; user.address = address; }
    await IslamicBankSystem.save(db);
    currentUser.phone = phone;
    showToast('‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

async function updatePassword() {
    const cur = document.getElementById('current-password').value;
    const nw = document.getElementById('new-password').value;
    const cfm = document.getElementById('confirm-new-password').value;
    if (cur !== currentUser.password) { showToast('‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º', 'error'); return; }
    if (nw !== cfm) { showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ', 'error'); return; }
    if (nw.length < 8) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßÆ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error'); return; }
    const db = await IslamicBankSystem.load();
    const user = db.users.find(u => u.id === currentUser.id);
    if (user) { user.password = nw; }
    await IslamicBankSystem.save(db);
    currentUser.password = nw;
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-new-password').value = '';
    showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

// ========== SETTINGS ==========
async function showSettings(container) {
    const db = await IslamicBankSystem.load();
    const s = db.settings;
    container.innerHTML = `
        <div class="dashboard-content"><div style="max-width:750px;margin:0 auto;">
            <h2 style="color:var(--primary-dark);margin-bottom:22px;"><i class="fas fa-cog"></i> ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-building"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h3>
                <div class="form-group"><label>‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label><input type="text" id="bank-name" class="form-control" value="${s.bankName}"></div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label><input type="email" id="support-email" class="form-control" value="${s.supportEmail}"></div>
                    <div class="form-group"><label>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="contact-number" class="form-control" value="${s.contactNumber}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º</label><input type="text" id="working-hours" class="form-control" value="${s.workingHours}"></div>
                    <div class="form-group"><label>‡¶®‡¶æ‡¶Æ‡¶æ‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø</label><input type="text" id="prayer-break" class="form-control" value="${s.prayerBreak}"></div>
                </div>
                <div class="form-group"><label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</label><textarea id="bank-address" class="form-control" rows="2">${s.address}</textarea></div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-shield-alt"></i> ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                <div class="form-row">
                    <div class="form-group"><label>‡¶∏‡ßá‡¶∂‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)</label><input type="number" id="session-timeout" class="form-control" value="${s.sessionTimeout||30}" min="5" max="120"></div>
                    <div class="form-group"><label>‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ</label><input type="number" id="max-login" class="form-control" value="${s.maxLoginAttempts||5}" min="1" max="10"></div>
                </div>
                <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">
                    ${[['enable-captcha','‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶ö‡¶æ ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ',s.enableCaptcha!==false],['enable-2fa','‡ß®-‡¶´‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶∞ ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶®',s.enable2FA||false],['enable-logging','‡¶≤‡¶ó‡¶ø‡¶Ç ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ',s.enableLogging!==false]].map(([id,label,checked]) => `
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;background:#f8f9fa;border-radius:var(--radius-sm);">
                        <input type="checkbox" id="${id}" ${checked?'checked':''} style="width:16px;height:16px;">
                        <span>${label}</span>
                    </label>`).join('')}
                </div>
            </div>
            <div class="card" style="cursor:default;margin-bottom:20px;">
                <h3 style="color:var(--primary-dark);margin-bottom:18px;border-bottom:2px solid var(--primary-light);padding-bottom:10px;"><i class="fas fa-database"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <button class="btn btn-info" onclick="exportData()"><i class="fas fa-download"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
                    <button class="btn btn-danger" onclick="clearOldData()"><i class="fas fa-trash"></i> ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                </div>
            </div>
            <div style="text-align:center;margin-top:15px;">
                <button class="btn btn-primary btn-lg" onclick="saveSettings()"><i class="fas fa-save"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div style="text-align:center;margin-top:15px;">
                <button class="btn btn-secondary" onclick="showJsonBinSettings()"><i class="fas fa-cloud-upload-alt"></i> JSONBin.io ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
            </div>
        </div></div>`;
    document.getElementById('page-title').innerHTML = `<i class="fas fa-cog"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏`;
}

async function saveSettings() {
    const db = await IslamicBankSystem.load();
    db.settings.bankName = document.getElementById('bank-name').value;
    db.settings.supportEmail = document.getElementById('support-email').value;
    db.settings.contactNumber = document.getElementById('contact-number').value;
    db.settings.workingHours = document.getElementById('working-hours').value;
    db.settings.prayerBreak = document.getElementById('prayer-break').value;
    db.settings.address = document.getElementById('bank-address').value;
    db.settings.sessionTimeout = parseInt(document.getElementById('session-timeout').value) || 30;
    db.settings.maxLoginAttempts = parseInt(document.getElementById('max-login').value) || 5;
    db.settings.enableCaptcha = document.getElementById('enable-captcha').checked;
    db.settings.enable2FA = document.getElementById('enable-2fa').checked;
    db.settings.enableLogging = document.getElementById('enable-logging').checked;
    await IslamicBankSystem.save(db);
    showToast('‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

function exportData() {
    if (!dbCache) return;
    const json = JSON.stringify(dbCache, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `nur_bank_backup_${Date.now()}.json`;
    a.click(); URL.revokeObjectURL(url);
    showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤', 'success');
}

async function clearOldData() {
    if (!confirm('‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶° ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) return;
    const db = await IslamicBankSystem.load();
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
    db.notifications = db.notifications.filter(n => !n.read || n.id > thirtyDaysAgo);
    db.messages = db.messages.filter(m => !m.read || m.id > thirtyDaysAgo);
    await IslamicBankSystem.save(db);
    showToast('‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
}

// ========== NOTIFICATIONS ==========
function toggleNotifications() {
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('show');
    if (panel.classList.contains('show')) loadNotifications();
}

async function loadNotifications() {
    const db = await IslamicBankSystem.load();
    const notifs = db.notifications.filter(n => n.userId === currentUser.id).sort((a,b) => b.id - a.id);
    const icons = { application:'fas fa-file-alt', message:'fas fa-comment', success:'fas fa-check-circle', error:'fas fa-exclamation-circle', registration:'fas fa-user-plus', info:'fas fa-info-circle' };
    const colors = { application:'var(--info)', message:'var(--success)', success:'var(--success)', error:'var(--danger)', registration:'var(--secondary)', info:'var(--primary)' };
    document.getElementById('notifications-list').innerHTML = notifs.length ? notifs.map(n => `
        <div class="notification-item ${n.read?'':'unread'}" onclick="openNotification(${n.id})">
            ${!n.read?'<div class="notification-dot"></div>':''}
            <div style="color:${colors[n.type]||'var(--primary)'};font-size:1.1rem;margin-top:2px;"><i class="${icons[n.type]||'fas fa-bell'}"></i></div>
            <div class="notification-content">
                <div class="notification-title">${n.title}</div>
                <div class="notification-message">${n.message}</div>
                <div class="notification-time">${n.timestamp}</div>
            </div>
        </div>`).join('') : '<div style="padding:35px;text-align:center;color:var(--gray);"><i class="fas fa-bell-slash" style="font-size:2rem;opacity:0.4;display:block;margin-bottom:10px;"></i>‡¶ï‡ßã‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</div>';
}

async function openNotification(notifId) {
    const db = await IslamicBankSystem.load();
    const notif = db.notifications.find(n => n.id == notifId);
    if (notif) {
        notif.read = true;
        await IslamicBankSystem.save(db);
        document.getElementById('notifications-panel').classList.remove('show');
        updateNotificationCount();
        if (notif.type === 'application') switchTab(currentUser.type==='admin'?'applications':'my-applications');
        else if (notif.type === 'message') switchTab(currentUser.type==='admin'?'chat-admin':'chat-user');
    }
}

async function markAllNotificationsRead() {
    const db = await IslamicBankSystem.load();
    db.notifications.filter(n => n.userId === currentUser.id).forEach(n => n.read = true);
    await IslamicBankSystem.save(db);
    updateNotificationCount();
    loadNotifications();
}

async function updateNotificationCount() {
    if (!currentUser) return;
    const db = await IslamicBankSystem.load();
    const count = db.notifications.filter(n => n.userId === currentUser.id && !n.read).length;
    const badge = document.getElementById('notification-badge');
    if (badge) { badge.textContent = count; count > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden'); }
}

// ========== CALCULATOR ==========
function calculateProfit() {
    const amount = parseFloat(document.getElementById('calc-amount').value);
    const rate = parseFloat(document.getElementById('calc-rate').value) / 100;
    const years = parseFloat(document.getElementById('calc-years').value);
    const type = document.getElementById('calc-type').value;
    const res = document.getElementById('calc-result');
    if (!amount || !rate || !years) { res.style.display = 'none'; return; }
    let total, profit;
    if (type === 'simple') { profit = amount * rate * years; total = amount + profit; }
    else { total = amount * Math.pow(1 + rate, years); profit = total - amount; }
    document.getElementById('calc-principal').textContent = '‡ß≥' + formatMoney(Math.round(amount));
    document.getElementById('calc-profit').textContent = '‡ß≥' + formatMoney(Math.round(profit));
    document.getElementById('calc-total').textContent = '‡ß≥' + formatMoney(Math.round(total));
    res.style.display = 'block';
}

// ========== MISC ==========
function closeModal() { document.getElementById('service-modal').classList.add('hidden'); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// ========== PWA INSTALL ==========
var deferredPrompt;
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    showInstallBanner();
});

function showInstallBanner() {
    if (document.getElementById('pwa-banner')) return;
    if (window.matchMedia('(display-mode: standalone)').matches) return;
    
    var banner = document.createElement('div');
    banner.id = 'pwa-banner';
    banner.innerHTML = '<span style="font-size:1.3rem">üì±</span><span style="font-size:0.9rem;font-weight:600">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</span><button onclick="installApp()" style="background:#d4af37;color:#333;border:none;padding:7px 16px;border-radius:25px;font-weight:700;cursor:pointer;font-size:0.85rem;margin-left:5px;">‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤</button><button onclick="document.getElementById(\'pwa-banner\').remove()" style="background:transparent;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:1.1rem;padding:0 4px;">‚úï</button>';
    
    document.body.appendChild(banner);
    setTimeout(function() { var b=document.getElementById('pwa-banner'); if(b) b.remove(); }, 10000);
}

async function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
    } else {
        alert('‡¶π‡ßã‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:\n\n1. Chrome ‡¶Æ‡ßá‡¶®‡ßÅ (‚ãÆ) ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®\n2. "Add to Home screen" ‡¶¨‡¶æ "‡¶π‡ßã‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®\n3. "Add" ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®\n\n‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶π‡ßã‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!');
    }
    var b = document.getElementById('pwa-banner');
    if (b) b.remove();
}

// Prevent zoom on double tap (app-like)
var lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
}, false);

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', async () => {
    generateCaptcha();

    // Load JSONBin config first
    await loadJsonBinConfig();
    
    // Load DB
    await IslamicBankSystem.load();

    // Check session
    const savedUser = sessionStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const u = JSON.parse(savedUser);
            // Re-verify user still exists
            const dbUser = IslamicBankSystem.findUser(u.id);
            if (dbUser && dbUser.status !== 'suspended') {
                currentUser = {...dbUser};
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        } catch(e) { sessionStorage.removeItem('currentUser'); }
    }

    // Hide loading, show app
    setTimeout(() => {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.transition = 'opacity 0.5s';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.classList.add('hidden');
            if (currentUser) {
                loadDashboard();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
            }
        }, 500);
    }, 1800);

    // Outside click handlers
    document.addEventListener('click', e => {
        const panel = document.getElementById('notifications-panel');
        const btn = document.querySelector('.notification-btn');
        if (panel && panel.classList.contains('show') && !panel.contains(e.target) && btn && !btn.contains(e.target))
            panel.classList.remove('show');
        const sidebar = document.getElementById('sidebar');
        const mobileBtn = document.querySelector('.mobile-menu-btn');
        if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target) && mobileBtn && !mobileBtn.contains(e.target))
            sidebar.classList.remove('open');
    });

    // Show install banner after 3 seconds
    setTimeout(function() {
        if (!window.matchMedia('(display-mode: standalone)').matches) {
            showInstallBanner();
        }
    }, 3000);
});

// Override window.storage to use localStorage (guaranteed to work offline)
if (!window.storage) {
    window.storage = {
        get: function(key, shared) {
            return new Promise(function(resolve, reject) {
                try {
                    var val = localStorage.getItem(key);
                    if (val !== null) {
                        resolve({key: key, value: val, shared: !!shared});
                    } else {
                        reject(new Error('Key not found: ' + key));
                    }
                } catch(e) { reject(e); }
            });
        },
        set: function(key, value, shared) {
            return new Promise(function(resolve, reject) {
                try {
                    localStorage.setItem(key, value);
                    resolve({key: key, value: value, shared: !!shared});
                } catch(e) { reject(e); }
            });
        }
    };
}
</script>

</body>
</html>
